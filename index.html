<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rapor Salsabila Klaseman</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-size: 14px;
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
        }

        .sidebar-brand {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        /* Main Content */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e3e6f0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #d1d3e2;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-block;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2e59d9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #17a673;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #dda20a;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #2c9faf;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e3e6f0;
        }

        .table th {
            background-color: #f8f9fc;
            font-weight: 600;
            color: var(--primary-color);
            border-top: none;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e3e6f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e3e6f0;
            display: flex;
            justify-content: flex-end;
        }

        /* Rapor */
        .rapor {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
        }

        .rapor-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .rapor-logo {
            position: absolute;
            top: 0;
            left: 0;
            width: 80px;
            height: 80px;
        }

        .rapor-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rapor-subtitle {
            font-size: 18px;
            color: var(--secondary-color);
        }

        .rapor-info {
            margin-bottom: 20px;
        }

        .rapor-info p {
            margin-bottom: 5px;
        }

        .rapor-section {
            margin-bottom: 20px;
        }

        .rapor-section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .rapor-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .rapor-table th, .rapor-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .rapor-table th {
            background-color: #f2f2f2;
        }

        .rapor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .rapor-signature-box {
            text-align: center;
            width: 45%;
        }

        .rapor-signature-line {
            height: 1px;
            background-color: black;
            margin: 40px 0 5px;
        }

        /* Subject Cards */
        .subject-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .subject-icon {
            font-size: 24px;
            color: var(--primary-color);
        }

        .subject-progress {
            margin-top: 10px;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .content {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .close-alert {
            float: right;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Login Form */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 30px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .role-selector {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .role-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 1px solid #d1d3e2;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Template Download */
        .template-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .template-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .template-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .template-description {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        /* Progress Monitoring */
        .progress-item {
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-title {
            font-weight: 600;
        }

        .progress-percentage {
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Memproses data...</p>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-title">E-Rapor Salsabila Klaseman</div>
                <p>Silakan login untuk melanjutkan</p>
            </div>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                </div>
                <div class="form-group">
                    <label>Pilih Role</label>
                    <div class="role-selector">
                        <div class="role-option active" data-role="admin">Admin</div>
                        <div class="role-option" data-role="guru">Guru Kelas</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="kelas">Kelas (untuk Guru)</label>
                    <select id="kelas" class="form-control">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="1">Kelas 1</option>
                        <option value="2">Kelas 2</option>
                        <option value="3">Kelas 3</option>
                        <option value="4">Kelas 4</option>
                        <option value="5">Kelas 5</option>
                        <option value="6">Kelas 6</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="wrapper" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-graduation-cap"></i> E-Rapor Salsabila
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </div>
                <div class="sidebar-item" onclick="showSection('subjects')" id="subjectsMenu" style="display: none;">
                    <i class="fas fa-book"></i> Mata Pelajaran
                </div>
                <div class="sidebar-item" onclick="showSection('students')" id="studentsMenu" style="display: none;">
                    <i class="fas fa-users"></i> Data Siswa
                </div>
                <div class="sidebar-item" onclick="showSection('assessment')" id="assessmentMenu">
                    <i class="fas fa-clipboard-list"></i> Penilaian PTS
                </div>
                <div class="sidebar-item" onclick="showSection('rapor')" id="raporMenu">
                    <i class="fas fa-file-alt"></i> Cetak Rapor
                </div>
                <div class="sidebar-item" onclick="showSection('monitoring')" id="monitoringMenu" style="display: none;">
                    <i class="fas fa-chart-line"></i> Monitoring
                </div>
                <div class="sidebar-item" onclick="showSection('settings')" id="settingsMenu" style="display: none;">
                    <i class="fas fa-cog"></i> Pengaturan
                </div>
                <div class="sidebar-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="content-header">
                <h1 class="content-title">Dashboard</h1>
                <div class="user-info">
                    <span id="userInfo">Admin</span>
                    <img src="https://i.imgur.com/0DQ3Q4V.jpg" alt="User">
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Siswa</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSiswa">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-users fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mata Pelajaran</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMapel">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-book fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Penilaian Selesai</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPenilaian">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Progress</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="progressPercentage">0%</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subject Cards -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Mata Pelajaran</h6>
                    </div>
                    <div class="card-body">
                        <div id="subjectCards">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk menginput nilai PTS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subjects Section (Admin Only) -->
            <div id="subjects-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Manajemen Mata Pelajaran</h6>
                        <button class="btn btn-primary btn-sm" onclick="tambahMapel()">
                            <i class="fas fa-plus"></i> Tambah Mata Pelajaran
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Kode</th>
                                        <th>Nama Mata Pelajaran</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelMapel">
                                    <tr>
                                        <td colspan="4" class="text-center">Tidak ada data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section (Admin Only) -->
            <div id="students-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Manajemen Data Siswa</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importSiswa" onchange="importSiswaFromExcel(event)" style="display: none;">
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="filterKelasSiswa">Filter Kelas</label>
                            <select id="filterKelasSiswa" class="form-control" onchange="filterSiswa()">
                                <option value="">-- Semua Kelas --</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelSiswa">
                                    <tr>
                                        <td colspan="4" class="text-center">Tidak ada data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Section -->
            <div id="assessment-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Penilaian PTS</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplatePTS()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importPTS" onchange="importPTSFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="exportPTSToExcel()">
                                <i class="fas fa-file-export"></i> Export ke Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihMapelPTS">Pilih Mata Pelajaran</label>
                            <select id="pilihMapelPTS" class="form-control" onchange="tampilkanPTS()">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                        <div id="PTSContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Card Section -->
            <div id="rapor-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Cetak Rapor</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihSiswaRapor">Pilih Siswa</label>
                            <select id="pilihSiswaRapor" class="form-control" onchange="tampilkanRapor()">
                                <option value="">-- Pilih Siswa --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Cetak Rapor
                        </button>
                    </div>
                </div>
                <div id="raporContainer"></div>
            </div>

            <!-- Monitoring Section (Admin Only) -->
            <div id="monitoring-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Monitoring Pengisian Nilai</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monitoringChart"></canvas>
                        </div>
                        <div id="progressMonitoring">
                            <h6 class="mt-4">Progress per Guru</h6>
                            <div id="progressList">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Loading progress data...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section (Admin Only) -->
            <div id="settings-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Pengaturan</h6>
                    </div>
                    <div class="card-body">
                        <div class="template-card">
                            <div class="template-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="template-title">Logo Sekolah</div>
                            <div class="template-description">Upload logo sekolah untuk ditampilkan di rapor</div>
                            <div id="logoPreview">
                                <img id="logoSekolah" src="" alt="Logo Sekolah" style="max-width: 200px; max-height: 200px; display: none;">
                            </div>
                            <label class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Logo
                                <input type="file" id="uploadLogo" onchange="uploadLogoSekolah(event)" style="display: none;" accept="image/*">
                            </label>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Manajemen Guru</h6>
                                <button class="btn btn-primary btn-sm" onclick="tambahGuru()">
                                    <i class="fas fa-plus"></i> Tambah Guru
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Username</th>
                                                <th>Nama Guru</th>
                                                <th>Kelas</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelGuru">
                                            <tr>
                                                <td colspan="5" class="text-center">Tidak ada data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Subject -->
    <div id="modalMapel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMapelTitle">Tambah Mata Pelajaran</h5>
                <span class="modal-close" onclick="tutupModal('modalMapel')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formMapel">
                    <input type="hidden" id="mapelId">
                    <div class="form-group">
                        <label for="mapelKode">Kode Mata Pelajaran</label>
                        <input type="text" id="mapelKode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="mapelNama">Nama Mata Pelajaran</label>
                        <input type="text" id="mapelNama" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalMapel')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanMapel()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Student -->
    <div id="modalSiswa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSiswaTitle">Tambah Siswa</h5>
                <span class="modal-close" onclick="tutupModal('modalSiswa')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formSiswa">
                    <input type="hidden" id="siswaId">
                    <div class="form-group">
                        <label for="siswaNIS">NIS</label>
                        <input type="text" id="siswaNIS" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="siswaNama">Nama Siswa</label>
                        <input type="text" id="siswaNama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="siswaKelas">Kelas</label>
                        <select id="siswaKelas" class="form-control" required>
                            <option value="">-- Pilih Kelas --</option>
                            <option value="1">Kelas 1</option>
                            <option value="2">Kelas 2</option>
                            <option value="3">Kelas 3</option>
                            <option value="4">Kelas 4</option>
                            <option value="5">Kelas 5</option>
                            <option value="6">Kelas 6</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalSiswa')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanSiswa()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Teacher -->
    <div id="modalGuru" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGuruTitle">Tambah Guru</h5>
                <span class="modal-close" onclick="tutupModal('modalGuru')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formGuru">
                    <input type="hidden" id="guruId">
                    <div class="form-group">
                        <label for="guruUsername">Username</label>
                        <input type="text" id="guruUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruPassword">Password</label>
                        <input type="password" id="guruPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruNama">Nama Guru</label>
                        <input type="text" id="guruNama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruKelas">Kelas</label>
                        <select id="guruKelas" class="form-control" required>
                            <option value="">-- Pilih Kelas --</option>
                            <option value="1">Kelas 1</option>
                            <option value="2">Kelas 2</option>
                            <option value="3">Kelas 3</option>
                            <option value="4">Kelas 4</option>
                            <option value="5">Kelas 5</option>
                            <option value="6">Kelas 6</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalGuru')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanGuru()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal PTS Input -->
    <div id="modalPTS" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h5 class="modal-title">Input Nilai PTS</h5>
                <span class="modal-close" onclick="tutupModal('modalPTS')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ptsMapel">Mata Pelajaran</label>
                    <input type="text" id="ptsMapel" class="form-control" readonly>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NIS</th>
                                <th>Nama Siswa</th>
                                <th>Nilai PTS</th>
                                <th>Predikat</th>
                            </tr>
                        </thead>
                        <tbody id="tabelPTS">
                            <tr>
                                <td colspan="4" class="text-center">Tidak ada data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalPTS')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanPTS()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQQcgPoQMIeCn3tSkn7NAks2cRFTV8Df4",
            authDomain: "e-rapor-salsabila-klaseman.firebaseapp.com",
            databaseURL: "https://e-rapor-salsabila-klaseman-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-rapor-salsabila-klaseman",
            storageBucket: "e-rapor-salsabila-klaseman.firebasestorage.app",
            messagingSenderId: "519176085482",
            appId: "1:519176085482:web:66dc1c0e4264a8af911c93",
            measurementId: "G-XJTP2RYMMC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let userRole = null;
        let userKelas = null;
        let mapelData = [];
        let siswaData = [];
        let guruData = [];
        let ptsData = [];
        let logoSekolahURL = "";
        let monitoringChart = null;

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                ${message}
                <span class="close-alert" onclick="this.parentElement.remove()">&times;</span>
            `;
            document.querySelector('.content-header').after(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Role selection
        document.querySelectorAll('.role-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        // Login form submission
        document.getElementById('loginFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.querySelector('.role-option.active').dataset.role;
            const kelas = document.getElementById('kelas').value;
            
            // Simple validation (in real app, this should be done against a database)
            if (username && password) {
                if (role === 'admin') {
                    // Admin login
                    if (username === 'admin' && password === 'admin') {
                        currentUser = { username: username, role: role };
                        userRole = role;
                        showMainApp();
                        loadAdminData();
                    } else {
                        showAlert('Username atau password salah!', 'danger');
                    }
                } else {
                    // Teacher login
                    if (kelas) {
                        // Check if teacher exists in database
                        checkTeacherLogin(username, password, kelas);
                    } else {
                        showAlert('Silakan pilih kelas!', 'warning');
                    }
                }
            } else {
                showAlert('Username dan password tidak boleh kosong!', 'warning');
            }
        });

        // Check teacher login against database
        function checkTeacherLogin(username, password, kelas) {
            showLoading();
            
            database.ref('guru').orderByChild('username').equalTo(username).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const teacherData = snapshot.val();
                        const teacherKey = Object.keys(teacherData)[0];
                        const teacher = teacherData[teacherKey];
                        
                        if (teacher.password === password && teacher.kelas === kelas) {
                            currentUser = {
                                id: teacherKey,
                                username: teacher.username,
                                nama: teacher.nama,
                                kelas: teacher.kelas,
                                role: 'guru'
                            };
                            userRole = 'guru';
                            userKelas = kelas;
                            showMainApp();
                            loadTeacherData();
                        } else {
                            showAlert('Password atau kelas salah!', 'danger');
                        }
                    } else {
                        showAlert('Username tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            // Update user info
            if (userRole === 'admin') {
                document.getElementById('userInfo').textContent = 'Admin';
                document.getElementById('subjectsMenu').style.display = 'block';
                document.getElementById('studentsMenu').style.display = 'block';
                document.getElementById('monitoringMenu').style.display = 'block';
                document.getElementById('settingsMenu').style.display = 'block';
            } else {
                document.getElementById('userInfo').textContent = currentUser.nama;
                document.getElementById('subjectsMenu').style.display = 'none';
                document.getElementById('studentsMenu').style.display = 'none';
                document.getElementById('monitoringMenu').style.display = 'none';
                document.getElementById('settingsMenu').style.display = 'none';
            }
            
            // Load data based on role
            if (userRole === 'admin') {
                loadMapelData();
                loadSiswaData();
                loadGuruData();
                loadLogoSekolah();
            } else {
                loadMapelData();
                loadSiswaByKelas(userKelas);
                loadPTSData();
            }
        }

        // Load admin data
        function loadAdminData() {
            updateDashboard();
            loadSubjectCards();
        }

        // Load teacher data
        function loadTeacherData() {
            updateDashboard();
            loadSubjectCards();
            loadPTSData();
        }

        // Update dashboard statistics
        function updateDashboard() {
            if (userRole === 'admin') {
                // Admin dashboard
                document.getElementById('totalSiswa').textContent = siswaData.length;
                document.getElementById('totalMapel').textContent = mapelData.length;
                
                // Calculate completed assessments
                let totalPTS = 0;
                let completedPTS = 0;
                
                mapelData.forEach(mapel => {
                    database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const ptsCount = Object.keys(snapshot.val()).length;
                            totalPTS += siswaData.length;
                            completedPTS += ptsCount;
                        } else {
                            totalPTS += siswaData.length;
                        }
                        
                        // Update progress percentage
                        const progressPercentage = totalPTS > 0 ? Math.round((completedPTS / totalPTS) * 100) : 0;
                        document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                        document.getElementById('totalPenilaian').textContent = completedPTS;
                    });
                });
            } else {
                // Teacher dashboard
                const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                document.getElementById('totalSiswa').textContent = siswaKelas.length;
                document.getElementById('totalMapel').textContent = mapelData.length;
                
                // Calculate completed assessments for this teacher
                let totalPTS = 0;
                let completedPTS = 0;
                
                mapelData.forEach(mapel => {
                    database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const ptsData = snapshot.val();
                            const ptsCount = Object.values(ptsData).filter(pts => {
                                const siswa = siswaKelas.find(s => s.nis === pts.nis);
                                return siswa !== undefined;
                            }).length;
                            totalPTS += siswaKelas.length;
                            completedPTS += ptsCount;
                        } else {
                            totalPTS += siswaKelas.length;
                        }
                        
                        // Update progress percentage
                        const progressPercentage = totalPTS > 0 ? Math.round((completedPTS / totalPTS) * 100) : 0;
                        document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                        document.getElementById('totalPenilaian').textContent = completedPTS;
                    });
                });
            }
        }

        // Load subject cards for dashboard
        function loadSubjectCards() {
            const container = document.getElementById('subjectCards');
            container.innerHTML = '';
            
            if (mapelData.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada mata pelajaran tersedia.</div>';
                return;
            }
            
            mapelData.forEach(mapel => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.onclick = () => openSubjectDashboard(mapel);
                
                // Calculate progress for this subject
                let progress = 0;
                let totalStudents = 0;
                
                if (userRole === 'admin') {
                    totalStudents = siswaData.length;
                } else {
                    totalStudents = siswaData.filter(siswa => siswa.kelas === userKelas).length;
                }
                
                database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        let completedCount = 0;
                        
                        if (userRole === 'admin') {
                            completedCount = Object.keys(ptsData).length;
                        } else {
                            // For teachers, only count students in their class
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            completedCount = Object.values(ptsData).filter(pts => {
                                return siswaKelas.some(siswa => siswa.nis === pts.nis);
                            }).length;
                        }
                        
                        progress = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                    }
                    
                    card.innerHTML = `
                        <div class="subject-header">
                            <div class="subject-title">${mapel.nama}</div>
                            <div class="subject-icon">
                                <i class="fas fa-book"></i>
                            </div>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-header">
                                <div class="progress-title">Progress</div>
                                <div class="progress-percentage">${progress}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                });
                
                container.appendChild(card);
            });
        }

        // Open subject dashboard
        function openSubjectDashboard(mapel) {
            // Set the selected subject in the dropdown
            document.getElementById('pilihMapelPTS').value = mapel.id;
            
            // Switch to assessment section
            showSection('assessment');
            
            // Load PTS data for this subject
            tampilkanPTS();
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId + '-section').style.display = 'block';
            
            // Update active sidebar item
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content title
            const titles = {
                'dashboard': 'Dashboard',
                'subjects': 'Manajemen Mata Pelajaran',
                'students': 'Manajemen Data Siswa',
                'assessment': 'Penilaian PTS',
                'rapor': 'Cetak Rapor',
                'monitoring': 'Monitoring Pengisian Nilai',
                'settings': 'Pengaturan'
            };
            document.querySelector('.content-title').textContent = titles[sectionId];
            
            // Load section-specific data
            if (sectionId === 'monitoring' && userRole === 'admin') {
                loadMonitoringData();
            }
        }

        // Logout
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                currentUser = null;
                userRole = null;
                userKelas = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                
                // Reset form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('kelas').value = '';
                
                // Reset role selection
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector('.role-option[data-role="admin"]').classList.add('active');
            }
        }

        // Load subjects data
        function loadMapelData() {
            showLoading();
            
            database.ref('mapel').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        mapelData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        mapelData = [];
                    }
                    
                    // Update subject dropdowns
                    updateSubjectDropdowns();
                    
                    // Update subject cards if on dashboard
                    if (document.getElementById('dashboard-section').style.display !== 'none') {
                        loadSubjectCards();
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update subject dropdowns
        function updateSubjectDropdowns() {
            const dropdowns = [
                document.getElementById('pilihMapelPTS')
            ];
            
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
                    
                    mapelData.forEach(mapel => {
                        const option = document.createElement('option');
                        option.value = mapel.id;
                        option.textContent = mapel.nama;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        // Add/Edit subject
        function tambahMapel() {
            document.getElementById('modalMapelTitle').textContent = 'Tambah Mata Pelajaran';
            document.getElementById('mapelId').value = '';
            document.getElementById('mapelKode').value = '';
            document.getElementById('mapelNama').value = '';
            document.getElementById('modalMapel').style.display = 'block';
        }

        function editMapel(id) {
            const mapel = mapelData.find(m => m.id === id);
            if (mapel) {
                document.getElementById('modalMapelTitle').textContent = 'Edit Mata Pelajaran';
                document.getElementById('mapelId').value = mapel.id;
                document.getElementById('mapelKode').value = mapel.kode;
                document.getElementById('mapelNama').value = mapel.nama;
                document.getElementById('modalMapel').style.display = 'block';
            }
        }

        function simpanMapel() {
            const id = document.getElementById('mapelId').value;
            const kode = document.getElementById('mapelKode').value;
            const nama = document.getElementById('mapelNama').value;
            
            if (kode && nama) {
                showLoading();
                
                const mapelData = {
                    kode: kode,
                    nama: nama
                };
                
                if (id) {
                    // Update existing subject
                    database.ref('mapel/' + id).update(mapelData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalMapel');
                            loadMapelData();
                            showAlert('Mata pelajaran berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new subject
                    database.ref('mapel').push(mapelData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalMapel');
                            loadMapelData();
                            showAlert('Mata pelajaran berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('Kode dan nama mata pelajaran tidak boleh kosong!', 'warning');
            }
        }

        function hapusMapel(id) {
            if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
                showLoading();
                
                database.ref('mapel/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadMapelData();
                        showAlert('Mata pelajaran berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Load students data
        function loadSiswaData() {
            showLoading();
            
            database.ref('siswa').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        siswaData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        siswaData = [];
                    }
                    
                    // Update student table
                    updateSiswaTable();
                    
                    // Update student dropdowns
                    updateSiswaDropdowns();
                    
                    // Update dashboard
                    updateDashboard();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load students by class
        function loadSiswaByKelas(kelas) {
            showLoading();
            
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        siswaData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        siswaData = [];
                    }
                    
                    // Update student dropdowns
                    updateSiswaDropdowns();
                    
                    // Update dashboard
                    updateDashboard();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update student table
        function updateSiswaTable() {
            const tbody = document.getElementById('tabelSiswa');
            tbody.innerHTML = '';
            
            if (siswaData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            siswaData.forEach(siswa => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${siswa.nis}</td>
                    <td>${siswa.nama}</td>
                    <td>Kelas ${siswa.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editSiswa('${siswa.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusSiswa('${siswa.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Filter students by class
        function filterSiswa() {
            const kelas = document.getElementById('filterKelasSiswa').value;
            
            if (kelas) {
                const filteredData = siswaData.filter(siswa => siswa.kelas === kelas);
                updateFilteredSiswaTable(filteredData);
            } else {
                updateSiswaTable();
            }
        }

        function updateFilteredSiswaTable(filteredData) {
            const tbody = document.getElementById('tabelSiswa');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            filteredData.forEach(siswa => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${siswa.nis}</td>
                    <td>${siswa.nama}</td>
                    <td>Kelas ${siswa.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editSiswa('${siswa.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusSiswa('${siswa.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Update student dropdowns
        function updateSiswaDropdowns() {
            const dropdowns = [
                document.getElementById('pilihSiswaRapor')
            ];
            
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                    
                    siswaData.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.id;
                        option.textContent = `${siswa.nis} - ${siswa.nama} (Kelas ${siswa.kelas})`;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        // Add/Edit student
        function tambahSiswa() {
            document.getElementById('modalSiswaTitle').textContent = 'Tambah Siswa';
            document.getElementById('siswaId').value = '';
            document.getElementById('siswaNIS').value = '';
            document.getElementById('siswaNama').value = '';
            document.getElementById('siswaKelas').value = '';
            document.getElementById('modalSiswa').style.display = 'block';
        }

        function editSiswa(id) {
            const siswa = siswaData.find(s => s.id === id);
            if (siswa) {
                document.getElementById('modalSiswaTitle').textContent = 'Edit Siswa';
                document.getElementById('siswaId').value = siswa.id;
                document.getElementById('siswaNIS').value = siswa.nis;
                document.getElementById('siswaNama').value = siswa.nama;
                document.getElementById('siswaKelas').value = siswa.kelas;
                document.getElementById('modalSiswa').style.display = 'block';
            }
        }

        function simpanSiswa() {
            const id = document.getElementById('siswaId').value;
            const nis = document.getElementById('siswaNIS').value;
            const nama = document.getElementById('siswaNama').value;
            const kelas = document.getElementById('siswaKelas').value;
            
            if (nis && nama && kelas) {
                showLoading();
                
                const siswaData = {
                    nis: nis,
                    nama: nama,
                    kelas: kelas
                };
                
                if (id) {
                    // Update existing student
                    database.ref('siswa/' + id).update(siswaData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalSiswa');
                            loadSiswaData();
                            showAlert('Data siswa berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new student
                    database.ref('siswa').push(siswaData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalSiswa');
                            loadSiswaData();
                            showAlert('Data siswa berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('NIS, nama, dan kelas tidak boleh kosong!', 'warning');
            }
        }

        function hapusSiswa(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
                showLoading();
                
                database.ref('siswa/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadSiswaData();
                        showAlert('Data siswa berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download student template
        function downloadTemplate() {
            const template = [
                ['NIS', 'Nama Siswa', 'Kelas'],
                ['12345', 'Ahmad Fauzi', '1'],
                ['12346', 'Siti Nurhaliza', '1']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Siswa");
            XLSX.writeFile(wb, "template_siswa.xlsx");
            
            showAlert('Template siswa berhasil diunduh!', 'success');
        }

        // Import students from Excel
        function importSiswaFromExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nama Siswa'] && row.Kelas) {
                            const siswaData = {
                                nis: row.NIS.toString(),
                                nama: row['Nama Siswa'].toString(),
                                kelas: row.Kelas.toString()
                            };
                            
                            const promise = database.ref('siswa').push(siswaData)
                                .then(() => {
                                    successCount++;
                                })
                                .catch((error) => {
                                    console.error('Error importing student:', error);
                                    errorCount++;
                                });
                            
                            promises.push(promise);
                        } else {
                            errorCount++;
                        }
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            hideLoading();
                            loadSiswaData();
                            showAlert(`Import selesai! ${successCount} siswa berhasil diimport, ${errorCount} gagal.`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Load teachers data
        function loadGuruData() {
            showLoading();
            
            database.ref('guru').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        guruData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        guruData = [];
                    }
                    
                    // Update teacher table
                    updateGuruTable();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update teacher table
        function updateGuruTable() {
            const tbody = document.getElementById('tabelGuru');
            tbody.innerHTML = '';
            
            if (guruData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            guruData.forEach(guru => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${guruData.indexOf(guru) + 1}</td>
                    <td>${guru.username}</td>
                    <td>${guru.nama}</td>
                    <td>Kelas ${guru.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editGuru('${guru.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusGuru('${guru.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Add/Edit teacher
        function tambahGuru() {
            document.getElementById('modalGuruTitle').textContent = 'Tambah Guru';
            document.getElementById('guruId').value = '';
            document.getElementById('guruUsername').value = '';
            document.getElementById('guruPassword').value = '';
            document.getElementById('guruNama').value = '';
            document.getElementById('guruKelas').value = '';
            document.getElementById('modalGuru').style.display = 'block';
        }

        function editGuru(id) {
            const guru = guruData.find(g => g.id === id);
            if (guru) {
                document.getElementById('modalGuruTitle').textContent = 'Edit Guru';
                document.getElementById('guruId').value = guru.id;
                document.getElementById('guruUsername').value = guru.username;
                document.getElementById('guruPassword').value = guru.password;
                document.getElementById('guruNama').value = guru.nama;
                document.getElementById('guruKelas').value = guru.kelas;
                document.getElementById('modalGuru').style.display = 'block';
            }
        }

        function simpanGuru() {
            const id = document.getElementById('guruId').value;
            const username = document.getElementById('guruUsername').value;
            const password = document.getElementById('guruPassword').value;
            const nama = document.getElementById('guruNama').value;
            const kelas = document.getElementById('guruKelas').value;
            
            if (username && password && nama && kelas) {
                showLoading();
                
                const guruData = {
                    username: username,
                    password: password,
                    nama: nama,
                    kelas: kelas
                };
                
                if (id) {
                    // Update existing teacher
                    database.ref('guru/' + id).update(guruData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalGuru');
                            loadGuruData();
                            showAlert('Data guru berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new teacher
                    database.ref('guru').push(guruData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalGuru');
                            loadGuruData();
                            showAlert('Data guru berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('Semua field harus diisi!', 'warning');
            }
        }

        function hapusGuru(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
                showLoading();
                
                database.ref('guru/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadGuruData();
                        showAlert('Data guru berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Load PTS data
        function loadPTSData() {
            // PTS data is loaded per subject when needed
        }

        // Show PTS data for selected subject
        function tampilkanPTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            
            if (!mapelId) {
                document.getElementById('PTSContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.</div>';
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('pts/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let ptsData = [];
                    if (snapshot.exists()) {
                        ptsData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Filter by teacher's class if not admin
                    if (userRole !== 'admin') {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                        const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                        ptsData = ptsData.filter(pts => siswaNIS.includes(pts.nis));
                    }
                    
                    // Update PTS container
                    const container = document.getElementById('PTSContainer');
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama Siswa</th>
                                        <th>Nilai PTS</th>
                                        <th>Predikat</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelPTSData">
                                    ${ptsData.length === 0 ? '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="inputPTS('${mapelId}')">
                                <i class="fas fa-plus"></i> Input Nilai PTS
                            </button>
                        </div>
                    `;
                    
                    // Populate PTS table
                    const tbody = document.getElementById('tabelPTSData');
                    if (ptsData.length > 0) {
                        ptsData.forEach(pts => {
                            const siswa = siswaData.find(s => s.nis === pts.nis);
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${pts.nis}</td>
                                <td>${siswa ? siswa.nama : '-'}</td>
                                <td>${pts.nilai}</td>
                                <td>${pts.predikat}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editPTS('${mapelId}', '${pts.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="hapusPTS('${mapelId}', '${pts.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Input PTS for selected subject
        function inputPTS(mapelId) {
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            document.getElementById('ptsMapel').value = mapel.nama;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            // Populate PTS table
            const tbody = document.getElementById('tabelPTS');
            tbody.innerHTML = '';
            
            if (studentsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada siswa</td></tr>';
            } else {
                studentsToShow.forEach(siswa => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>
                            <input type="number" class="form-control pts-nilai" min="0" max="100" value="" data-nis="${siswa.nis}">
                        </td>
                        <td>
                            <span class="pts-predikat">-</span>
                        </td>
                    `;
                    
                    // Add event listener to calculate predicate
                    const nilaiInput = row.querySelector('.pts-nilai');
                    nilaiInput.addEventListener('input', function() {
                        const nilai = parseInt(this.value);
                        const predikatCell = row.querySelector('.pts-predikat');
                        
                        if (isNaN(nilai)) {
                            predikatCell.textContent = '-';
                        } else if (nilai >= 90) {
                            predikatCell.textContent = 'A';
                        } else if (nilai >= 80) {
                            predikatCell.textContent = 'B';
                        } else if (nilai >= 70) {
                            predikatCell.textContent = 'C';
                        } else {
                            predikatCell.textContent = 'D';
                        }
                    });
                });
            }
            
            document.getElementById('modalPTS').style.display = 'block';
        }

        // Edit PTS
        function editPTS(mapelId, ptsId) {
            showLoading();
            
            database.ref('pts/' + mapelId + '/' + ptsId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const pts = snapshot.val();
                        const mapel = mapelData.find(m => m.id === mapelId);
                        
                        document.getElementById('ptsMapel').value = mapel.nama;
                        
                        // Get students based on role
                        let studentsToShow = [];
                        if (userRole === 'admin') {
                            studentsToShow = siswaData;
                        } else {
                            studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
                        }
                        
                        // Populate PTS table
                        const tbody = document.getElementById('tabelPTS');
                        tbody.innerHTML = '';
                        
                        studentsToShow.forEach(siswa => {
                            const row = tbody.insertRow();
                            const isCurrentPTS = siswa.nis === pts.nis;
                            
                            row.innerHTML = `
                                <td>${siswa.nis}</td>
                                <td>${siswa.nama}</td>
                                <td>
                                    <input type="number" class="form-control pts-nilai" min="0" max="100" value="${isCurrentPTS ? pts.nilai : ''}" data-nis="${siswa.nis}">
                                </td>
                                <td>
                                    <span class="pts-predikat">${isCurrentPTS ? pts.predikat : '-'}</span>
                                </td>
                            `;
                            
                            // Add event listener to calculate predicate
                            const nilaiInput = row.querySelector('.pts-nilai');
                            nilaiInput.addEventListener('input', function() {
                                const nilai = parseInt(this.value);
                                const predikatCell = row.querySelector('.pts-predikat');
                                
                                if (isNaN(nilai)) {
                                    predikatCell.textContent = '-';
                                } else if (nilai >= 90) {
                                    predikatCell.textContent = 'A';
                                } else if (nilai >= 80) {
                                    predikatCell.textContent = 'B';
                                } else if (nilai >= 70) {
                                    predikatCell.textContent = 'C';
                                } else {
                                    predikatCell.textContent = 'D';
                                }
                            });
                        });
                        
                        document.getElementById('modalPTS').style.display = 'block';
                    } else {
                        showAlert('Data PTS tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Save PTS data
        function simpanPTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Mata pelajaran tidak valid!', 'danger');
                return;
            }
            
            const nilaiInputs = document.querySelectorAll('.pts-nilai');
            let ptsData = [];
            let hasError = false;
            
            nilaiInputs.forEach(input => {
                const nis = input.dataset.nis;
                const nilai = parseInt(input.value);
                
                if (!isNaN(nilai)) {
                    let predikat;
                    if (nilai >= 90) {
                        predikat = 'A';
                    } else if (nilai >= 80) {
                        predikat = 'B';
                    } else if (nilai >= 70) {
                        predikat = 'C';
                    } else {
                        predikat = 'D';
                    }
                    
                    ptsData.push({
                        nis: nis,
                        nilai: nilai,
                        predikat: predikat
                    });
                }
            });
            
            if (ptsData.length === 0) {
                showAlert('Tidak ada data yang disimpan!', 'warning');
                return;
            }
            
            showLoading();
            
            let promises = [];
            
            ptsData.forEach(pts => {
                const promise = database.ref('pts/' + mapelId).child(pts.nis).set(pts)
                    .then(() => {
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error saving PTS:', error);
                        return false;
                    });
                
                promises.push(promise);
            });
            
            Promise.all(promises)
                .then((results) => {
                    hideLoading();
                    tutupModal('modalPTS');
                    tampilkanPTS();
                    showAlert(`Data PTS berhasil disimpan! ${results.filter(r => r).length} dari ${results.length} siswa.`, 'success');
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Delete PTS
        function hapusPTS(mapelId, ptsId) {
            if (confirm('Apakah Anda yakin ingin menghapus data PTS ini?')) {
                showLoading();
                
                database.ref('pts/' + mapelId + '/' + ptsId).remove()
                    .then(() => {
                        hideLoading();
                        tampilkanPTS();
                        showAlert('Data PTS berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download PTS template
        function downloadTemplatePTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            const template = [
                ['NIS', 'Nama Siswa', 'Nilai PTS']
            ];
            
            studentsToShow.forEach(siswa => {
                template.push([siswa.nis, siswa.nama, '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Template PTS ${mapel.nama}`);
            XLSX.writeFile(wb, `template_pts_${mapel.nama}.xlsx`);
            
            showAlert(`Template PTS ${mapel.nama} berhasil diunduh!`, 'success');
        }

        // Import PTS from Excel
        function importPTSFromExcel(event) {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nilai PTS'] !== undefined) {
                            const nilai = parseInt(row['Nilai PTS']);
                            
                            if (!isNaN(nilai)) {
                                let predikat;
                                if (nilai >= 90) {
                                    predikat = 'A';
                                } else if (nilai >= 80) {
                                    predikat = 'B';
                                } else if (nilai >= 70) {
                                    predikat = 'C';
                                } else {
                                    predikat = 'D';
                                }
                                
                                const ptsData = {
                                    nis: row.NIS.toString(),
                                    nilai: nilai,
                                    predikat: predikat
                                };
                                
                                const promise = database.ref('pts/' + mapelId).child(ptsData.nis).set(ptsData)
                                    .then(() => {
                                        successCount++;
                                    })
                                    .catch((error) => {
                                        console.error('Error importing PTS:', error);
                                        errorCount++;
                                    });
                                
                                promises.push(promise);
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            hideLoading();
                            tampilkanPTS();
                            showAlert(`Import selesai! ${successCount} data PTS berhasil diimport, ${errorCount} gagal.`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Export PTS to Excel
        function exportPTSToExcel() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('pts/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let exportData = [];
                    
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        
                        // Filter by teacher's class if not admin
                        if (userRole !== 'admin') {
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                            
                            Object.keys(ptsData).forEach(nis => {
                                if (siswaNIS.includes(nis)) {
                                    const pts = ptsData[nis];
                                    const siswa = siswaData.find(s => s.nis === nis);
                                    
                                    if (siswa) {
                                        exportData.push({
                                            'NIS': nis,
                                            'Nama Siswa': siswa.nama,
                                            'Kelas': siswa.kelas,
                                            'Nilai PTS': pts.nilai,
                                            'Predikat': pts.predikat
                                        });
                                    }
                                }
                            });
                        } else {
                            Object.keys(ptsData).forEach(nis => {
                                const pts = ptsData[nis];
                                const siswa = siswaData.find(s => s.nis === nis);
                                
                                if (siswa) {
                                    exportData.push({
                                        'NIS': nis,
                                        'Nama Siswa': siswa.nama,
                                        'Kelas': siswa.kelas,
                                        'Nilai PTS': pts.nilai,
                                        'Predikat': pts.predikat
                                    });
                                }
                            });
                        }
                    }
                    
                    if (exportData.length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, `Data PTS ${mapel.nama}`);
                        XLSX.writeFile(wb, `data_pts_${mapel.nama}.xlsx`);
                        
                        showAlert(`Data PTS ${mapel.nama} berhasil diekspor!`, 'success');
                    } else {
                        showAlert('Tidak ada data PTS yang diekspor!', 'warning');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Show report card
        function tampilkanRapor() {
            const siswaId = document.getElementById('pilihSiswaRapor').value;
            
            if (!siswaId) {
                document.getElementById('raporContainer').innerHTML = '';
                return;
            }
            
            const siswa = siswaData.find(s => s.id === siswaId);
            if (!siswa) return;
            
            showLoading();
            
            // Get all PTS data for this student
            let ptsPromises = [];
            let ptsResults = {};
            
            mapelData.forEach(mapel => {
                const promise = database.ref('pts/' + mapel.id + '/' + siswa.nis).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            ptsResults[mapel.id] = snapshot.val();
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting PTS data:', error);
                        return false;
                    });
                
                ptsPromises.push(promise);
            });
            
            Promise.all(ptsPromises)
                .then(() => {
                    hideLoading();
                    
                    // Generate report card HTML
                    let html = `
                        <div class="rapor">
                            <div class="rapor-header">
                                ${logoSekolahURL ? `<img src="${logoSekolahURL}" alt="Logo Sekolah" class="rapor-logo">` : ''}
                                <div class="rapor-title">RAPOR HASIL BELAJAR SISWA</div>
                                <div class="rapor-subtitle">KURIKULUM MERDEKA - SEMESTER 1</div>
                            </div>
                            <div class="rapor-info">
                                <p><strong>NIS:</strong> ${siswa.nis}</p>
                                <p><strong>Nama Siswa:</strong> ${siswa.nama}</p>
                                <p><strong>Kelas:</strong> Kelas ${siswa.kelas}</p>
                                <p><strong>Semester:</strong> 1</p>
                                <p><strong>Tahun Ajaran:</strong> 2025/2026</p>
                            </div>
                            <div class="rapor-section">
                                <div class="rapor-section-title">A. NILAI HASIL BELAJAR (PTS)</div>
                                <table class="rapor-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Mata Pelajaran</th>
                                            <th>Nilai PTS</th>
                                            <th>Predikat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Add PTS data to table
                    let no = 1;
                    mapelData.forEach(mapel => {
                        const pts = ptsResults[mapel.id];
                        
                        if (pts) {
                            html += `
                                <tr>
                                    <td>${no++}</td>
                                    <td>${mapel.nama}</td>
                                    <td>${pts.nilai}</td>
                                    <td>${pts.predikat}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="rapor-section">
                                <div class="rapor-section-title">B. DESKRIPSI PERKEMBANGAN</div>
                                <p>- Sikap: Siswa menunjukkan sikap tanggung jawab dan kerja sama dalam kelompok.</p>
                                <p>- Pengetahuan: Siswa memahami konsep dasar dengan baik.</p>
                                <p>- Keterampilan: Siswa dapat menerapkan pengetahuan dalam praktik.</p>
                            </div>
                            <div class="rapor-signature">
                                <div class="rapor-signature-box">
                                    <p>Wali Kelas</p>
                                    <div class="rapor-signature-line"></div>
                                    <p>NIP. ....................</p>
                                </div>
                                <div class="rapor-signature-box">
                                    <p>Orang Tua/Wali</p>
                                    <div class="rapor-signature-line"></div>
                                    <p>............................</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('raporContainer').innerHTML = html;
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load monitoring data
        function loadMonitoringData() {
            showLoading();
            
            // Get all PTS data
            let ptsPromises = [];
            let ptsResults = {};
            
            mapelData.forEach(mapel => {
                const promise = database.ref('pts/' + mapel.id).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            ptsResults[mapel.id] = {
                                nama: mapel.nama,
                                data: snapshot.val()
                            };
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting PTS data for monitoring:', error);
                        return false;
                    });
                
                ptsPromises.push(promise);
            });
            
            Promise.all(ptsPromises)
                .then(() => {
                    hideLoading();
                    
                    // Prepare data for chart
                    const chartLabels = mapelData.map(mapel => mapel.nama);
                    const chartData = [];
                    
                    mapelData.forEach(mapel => {
                        const pts = ptsResults[mapel.id];
                        let count = 0;
                        
                        if (pts && pts.data) {
                            count = Object.keys(pts.data).length;
                        }
                        
                        chartData.push(count);
                    });
                    
                    // Create chart
                    const ctx = document.getElementById('monitoringChart').getContext('2d');
                    
                    if (monitoringChart) {
                        monitoringChart.destroy();
                    }
                    
                    monitoringChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Jumlah Siswa Dinilai',
                                data: chartData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Jumlah Siswa'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Prepare progress data for each teacher
                    let progressHTML = '';
                    
                    guruData.forEach(guru => {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === guru.kelas);
                        const totalSiswa = siswaKelas.length;
                        
                        let completedPTS = 0;
                        mapelData.forEach(mapel => {
                            const pts = ptsResults[mapel.id];
                            
                            if (pts && pts.data) {
                                Object.keys(pts.data).forEach(nis => {
                                    if (siswaKelas.some(siswa => siswa.nis === nis)) {
                                        completedPTS++;
                                    }
                                });
                            }
                        });
                        
                        const totalPossiblePTS = totalSiswa * mapelData.length;
                        const progressPercentage = totalPossiblePTS > 0 ? Math.round((completedPTS / totalPossiblePTS) * 100) : 0;
                        
                        progressHTML += `
                            <div class="progress-item">
                                <div class="progress-header">
                                    <div class="progress-title">${guru.nama} (Kelas ${guru.kelas})</div>
                                    <div class="progress-percentage">${progressPercentage}%</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('progressList').innerHTML = progressHTML;
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load school logo
        function loadLogoSekolah() {
            database.ref('settings/logo').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        logoSekolahURL = snapshot.val();
                        const logoImg = document.getElementById('logoSekolah');
                        if (logoImg) {
                            logoImg.src = logoSekolahURL;
                            logoImg.style.display = 'block';
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading logo:', error);
                });
        }

        // Upload school logo
        function uploadLogoSekolah(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading();
            
            // Create a storage reference
            const storageRef = storage.ref('logo/' + file.name);
            
            // Upload file
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Observe state change events such as progress, pause, and resume
                    // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                }, 
                (error) => {
                    // Handle unsuccessful uploads
                    hideLoading();
                    showAlert('Error uploading logo: ' + error.message, 'danger');
                }, 
                () => {
                    // Handle successful uploads on complete
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        hideLoading();
                        
                        // Save URL to database
                        database.ref('settings/logo').set(downloadURL)
                            .then(() => {
                                logoSekolahURL = downloadURL;
                                
                                // Update preview
                                const logoImg = document.getElementById('logoSekolah');
                                if (logoImg) {
                                    logoImg.src = downloadURL;
                                    logoImg.style.display = 'block';
                                }
                                
                                showAlert('Logo sekolah berhasil diupload!', 'success');
                            })
                            .catch((error) => {
                                showAlert('Error saving logo URL: ' + error.message, 'danger');
                            });
                    });
                }
            );
        }

        // Close modal
        function tutupModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userRole = currentUser.role;
                    
                    if (userRole === 'guru') {
                        userKelas = currentUser.kelas;
                    }
                    
                    showMainApp();
                    
                    if (userRole === 'admin') {
                        loadAdminData();
                    } else {
                        loadTeacherData();
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                }
            }
        });
    </script>
</body>
</html>
