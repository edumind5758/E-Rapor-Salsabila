<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Rapor Salsabila Klaseman</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<style>
:root {
--primary-color: #4e73df;
--secondary-color: #858796;
--success-color: #1cc88a;
--info-color: #36b9cc;
--warning-color: #f6c23e;
--danger-color: #e74a3b;
--light-color: #f8f9fc;
--dark-color: #5a5c69;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
font-size: 14px;
}

.wrapper {
display: flex;
min-height: 100vh;
}

/* Sidebar */
.sidebar {
width: 250px;
background-color: var(--primary-color);
color: white;
transition: all 0.3s;
}

.sidebar-brand {
height: 60px;
display: flex;
align-items: center;
justify-content: center;
font-size: 20px;
font-weight: bold;
background-color: rgba(0, 0, 0, 0.1);
}

.sidebar-menu {
padding: 20px 0;
}

.sidebar-item {
padding: 12px 20px;
display: flex;
align-items: center;
cursor: pointer;
transition: all 0.3s;
}

.sidebar-item:hover {
background-color: rgba(255, 255, 255, 0.1);
}

.sidebar-item i {
margin-right: 10px;
width: 20px;
text-align: center;
}

.sidebar-item.active {
background-color: rgba(255, 255, 255, 0.2);
border-left: 4px solid white;
}

/* Main Content */
.content {
flex: 1;
padding: 20px;
overflow-y: auto;
}

.content-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.content-title {
font-size: 24px;
font-weight: bold;
color: var(--primary-color);
}

.user-info {
display: flex;
align-items: center;
}

.user-info img {
width: 40px;
height: 40px;
border-radius: 50%;
margin-right: 10px;
}

/* Cards */
.card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
margin-bottom: 20px;
}

.card-header {
padding: 15px 20px;
border-bottom: 1px solid #e3e6f0;
font-weight: bold;
display: flex;
justify-content: space-between;
align-items: center;
}

.card-body {
padding: 20px;
}

/* Form */
.form-group {
margin-bottom: 15px;
}

.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
}

.form-control {
width: 100%;
padding: 10px 15px;
border: 1px solid #d1d3e2;
border-radius: 4px;
font-size: 14px;
}

.form-control:focus {
outline: none;
border-color: var(--primary-color);
box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

/* Buttons */
.btn {
padding: 10px 15px;
border-radius: 4px;
font-weight: 600;
cursor: pointer;
border: none;
display: inline-block;
text-align: center;
transition: all 0.2s;
}

.btn-primary {
background-color: var(--primary-color);
color: white;
}

.btn-primary:hover {
background-color: #2e59d9;
}

.btn-success {
background-color: var(--success-color);
color: white;
}

.btn-success:hover {
background-color: #17a673;
}

.btn-danger {
background-color: var(--danger-color);
color: white;
}

.btn-danger:hover {
background-color: #c82333;
}

.btn-warning {
background-color: var(--warning-color);
color: white;
}

.btn-warning:hover {
background-color: #dda20a;
}

.btn-info {
background-color: var(--info-color);
color: white;
}

.btn-info:hover {
background-color: #2c9faf;
}

.btn-sm {
padding: 5px 10px;
font-size: 12px;
}

/* Table */
.table {
width: 100%;
border-collapse: collapse;
}

.table th, .table td {
padding: 12px 15px;
text-align: left;
border-bottom: 1px solid #e3e6f0;
}

.table th {
background-color: #f8f9fc;
font-weight: 600;
color: var(--primary-color);
border-top: none;
}

.table tbody tr:hover {
background-color: rgba(0, 0, 0, 0.02);
}

/* Modal */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
animation: fadeIn 0.3s;
}

.modal-content {
background-color: white;
margin: 5% auto;
padding: 0;
border-radius: 8px;
width: 80%;
max-width: 600px;
box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
animation: slideIn 0.3s;
}

.modal-header {
padding: 15px 20px;
border-bottom: 1px solid #e3e6f0;
display: flex;
justify-content: space-between;
align-items: center;
}

.modal-title {
font-size: 18px;
font-weight: bold;
color: var(--primary-color);
}

.modal-close {
font-size: 24px;
cursor: pointer;
color: var(--secondary-color);
}

.modal-body {
padding: 20px;
}

.modal-footer {
padding: 15px 20px;
border-top: 1px solid #e3e6f0;
display: flex;
justify-content: flex-end;
}

/* Rapor */
.rapor {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 30px;
margin: 20px auto;
max-width: 800px;
}

.rapor-header {
text-align: center;
margin-bottom: 30px;
position: relative;
}

.rapor-logo {
position: absolute;
top: 0;
left: 0;
width: 80px;
height: 80px;
}

.rapor-title {
font-size: 24px;
font-weight: bold;
margin-bottom: 10px;
}

.rapor-subtitle {
font-size: 18px;
color: var(--secondary-color);
}

.rapor-info {
margin-bottom: 20px;
}

.rapor-info p {
margin-bottom: 5px;
}

.rapor-section {
margin-bottom: 20px;
}

.rapor-section-title {
font-size: 16px;
font-weight: bold;
margin-bottom: 10px;
color: var(--primary-color);
}

.rapor-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.rapor-table th, .rapor-table td {
border: 1px solid #ddd;
padding: 8px;
text-align: left;
}

.rapor-table th {
background-color: #f2f2f2;
}

.rapor-signature {
display: flex;
justify-content: space-between;
margin-top: 30px;
}

.rapor-signature-box {
text-align: center;
width: 45%;
}

.rapor-signature-line {
height: 1px;
background-color: black;
margin: 40px 0 5px;
}

/* Subject Cards */
.subject-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 20px;
margin-bottom: 20px;
cursor: pointer;
transition: all 0.3s;
}

.subject-card:hover {
transform: translateY(-5px);
box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.subject-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}

.subject-title {
font-size: 18px;
font-weight: bold;
color: var(--primary-color);
}

.subject-icon {
font-size: 24px;
color: var(--primary-color);
}

.subject-progress {
margin-top: 10px;
}

.progress-bar {
height: 10px;
background-color: #e9ecef;
border-radius: 5px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background-color: var(--success-color);
}

/* Chart Container */
.chart-container {
position: relative;
height: 300px;
width: 100%;
}

/* Animations */
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes slideIn {
from { transform: translateY(-50px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
.wrapper {
flex-direction: column;
}

.sidebar {
width: 100%;
height: auto;
}

.content {
padding: 10px;
}

.modal-content {
width: 95%;
margin: 10% auto;
}
}

.no-print {
display: block;
}

@media print {
.no-print {
display: none;
}
}

/* Loading indicator */
.loading {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0.8);
z-index: 9999;
justify-content: center;
align-items: center;
flex-direction: column;
}

.loading-spinner {
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary-color);
border-radius: 50%;
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin-bottom: 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Alert */
.alert {
padding: 15px;
margin-bottom: 20px;
border: 1px solid transparent;
border-radius: 4px;
}

.alert-success {
color: #155724;
background-color: #d4edda;
border-color: #c3e6cb;
}

.alert-danger {
color: #721c24;
background-color: #f8d7da;
border-color: #f5c6cb;
}

.alert-info {
color: #0c5460;
background-color: #d1ecf1;
border-color: #bee5eb;
}

.alert-warning {
color: #856404;
background-color: #fff3cd;
border-color: #ffeeba;
}

.close-alert {
float: right;
font-size: 20px;
font-weight: bold;
cursor: pointer;
}

/* Login Form */
.login-container {
max-width: 400px;
margin: 100px auto;
}

.login-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 30px;
}

.login-header {
text-align: center;
margin-bottom: 30px;
}

.login-title {
font-size: 24px;
font-weight: bold;
color: var(--primary-color);
}

.role-selector {
display: flex;
justify-content: space-between;
margin-bottom: 20px;
}

.role-option {
flex: 1;
text-align: center;
padding: 15px;
border: 1px solid #d1d3e2;
border-radius: 4px;
cursor: pointer;
transition: all 0.2s;
}

.role-option.active {
background-color: var(--primary-color);
color: white;
border-color: var(--primary-color);
}

/* Template Download */
.template-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 20px;
margin-bottom: 20px;
text-align: center;
}

.template-icon {
font-size: 48px;
color: var(--primary-color);
margin-bottom: 15px;
}

.template-title {
font-size: 18px;
font-weight: bold;
margin-bottom: 10px;
}

.template-description {
color: var(--secondary-color);
margin-bottom: 15px;
}

/* Progress Monitoring */
.progress-item {
margin-bottom: 15px;
}

.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
}

.progress-title {
font-weight: 600;
}

.progress-percentage {
color: var(--secondary-color);
}

/* PH List */
.ph-list {
margin-bottom: 15px;
}

.ph-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px;
border: 1px solid #e3e6f0;
border-radius: 4px;
margin-bottom: 5px;
}

.ph-info {
flex: 1;
}

.ph-date {
color: var(--secondary-color);
font-size: 12px;
}

.ph-actions {
display: flex;
gap: 5px;
}

/* Tabs */
.tabs {
display: flex;
margin-bottom: 15px;
border-bottom: 1px solid #e3e6f0;
}

.tab {
padding: 10px 15px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.2s;
}

.tab.active {
border-bottom: 2px solid var(--primary-color);
color: var(--primary-color);
font-weight: 600;
}

/* Leger Table */
.leger-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.leger-table th, .leger-table td {
border: 1px solid #ddd;
padding: 8px;
text-align: center;
}

.leger-table th {
background-color: #f2f2f2;
position: sticky;
top: 0;
}

.leger-table .student-name {
text-align: left;
}

.leger-table .subject-header {
background-color: #e9ecef;
font-weight: 600;
}

.leger-table .assessment-type {
background-color: #f8f9fc;
font-size: 12px;
font-weight: 600;
}

/* Grid system */
.row {
display: flex;
flex-wrap: wrap;
margin-right: -15px;
margin-left: -15px;
}

.col-md-3 {
position: relative;
width: 100%;
padding-right: 15px;
padding-left: 15px;
}

@media (min-width: 768px) {
.col-md-3 {
flex: 0 0 25%;
max-width: 25%;
}
}

.text-xs {
font-size: 0.75rem;
}

.font-weight-bold {
font-weight: 700;
}

.text-primary {
color: var(--primary-color) !important;
}

.text-uppercase {
text-transform: uppercase;
}

.mb-1 {
margin-bottom: 0.25rem !important;
}

.h5 {
font-size: 1.25rem;
}

.mb-0 {
margin-bottom: 0 !important;
}

.text-gray-800 {
color: #5a5c69 !important;
}

.col-auto {
flex: 0 0 auto;
width: auto;
max-width: 100%;
}

.text-success {
color: var(--success-color) !important;
}

.text-info {
color: var(--info-color) !important;
}

.text-warning {
color: var(--warning-color) !important;
}

.fa-2x {
font-size: 2em;
}

.text-gray-300 {
color: #dddfeb !important;
}

.align-items-center {
align-items: center !important;
}

.m-0 {
margin: 0 !important;
}

.mt-4 {
margin-top: 1.5rem !important;
}

.table-responsive {
display: block;
width: 100%;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
}
</style>
</head>
<body>
<div class="loading" id="loadingIndicator">
<div class="loading-spinner"></div>
<p>Memproses data...</p>
</div>

<!-- Login Form -->
<div id="loginForm" class="login-container">
<div class="login-card">
<div class="login-header">
<div class="login-title">E-Rapor Salsabila Klaseman</div>
<p>Silakan login untuk melanjutkan</p>
</div>
<form id="loginFormElement">
<div class="form-group">
<label for="username">Username</label>
<input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
</div>
<div class="form-group">
<label for="password">Password</label>
<input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
</div>
<div class="form-group">
<label>Pilih Role</label>
<div class="role-selector">
<div class="role-option active" data-role="admin">Admin</div>
<div class="role-option" data-role="guru">Guru Kelas</div>
</div>
</div>
<div class="form-group" id="kelasFormGroup" style="display: none;">
<label for="kelas">Kelas (untuk Guru)</label>
<select id="kelas" class="form-control">
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
</form>
</div>
</div>

<!-- Main Application -->
<div id="mainApp" class="wrapper" style="display: none;">
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-brand">
<i class="fas fa-graduation-cap"></i> E-Rapor Salsabila
</div>
<div class="sidebar-menu">
<div class="sidebar-item active" onclick="showSection('dashboard')">
<i class="fas fa-tachometer-alt"></i> Dashboard
</div>
<div class="sidebar-item" onclick="showSection('subjects')" id="subjectsMenu" style="display: none;">
<i class="fas fa-book"></i> Mata Pelajaran
</div>
<div class="sidebar-item" onclick="showSection('students')" id="studentsMenu" style="display: none;">
<i class="fas fa-users"></i> Data Siswa
</div>
<div class="sidebar-item" onclick="showSection('ph')" id="phMenu">
<i class="fas fa-clipboard-list"></i> Penilaian Harian
</div>
<div class="sidebar-item" onclick="showSection('assessment')" id="assessmentMenu">
<i class="fas fa-clipboard-list"></i> Penilaian PTS
</div>
<div class="sidebar-item" onclick="showSection('sas')" id="sasMenu">
<i class="fas fa-clipboard-list"></i> Penilaian SAS
</div>
<div class="sidebar-item" onclick="showSection('leger')" id="legerMenu">
<i class="fas fa-table"></i> Leger Nilai
</div>
<div class="sidebar-item" onclick="showSection('pts')" id="ptsMenu">
<i class="fas fa-file-alt"></i> Cetak PTS
</div>
<div class="sidebar-item" onclick="showSection('monitoring')" id="monitoringMenu" style="display: none;">
<i class="fas fa-chart-line"></i> Monitoring
</div>
<div class="sidebar-item" onclick="showSection('settings')" id="settingsMenu" style="display: none;">
<i class="fas fa-cog"></i> Pengaturan
</div>
<div class="sidebar-item" onclick="logout()">
<i class="fas fa-sign-out-alt"></i> Logout
</div>
</div>
</div>

<!-- Main Content -->
<div class="content">
<div class="content-header">
<h1 class="content-title">Dashboard</h1>
<div class="user-info">
<span id="userInfo">Admin</span>
<img src="https://i.imgur.com/0DQ3Q4V.jpg" alt="User">
</div>
</div>

<!-- Dashboard Section -->
<div id="dashboard-section" class="content-section">
<div class="row">
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Siswa</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSiswa">0</div>
</div>
<div class="col-auto">
<i class="fas fa-users fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mata Pelajaran</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMapel">0</div>
</div>
<div class="col-auto">
<i class="fas fa-book fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-info text-uppercase mb-1">Penilaian Selesai</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPenilaian">0</div>
</div>
<div class="col-auto">
<i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Progress</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="progressPercentage">0%</div>
</div>
<div class="col-auto">
<i class="fas fa-percentage fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Subject Cards -->
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Mata Pelajaran</h6>
</div>
<div class="card-body">
<div id="subjectCards">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk menginput nilai.
</div>
</div>
</div>
</div>
</div>

<!-- Subjects Section (Admin Only) -->
<div id="subjects-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Mata Pelajaran</h6>
<button class="btn btn-primary btn-sm" onclick="tambahMapel()">
<i class="fas fa-plus"></i> Tambah Mata Pelajaran
</button>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>No</th>
<th>Kode</th>
<th>Nama Mata Pelajaran</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelMapel">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Students Section (Admin Only) -->
<div id="students-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Data Siswa</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplate()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importSiswa" onchange="importSiswaFromExcel(event)" style="display: none;">
</label>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="filterKelasSiswa">Filter Kelas</label>
<select id="filterKelasSiswa" class="form-control" onchange="filterSiswa()">
<option value="">-- Semua Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Kelas</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelSiswa">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- PH Section -->
<div id="ph-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian Harian (PH)</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplatePH()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importPH" onchange="importPHFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportPHToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelPH">Pilih Mata Pelajaran</label>
<select id="pilihMapelPH" class="form-control" onchange="tampilkanPH()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="PHContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian harian.
</div>
</div>
</div>
</div>
</div>

<!-- Assessment Section -->
<div id="assessment-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian PTS</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplatePTS()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importPTS" onchange="importPTSFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportPTSToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelPTS">Pilih Mata Pelajaran</label>
<select id="pilihMapelPTS" class="form-control" onchange="tampilkanPTS()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="PTSContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.
</div>
</div>
</div>
</div>
</div>

<!-- SAS Section -->
<div id="sas-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian SAS</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplateSAS()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importSAS" onchange="importSASFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportSASToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelSAS">Pilih Mata Pelajaran</label>
<select id="pilihMapelSAS" class="form-control" onchange="tampilkanSAS()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="SASContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian SAS.
</div>
</div>
</div>
</div>
</div>

<!-- Leger Section -->
<div id="leger-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Leger Nilai</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadLegerTemplate()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importLeger" onchange="importLegerFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportLegerToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="filterKelasLeger">Filter Kelas</label>
<select id="filterKelasLeger" class="form-control" onchange="tampilkanLeger()">
<option value="">-- Semua Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<div id="legerContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger nilai.
</div>
</div>
</div>
</div>
</div>

<!-- PTS Report Section -->
<div id="pts-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Cetak PTS</h6>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihSiswaPTS">Pilih Siswa</label>
<select id="pilihSiswaPTS" class="form-control" onchange="tampilkanReportPTS()">
<option value="">-- Pilih Siswa --</option>
</select>
</div>
<button class="btn btn-primary" onclick="window.print()">
<i class="fas fa-print"></i> Cetak Laporan PTS
</button>
</div>
</div>
<div id="reportPTSContainer"></div>
</div>

<!-- Monitoring Section (Admin Only) -->
<div id="monitoring-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Monitoring Pengisian Nilai</h6>
</div>
<div class="card-body">
<div class="chart-container">
<canvas id="monitoringChart"></canvas>
</div>
<div id="progressMonitoring">
<h6 class="mt-4">Progress per Guru</h6>
<div id="progressList">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Loading progress data...
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Settings Section (Admin Only) -->
<div id="settings-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Pengaturan</h6>
</div>
<div class="card-body">
<div class="template-card">
<div class="template-icon">
<i class="fas fa-image"></i>
</div>
<div class="template-title">Logo Sekolah</div>
<div class="template-description">Upload logo sekolah untuk ditampilkan di rapor</div>
<div id="logoPreview">
<img id="logoSekolah" src="" alt="Logo Sekolah" style="max-width: 200px; max-height: 200px; display: none;">
</div>
<label class="btn btn-primary">
<i class="fas fa-upload"></i> Upload Logo
<input type="file" id="uploadLogo" onchange="uploadLogoSekolah(event)" style="display: none;" accept="image/*">
</label>
</div>

<div class="card mt-4">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Guru</h6>
<button class="btn btn-primary btn-sm" onclick="tambahGuru()">
<i class="fas fa-plus"></i> Tambah Guru
</button>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>No</th>
<th>Username</th>
<th>Nama Guru</th>
<th>Kelas</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelGuru">
<tr>
<td colspan="5" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Modal Add/Edit Subject -->
<div id="modalMapel" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalMapelTitle">Tambah Mata Pelajaran</h5>
<span class="modal-close" onclick="tutupModal('modalMapel')">&times;</span>
</div>
<div class="modal-body">
<form id="formMapel">
<input type="hidden" id="mapelId">
<div class="form-group">
<label for="mapelKode">Kode Mata Pelajaran</label>
<input type="text" id="mapelKode" class="form-control" required>
</div>
<div class="form-group">
<label for="mapelNama">Nama Mata Pelajaran</label>
<input type="text" id="mapelNama" class="form-control" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalMapel')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanMapel()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Add/Edit Student -->
<div id="modalSiswa" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalSiswaTitle">Tambah Siswa</h5>
<span class="modal-close" onclick="tutupModal('modalSiswa')">&times;</span>
</div>
<div class="modal-body">
<form id="formSiswa">
<input type="hidden" id="siswaId">
<div class="form-group">
<label for="siswaNIS">NIS</label>
<input type="text" id="siswaNIS" class="form-control" required>
</div>
<div class="form-group">
<label for="siswaNama">Nama Siswa</label>
<input type="text" id="siswaNama" class="form-control" required>
</div>
<div class="form-group">
<label for="siswaKelas">Kelas</label>
<select id="siswaKelas" class="form-control" required>
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalSiswa')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanSiswa()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Add/Edit Teacher -->
<div id="modalGuru" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalGuruTitle">Tambah Guru</h5>
<span class="modal-close" onclick="tutupModal('modalGuru')">&times;</span>
</div>
<div class="modal-body">
<form id="formGuru">
<input type="hidden" id="guruId">
<div class="form-group">
<label for="guruUsername">Username</label>
<input type="text" id="guruUsername" class="form-control" required>
</div>
<div class="form-group">
<label for="guruPassword">Password</label>
<input type="password" id="guruPassword" class="form-control" required>
</div>
<div class="form-group">
<label for="guruNama">Nama Guru</label>
<input type="text" id="guruNama" class="form-control" required>
</div>
<div class="form-group">
<label for="guruKelas">Kelas</label>
<select id="guruKelas" class="form-control" required>
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalGuru')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanGuru()">Simpan</button>
</div>
</div>
</div>

<!-- Modal PH Input -->
<div id="modalPH" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Penilaian Harian (PH)</h5>
<span class="modal-close" onclick="tutupModal('modalPH')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="phMapel">Mata Pelajaran</label>
<input type="text" id="phMapel" class="form-control" readonly>
</div>
<div class="form-group">
<label for="phTanggal">Tanggal</label>
<input type="date" id="phTanggal" class="form-control" required>
</div>
<div class="form-group">
<label for="phDeskripsi">Deskripsi Penilaian</label>
<input type="text" id="phDeskripsi" class="form-control" placeholder="Contoh: Ulangan Harian 1" required>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelPH">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalPH')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanPH()">Simpan</button>
</div>
</div>
</div>

<!-- Modal PTS Input -->
<div id="modalPTS" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai PTS</h5>
<span class="modal-close" onclick="tutupModal('modalPTS')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="ptsMapel">Mata Pelajaran</label>
<input type="text" id="ptsMapel" class="form-control" readonly>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai PTS</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelPTS">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalPTS')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanPTS()">Simpan</button>
</div>
</div>
</div>

<!-- Modal SAS Input -->
<div id="modalSAS" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai SAS</h5>
<span class="modal-close" onclick="tutupModal('modalSAS')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="sasMapel">Mata Pelajaran</label>
<input type="text" id="sasMapel" class="form-control" readonly>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai SAS</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelSAS">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalSAS')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanSAS()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Leger Input -->
<div id="modalLeger" class="modal">
<div class="modal-content" style="max-width: 90%;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai Leger</h5>
<span class="modal-close" onclick="tutupModal('modalLeger')">&times;</span>
</div>
<div class="modal-body">
<div class="table-responsive">
<table class="table leger-table">
<thead>
<tr>
<th rowspan="2">No</th>
<th rowspan="2">NIS</th>
<th rowspan="2">Nama Siswa</th>
<th colspan="9">Nilai Per Mata Pelajaran</th>
</tr>
<tr id="legerHeader">
<!-- Subject headers will be added here -->
</tr>
</thead>
<tbody id="tabelLeger">
<!-- Student rows will be added here -->
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalLeger')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanLeger()">Simpan</button>
</div>
</div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
apiKey: "AIzaSyCQQcgPoQMIeCn3tSkn7NAks2cRFTV8Df4",
authDomain: "e-rapor-salsabila-klaseman.firebaseapp.com",
databaseURL: "https://e-rapor-salsabila-klaseman-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "e-rapor-salsabila-klaseman",
storageBucket: "e-rapor-salsabila-klaseman.firebasestorage.app",
messagingSenderId: "519176085482",
appId: "1:519176085482:web:66dc1c0e4264a8af911c93",
measurementId: "G-XJTP2RYMMC"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();

// Global Variables
let currentUser = null;
let userRole = null;
let userKelas = null;
let mapelData = [];
let siswaData = [];
let guruData = [];
let phData = {};
let ptsData = {};
let sasData = {};
let legerData = {};
let logoSekolahURL = "";
let monitoringChart = null;

// Show loading indicator
function showLoading() {
document.getElementById('loadingIndicator').style.display = 'flex';
}

// Hide loading indicator
function hideLoading() {
document.getElementById('loadingIndicator').style.display = 'none';
}

// Show alert message
function showAlert(message, type = 'info') {
const alertDiv = document.createElement('div');
alertDiv.className = `alert alert-${type}`;
alertDiv.innerHTML = `
${message}
<span class="close-alert" onclick="this.parentElement.remove()">&times;</span>
`;
document.querySelector('.content-header').after(alertDiv);

// Auto remove after 5 seconds
setTimeout(() => {
alertDiv.remove();
}, 5000);
}

// Role selection
document.querySelectorAll('.role-option').forEach(option => {
option.addEventListener('click', function() {
document.querySelectorAll('.role-option').forEach(opt => {
opt.classList.remove('active');
});
this.classList.add('active');
const selectedRole = this.dataset.role;
const kelasFormGroup = document.getElementById('kelasFormGroup');
if (selectedRole === 'guru') {
kelasFormGroup.style.display = 'block';
} else {
kelasFormGroup.style.display = 'none';
}
});
});

// Login form submission
document.getElementById('loginFormElement').addEventListener('submit', function(e) {
e.preventDefault();
console.log("Login form submitted");

const username = document.getElementById('username').value;
const password = document.getElementById('password').value;
const role = document.querySelector('.role-option.active').dataset.role;
const kelas = document.getElementById('kelas').value;

console.log("Login data:", { username, password, role, kelas });

// Simple validation (in real app, this should be done against a database)
if (username && password) {
if (role === 'admin') {
// Admin login
console.log("Attempting admin login");
if (username === 'admin' && password === 'admin') {
console.log("Admin login successful");
currentUser = { username: username, role: role };
userRole = role;
showMainApp();
loadAdminData();
} else {
console.log("Admin login failed");
showAlert('Username atau password salah!', 'danger');
}
} else {
// Teacher login
console.log("Attempting teacher login");
if (kelas) {
// Check if teacher exists in database
checkTeacherLogin(username, password, kelas);
} else {
console.log("Teacher login failed: no class selected");
showAlert('Silakan pilih kelas!', 'warning');
}
}
} else {
console.log("Login failed: missing username or password");
showAlert('Username dan password tidak boleh kosong!', 'warning');
}
});

// Check teacher login against database
function checkTeacherLogin(username, password, kelas) {
console.log("Checking teacher login:", { username, password, kelas });
showLoading();

database.ref('guru').orderByChild('username').equalTo(username).once('value')
.then((snapshot) => {
hideLoading();
console.log("Teacher query result:", snapshot.exists());

if (snapshot.exists()) {
const teacherData = snapshot.val();
const teacherKey = Object.keys(teacherData)[0];
const teacher = teacherData[teacherKey];
console.log("Teacher found:", teacher);

if (teacher.password === password && teacher.kelas === kelas) {
console.log("Teacher login successful");
currentUser = {
id: teacherKey,
username: teacher.username,
nama: teacher.nama,
kelas: teacher.kelas,
role: 'guru'
};
userRole = 'guru';
userKelas = kelas;
showMainApp();
loadTeacherData();
} else {
console.log("Teacher login failed: wrong password or class");
showAlert('Password atau kelas salah!', 'danger');
}
} else {
console.log("Teacher not found");
showAlert('Username tidak ditemukan!', 'danger');
}
})
.catch((error) => {
hideLoading();
console.error("Error checking teacher login:", error);
showAlert('Error: ' + error.message, 'danger');
});
}

// Show main application
function showMainApp() {
console.log("Showing main app");
console.log("Current user:", currentUser);
console.log("User role:", userRole);
console.log("User class:", userKelas);

document.getElementById('loginForm').style.display = 'none';
document.getElementById('mainApp').style.display = 'flex';

// Update user info
if (userRole === 'admin') {
document.getElementById('userInfo').textContent = 'Admin';
document.getElementById('subjectsMenu').style.display = 'block';
document.getElementById('studentsMenu').style.display = 'block';
document.getElementById('monitoringMenu').style.display = 'block';
document.getElementById('settingsMenu').style.display = 'block';
console.log("Admin menus shown");
} else {
document.getElementById('userInfo').textContent = currentUser.nama;
document.getElementById('subjectsMenu').style.display = 'none';
document.getElementById('studentsMenu').style.display = 'none';
document.getElementById('monitoringMenu').style.display = 'none';
document.getElementById('settingsMenu').style.display = 'none';
console.log("Teacher menus shown");
}

// Load data based on role
if (userRole === 'admin') {
loadMapelData();
loadSiswaData();
loadGuruData();
loadLogoSekolah();
} else {
loadMapelData();
loadSiswaByKelas(userKelas);
loadPHData();
loadPTSData();
loadSASData();
}
}

// Load admin data
function loadAdminData() {
console.log("Loading admin data");
updateDashboard();
loadSubjectCards();
}

// Load teacher data
function loadTeacherData() {
console.log("Loading teacher data");
updateDashboard();
loadSubjectCards();
loadPHData();
loadPTSData();
loadSASData();
}

// Update dashboard statistics
function updateDashboard() {
console.log("Updating dashboard");
if (userRole === 'admin') {
// Admin dashboard
document.getElementById('totalSiswa').textContent = siswaData.length;
document.getElementById('totalMapel').textContent = mapelData.length;
document.getElementById('progressPercentage').textContent = '0%';
document.getElementById('totalPenilaian').textContent = '0';
console.log("Admin dashboard updated");
} else {
// Teacher dashboard
const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
document.getElementById('totalSiswa').textContent = siswaKelas.length;
document.getElementById('totalMapel').textContent = mapelData.length;
document.getElementById('progressPercentage').textContent = '0%';
document.getElementById('totalPenilaian').textContent = '0';
console.log("Teacher dashboard updated");
}
}

// Load subject cards for dashboard
function loadSubjectCards() {
console.log("Loading subject cards");
const container = document.getElementById('subjectCards');
container.innerHTML = '';

if (mapelData.length === 0) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada mata pelajaran tersedia.</div>';
return;
}

mapelData.forEach(mapel => {
const card = document.createElement('div');
card.className = 'subject-card';
card.onclick = () => openSubjectDashboard(mapel);

// Create card HTML
card.innerHTML = `
<div class="subject-header">
<div class="subject-title">${mapel.nama}</div>
<div class="subject-icon">
<i class="fas fa-book"></i>
</div>
</div>
<div class="subject-progress">
<div class="progress-header">
<div class="progress-title">Progress Pengisian Nilai</div>
<div class="progress-percentage">0%</div>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 0%"></div>
</div>
<div style="margin-top: 10px; font-size: 12px;">
<div>PH: 0%</div>
<div>PTS: 0%</div>
<div>SAS: 0%</div>
</div>
</div>
`;

container.appendChild(card);
});
console.log("Subject cards loaded");
}

// Load subjects data
function loadMapelData() {
console.log("Loading mapel data");
showLoading();
database.ref('mapel').once('value')
.then((snapshot) => {
hideLoading();
console.log("Mapel data loaded:", snapshot.exists());
if (snapshot.exists()) {
mapelData = [];
snapshot.forEach((childSnapshot) => {
mapelData.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});
console.log("Mapel data:", mapelData);

// Update subject selects
updateSubjectSelects();

// If we're on the subjects section, update the table
if (document.getElementById('subjects-section').style.display !== 'none') {
updateMapelTable();
}
} else {
mapelData = [];
updateSubjectSelects();
if (document.getElementById('subjects-section').style.display !== 'none') {
updateMapelTable();
}
}
})
.catch((error) => {
hideLoading();
console.error("Error loading mapel data:", error);
showAlert('Error loading subjects: ' + error.message, 'danger');
});
}

// Update subject selects in forms
function updateSubjectSelects() {
const selects = ['pilihMapelPH', 'pilihMapelPTS', 'pilihMapelSAS'];
selects.forEach(selectId => {
const select = document.getElementById(selectId);
if (select) {
select.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
mapelData.forEach(mapel => {
const option = document.createElement('option');
option.value = mapel.id;
option.textContent = mapel.nama;
select.appendChild(option);
});
}
});
}

// Update subjects table
function updateMapelTable() {
const tbody = document.getElementById('tabelMapel');
tbody.innerHTML = '';

if (mapelData.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
return;
}

mapelData.forEach((mapel, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${index + 1}</td>
<td>${mapel.kode}</td>
<td>${mapel.nama}</td>
<td>
<button class="btn btn-sm btn-primary" onclick="editMapel('${mapel.id}')">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusMapel('${mapel.id}')">
<i class="fas fa-trash"></i>
</button>
</td>
`;
tbody.appendChild(row);
});
}

// Load students data
function loadSiswaData() {
console.log("Loading siswa data");
showLoading();
database.ref('siswa').once('value')
.then((snapshot) => {
hideLoading();
console.log("Siswa data loaded:", snapshot.exists());
if (snapshot.exists()) {
siswaData = [];
snapshot.forEach((childSnapshot) => {
siswaData.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});
console.log("Siswa data:", siswaData);

// Update student selects
updateStudentSelects();

// If we're on the students section, update the table
if (document.getElementById('students-section').style.display !== 'none') {
updateSiswaTable();
}
} else {
siswaData = [];
updateStudentSelects();
if (document.getElementById('students-section').style.display !== 'none') {
updateSiswaTable();
}
}
})
.catch((error) => {
hideLoading();
console.error("Error loading siswa data:", error);
showAlert('Error loading students: ' + error.message, 'danger');
});
}

// Load students by class
function loadSiswaByKelas(kelas) {
console.log("Loading siswa by class:", kelas);
showLoading();
database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
.then((snapshot) => {
hideLoading();
console.log("Siswa by class loaded:", snapshot.exists());
if (snapshot.exists()) {
siswaData = [];
snapshot.forEach((childSnapshot) => {
siswaData.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});
console.log("Siswa by class data:", siswaData);

// Update student selects
updateStudentSelects();
} else {
siswaData = [];
updateStudentSelects();
}
})
.catch((error) => {
hideLoading();
console.error("Error loading siswa by class:", error);
showAlert('Error loading students: ' + error.message, 'danger');
});
}

// Update student selects in forms
function updateStudentSelects() {
const select = document.getElementById('pilihSiswaPTS');
if (select) {
select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
siswaData.forEach(siswa => {
const option = document.createElement('option');
option.value = siswa.id;
option.textContent = `${siswa.nis} - ${siswa.nama}`;
select.appendChild(option);
});
}
}

// Update students table
function updateSiswaTable() {
const tbody = document.getElementById('tabelSiswa');
const filterKelas = document.getElementById('filterKelasSiswa').value;
tbody.innerHTML = '';

let filteredSiswa = siswaData;
if (filterKelas) {
filteredSiswa = siswaData.filter(siswa => siswa.kelas === filterKelas);
}

if (filteredSiswa.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
return;
}

filteredSiswa.forEach((siswa, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${siswa.nis}</td>
<td>${siswa.nama}</td>
<td>${siswa.kelas}</td>
<td>
<button class="btn btn-sm btn-primary" onclick="editSiswa('${siswa.id}')">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusSiswa('${siswa.id}')">
<i class="fas fa-trash"></i>
</button>
</td>
`;
tbody.appendChild(row);
});
}

// Filter students by class
function filterSiswa() {
updateSiswaTable();
}

// Load teachers data
function loadGuruData() {
console.log("Loading guru data");
showLoading();
database.ref('guru').once('value')
.then((snapshot) => {
hideLoading();
console.log("Guru data loaded:", snapshot.exists());
if (snapshot.exists()) {
guruData = [];
snapshot.forEach((childSnapshot) => {
guruData.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});
console.log("Guru data:", guruData);

// If we're on the settings section, update the table
if (document.getElementById('settings-section').style.display !== 'none') {
updateGuruTable();
}
} else {
guruData = [];
if (document.getElementById('settings-section').style.display !== 'none') {
updateGuruTable();
}
}
})
.catch((error) => {
hideLoading();
console.error("Error loading guru data:", error);
showAlert('Error loading teachers: ' + error.message, 'danger');
});
}

// Update teachers table
function updateGuruTable() {
const tbody = document.getElementById('tabelGuru');
tbody.innerHTML = '';

if (guruData.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
return;
}

guruData.forEach((guru, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${index + 1}</td>
<td>${guru.username}</td>
<td>${guru.nama}</td>
<td>${guru.kelas}</td>
<td>
<button class="btn btn-sm btn-primary" onclick="editGuru('${guru.id}')">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusGuru('${guru.id}')">
<i class="fas fa-trash"></i>
</button>
</td>
`;
tbody.appendChild(row);
});
}

// Load school logo
function loadLogoSekolah() {
const logoRef = storage.ref('logo_sekolah/logo.png');
logoRef.getDownloadURL()
.then((url) => {
logoSekolahURL = url;
document.getElementById('logoSekolah').src = url;
document.getElementById('logoSekolah').style.display = 'block';
})
.catch((error) => {
// Logo doesn't exist or error loading
console.log('Logo not found or error loading:', error);
});
}

// Load PH data
function loadPHData() {
console.log("Loading PH data");
showLoading();
phData = {};

if (userRole === 'admin') {
// Load all PH data
database.ref('ph').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
phData = snapshot.val();
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading PH data: ' + error.message, 'danger');
});
} else {
// Load PH data for teacher's class
database.ref('ph').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
const allPhData = snapshot.val();
const siswaKelas = siswaData.map(siswa => siswa.nis);
    
// Filter PH data for students in teacher's class
Object.keys(allPhData).forEach(mapelId => {
phData[mapelId] = {};
Object.keys(allPhData[mapelId]).forEach(phId => {
const ph = allPhData[mapelId][phId];
if (siswaKelas.includes(ph.nis)) {
phData[mapelId][phId] = ph;
}
});
});
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading PH data: ' + error.message, 'danger');
});
}
}

// Load PTS data
function loadPTSData() {
console.log("Loading PTS data");
showLoading();
ptsData = {};

if (userRole === 'admin') {
// Load all PTS data
database.ref('pts').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
ptsData = snapshot.val();
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading PTS data: ' + error.message, 'danger');
});
} else {
// Load PTS data for teacher's class
database.ref('pts').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
const allPtsData = snapshot.val();
const siswaKelas = siswaData.map(siswa => siswa.nis);
    
// Filter PTS data for students in teacher's class
Object.keys(allPtsData).forEach(mapelId => {
ptsData[mapelId] = {};
Object.keys(allPtsData[mapelId]).forEach(ptsId => {
const pts = allPtsData[mapelId][ptsId];
if (siswaKelas.includes(pts.nis)) {
ptsData[mapelId][ptsId] = pts;
}
});
});
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading PTS data: ' + error.message, 'danger');
});
}
}

// Load SAS data
function loadSASData() {
console.log("Loading SAS data");
showLoading();
sasData = {};

if (userRole === 'admin') {
// Load all SAS data
database.ref('sas').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
sasData = snapshot.val();
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading SAS data: ' + error.message, 'danger');
});
} else {
// Load SAS data for teacher's class
database.ref('sas').once('value')
.then((snapshot) => {
hideLoading();
if (snapshot.exists()) {
const allSasData = snapshot.val();
const siswaKelas = siswaData.map(siswa => siswa.nis);
    
// Filter SAS data for students in teacher's class
Object.keys(allSasData).forEach(mapelId => {
sasData[mapelId] = {};
Object.keys(allSasData[mapelId]).forEach(sasId => {
const sas = allSasData[mapelId][sasId];
if (siswaKelas.includes(sas.nis)) {
sasData[mapelId][sasId] = sas;
}
});
});
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading SAS data: ' + error.message, 'danger');
});
}
}

// Show section
function showSection(sectionId) {
// Hide all sections
document.querySelectorAll('.content-section').forEach(section => {
section.style.display = 'none';
});

// Show selected section
document.getElementById(sectionId + '-section').style.display = 'block';

// Update active sidebar item
document.querySelectorAll('.sidebar-item').forEach(item => {
item.classList.remove('active');
});
event.target.closest('.sidebar-item').classList.add('active');

// Update content title
const titles = {
'dashboard': 'Dashboard',
'subjects': 'Manajemen Mata Pelajaran',
'students': 'Manajemen Data Siswa',
'ph': 'Penilaian Harian (PH)',
'assessment': 'Penilaian PTS',
'sas': 'Penilaian SAS',
'leger': 'Leger Nilai',
'pts': 'Cetak PTS',
'monitoring': 'Monitoring Pengisian Nilai',
'settings': 'Pengaturan'
};
document.querySelector('.content-title').textContent = titles[sectionId];

// Load section-specific data
if (sectionId === 'subjects' && userRole === 'admin') {
updateMapelTable();
} else if (sectionId === 'students' && userRole === 'admin') {
updateSiswaTable();
} else if (sectionId === 'ph') {
// PH data is already loaded
} else if (sectionId === 'assessment') {
// PTS data is already loaded
} else if (sectionId === 'sas') {
// SAS data is already loaded
} else if (sectionId === 'leger') {
// Load leger data
} else if (sectionId === 'monitoring' && userRole === 'admin') {
loadMonitoringData();
} else if (sectionId === 'settings' && userRole === 'admin') {
updateGuruTable();
}
}

// Logout function
function logout() {
if (confirm('Apakah Anda yakin ingin logout?')) {
currentUser = null;
userRole = null;
userKelas = null;
mapelData = [];
siswaData = [];
guruData = [];
phData = {};
ptsData = {};
sasData = {};
ledgerData = {};
logoSekolahURL = "";
monitoringChart = null;

document.getElementById('mainApp').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
document.getElementById('username').value = '';
document.getElementById('password').value = '';
document.getElementById('kelas').value = '';
}
}

// Modal functions
function bukaModal(modalId) {
document.getElementById(modalId).style.display = 'block';
}

function tutupModal(modalId) {
document.getElementById(modalId).style.display = 'none';
}

// Subject management
function tambahMapel() {
document.getElementById('modalMapelTitle').textContent = 'Tambah Mata Pelajaran';
document.getElementById('mapelId').value = '';
document.getElementById('mapelKode').value = '';
document.getElementById('mapelNama').value = '';
bukaModal('modalMapel');
}

function editMapel(id) {
const mapel = mapelData.find(m => m.id === id);
if (mapel) {
document.getElementById('modalMapelTitle').textContent = 'Edit Mata Pelajaran';
document.getElementById('mapelId').value = mapel.id;
document.getElementById('mapelKode').value = mapel.kode;
document.getElementById('mapelNama').value = mapel.nama;
bukaModal('modalMapel');
}
}

function simpanMapel() {
const id = document.getElementById('mapelId').value;
const kode = document.getElementById('mapelKode').value;
const nama = document.getElementById('mapelNama').value;

if (!kode || !nama) {
showAlert('Kode dan nama mata pelajaran harus diisi!', 'warning');
return;
}

showLoading();
if (id) {
// Update existing subject
database.ref('mapel/' + id).update({
kode: kode,
nama: nama
})
.then(() => {
hideLoading();
tutupModal('modalMapel');
loadMapelData();
showAlert('Mata pelajaran berhasil diperbarui!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
} else {
// Add new subject
database.ref('mapel').push({
kode: kode,
nama: nama
})
.then(() => {
hideLoading();
tutupModal('modalMapel');
loadMapelData();
showAlert('Mata pelajaran berhasil ditambahkan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function hapusMapel(id) {
if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
showLoading();
database.ref('mapel/' + id).remove()
.then(() => {
hideLoading();
loadMapelData();
showAlert('Mata pelajaran berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

// Student management
function tambahSiswa() {
document.getElementById('modalSiswaTitle').textContent = 'Tambah Siswa';
document.getElementById('siswaId').value = '';
document.getElementById('siswaNIS').value = '';
document.getElementById('siswaNama').value = '';
document.getElementById('siswaKelas').value = '';
bukaModal('modalSiswa');
}

function editSiswa(id) {
const siswa = siswaData.find(s => s.id === id);
if (siswa) {
document.getElementById('modalSiswaTitle').textContent = 'Edit Siswa';
document.getElementById('siswaId').value = siswa.id;
document.getElementById('siswaNIS').value = siswa.nis;
document.getElementById('siswaNama').value = siswa.nama;
document.getElementById('siswaKelas').value = siswa.kelas;
bukaModal('modalSiswa');
}
}

function simpanSiswa() {
const id = document.getElementById('siswaId').value;
const nis = document.getElementById('siswaNIS').value;
const nama = document.getElementById('siswaNama').value;
const kelas = document.getElementById('siswaKelas').value;

if (!nis || !nama || !kelas) {
showAlert('NIS, nama, dan kelas harus diisi!', 'warning');
return;
}

showLoading();
if (id) {
// Update existing student
database.ref('siswa/' + id).update({
nis: nis,
nama: nama,
kelas: kelas
})
.then(() => {
hideLoading();
tutupModal('modalSiswa');
loadSiswaData();
showAlert('Data siswa berhasil diperbarui!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
} else {
// Add new student
database.ref('siswa').push({
nis: nis,
nama: nama,
kelas: kelas
})
.then(() => {
hideLoading();
tutupModal('modalSiswa');
loadSiswaData();
showAlert('Data siswa berhasil ditambahkan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function hapusSiswa(id) {
if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
showLoading();
database.ref('siswa/' + id).remove()
.then(() => {
hideLoading();
loadSiswaData();
showAlert('Data siswa berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

// Teacher management
function tambahGuru() {
document.getElementById('modalGuruTitle').textContent = 'Tambah Guru';
document.getElementById('guruId').value = '';
document.getElementById('guruUsername').value = '';
document.getElementById('guruPassword').value = '';
document.getElementById('guruNama').value = '';
document.getElementById('guruKelas').value = '';
bukaModal('modalGuru');
}

function editGuru(id) {
const guru = guruData.find(g => g.id === id);
if (guru) {
document.getElementById('modalGuruTitle').textContent = 'Edit Guru';
document.getElementById('guruId').value = guru.id;
document.getElementById('guruUsername').value = guru.username;
document.getElementById('guruPassword').value = guru.password;
document.getElementById('guruNama').value = guru.nama;
document.getElementById('guruKelas').value = guru.kelas;
bukaModal('modalGuru');
}
}

function simpanGuru() {
const id = document.getElementById('guruId').value;
const username = document.getElementById('guruUsername').value;
const password = document.getElementById('guruPassword').value;
const nama = document.getElementById('guruNama').value;
const kelas = document.getElementById('guruKelas').value;

if (!username || !password || !nama || !kelas) {
showAlert('Semua field harus diisi!', 'warning');
return;
}

showLoading();
if (id) {
// Update existing teacher
database.ref('guru/' + id).update({
username: username,
password: password,
nama: nama,
kelas: kelas
})
.then(() => {
hideLoading();
tutupModal('modalGuru');
loadGuruData();
showAlert('Data guru berhasil diperbarui!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
} else {
// Add new teacher
database.ref('guru').push({
username: username,
password: password,
nama: nama,
kelas: kelas
})
.then(() => {
hideLoading();
tutupModal('modalGuru');
loadGuruData();
showAlert('Data guru berhasil ditambahkan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function hapusGuru(id) {
if (confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
showLoading();
database.ref('guru/' + id).remove()
.then(() => {
hideLoading();
loadGuruData();
showAlert('Data guru berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

// Upload school logo
function uploadLogoSekolah(event) {
const file = event.target.files[0];
if (file) {
showLoading();
const storageRef = storage.ref('logo_sekolah/logo.png');
storageRef.put(file)
.then(() => {
hideLoading();
loadLogoSekolah();
showAlert('Logo sekolah berhasil diupload!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

// PH management
function tampilkanPH() {
const mapelId = document.getElementById('pilihMapelPH').value;
const container = document.getElementById('PHContainer');
container.innerHTML = '';

if (!mapelId) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian harian.</div>';
return;
}

const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) {
container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Mata pelajaran tidak ditemukan!</div>';
return;
}

// Create PH list
const phList = document.createElement('div');
phList.className = 'ph-list';

// Add button to create new PH
const btnContainer = document.createElement('div');
btnContainer.style.marginBottom = '15px';
btnContainer.innerHTML = `
<button class="btn btn-primary" onclick="inputPH('${mapelId}')">
<i class="fas fa-plus"></i> Input Penilaian Harian
</button>
`;
phList.appendChild(btnContainer);

// Get PH data for this subject
if (phData[mapelId]) {
Object.keys(phData[mapelId]).forEach(phId => {
const ph = phData[mapelId][phId];
const phItem = document.createElement('div');
phItem.className = 'ph-item';
phItem.innerHTML = `
<div class="ph-info">
<div>${ph.deskripsi}</div>
<div class="ph-date">${ph.tanggal}</div>
</div>
<div class="ph-actions">
<button class="btn btn-sm btn-info" onclick="detailPH('${mapelId}', '${phId}')">
<i class="fas fa-eye"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusPH('${mapelId}', '${phId}')">
<i class="fas fa-trash"></i>
</button>
</div>
`;
phList.appendChild(phItem);
});
} else {
phList.innerHTML += '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data penilaian harian untuk mata pelajaran ini.</div>';
}

container.appendChild(phList);
}

function inputPH(mapelId) {
const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) return;

document.getElementById('phMapel').value = mapel.nama;
document.getElementById('phTanggal').value = '';
document.getElementById('phDeskripsi').value = '';

// Populate students table
const tbody = document.getElementById('tabelPH');
tbody.innerHTML = '';

// Get students for this teacher
let studentsToShow = siswaData;
if (userRole === 'guru') {
studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
}

if (studentsToShow.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
} else {
studentsToShow.forEach(siswa => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${siswa.nis}</td>
<td>${siswa.nama}</td>
<td>
<input type="number" class="form-control nilai-input" min="0" max="100" data-nis="${siswa.nis}">
</td>
<td>
<input type="text" class="form-control predikat-input" readonly data-nis="${siswa.nis}">
</td>
`;
tbody.appendChild(row);
});

// Add event listeners to nilai inputs
document.querySelectorAll('.nilai-input').forEach(input => {
input.addEventListener('input', function() {
const nilai = parseInt(this.value);
const predikatInput = document.querySelector(`.predikat-input[data-nis="${this.dataset.nis}"]`);
if (predikatInput) {
predikatInput.value = getPredikat(nilai);
}
});
});
}

bukaModal('modalPH');
}

function getPredikat(nilai) {
if (isNaN(nilai)) return '';
if (nilai >= 90) return 'A';
if (nilai >= 80) return 'B';
if (nilai >= 70) return 'C';
if (nilai >= 60) return 'D';
return 'E';
}

function simpanPH() {
const mapelId = document.getElementById('pilihMapelPH').value;
if (!mapelId) {
showAlert('Mata pelajaran tidak valid!', 'danger');
return;
}

const tanggal = document.getElementById('phTanggal').value;
const deskripsi = document.getElementById('phDeskripsi').value;

if (!tanggal || !deskripsi) {
showAlert('Tanggal dan deskripsi harus diisi!', 'warning');
return;
}

// Collect all student data
const phDataArray = [];
const nilaiInputs = document.querySelectorAll('.nilai-input');
let hasData = false;

nilaiInputs.forEach(input => {
const nis = input.dataset.nis;
const nilai = parseInt(input.value) || 0;
const predikat = getPredikat(nilai);

if (nilai > 0) {
hasData = true;
phDataArray.push({
nis: nis,
nilai: nilai,
predikat: predikat
});
}
});

if (!hasData) {
showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
return;
}

showLoading();
// Save PH data to Firebase
const phRef = database.ref('ph/' + mapelId).push();
phRef.set({
tanggal: tanggal,
deskripsi: deskripsi,
data: phDataArray
})
.then(() => {
hideLoading();
tutupModal('modalPH');
loadPHData();
tampilkanPH();
showAlert('Penilaian harian berhasil disimpan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}

function detailPH(mapelId, phId) {
// Implementation for viewing PH details
showAlert('Fitur detail PH belum tersedia', 'info');
}

function hapusPH(mapelId, phId) {
if (confirm('Apakah Anda yakin ingin menghapus data penilaian harian ini?')) {
showLoading();
database.ref('ph/' + mapelId + '/' + phId).remove()
.then(() => {
hideLoading();
loadPHData();
tampilkanPH();
showAlert('Data penilaian harian berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function downloadTemplatePH() {
// Implementation for downloading PH template
showAlert('Fitur download template PH belum tersedia', 'info');
}

function importPHFromExcel(event) {
// Implementation for importing PH from Excel
showAlert('Fitur import PH dari Excel belum tersedia', 'info');
}

function exportPHToExcel() {
// Implementation for exporting PH to Excel
showAlert('Fitur export PH ke Excel belum tersedia', 'info');
}

// PTS management
function tampilkanPTS() {
const mapelId = document.getElementById('pilihMapelPTS').value;
const container = document.getElementById('PTSContainer');
container.innerHTML = '';

if (!mapelId) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.</div>';
return;
}

const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) {
container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Mata pelajaran tidak ditemukan!</div>';
return;
}

// Create PTS list
const ptsList = document.createElement('div');
ptsList.className = 'ph-list';

// Add button to create new PTS
const btnContainer = document.createElement('div');
btnContainer.style.marginBottom = '15px';
btnContainer.innerHTML = `
<button class="btn btn-primary" onclick="inputPTS('${mapelId}')">
<i class="fas fa-plus"></i> Input Nilai PTS
</button>
`;
ptsList.appendChild(btnContainer);

// Get PTS data for this subject
if (ptsData[mapelId]) {
Object.keys(ptsData[mapelId]).forEach(ptsId => {
const pts = ptsData[mapelId][ptsId];
const ptsItem = document.createElement('div');
ptsItem.className = 'ph-item';
ptsItem.innerHTML = `
<div class="ph-info">
<div>Nilai PTS ${mapel.nama}</div>
<div class="ph-date">${pts.tanggal || '-'}</div>
</div>
<div class="ph-actions">
<button class="btn btn-sm btn-info" onclick="detailPTS('${mapelId}', '${ptsId}')">
<i class="fas fa-eye"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusPTS('${mapelId}', '${ptsId}')">
<i class="fas fa-trash"></i>
</button>
</div>
`;
ptsList.appendChild(ptsItem);
});
} else {
ptsList.innerHTML += '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data penilaian PTS untuk mata pelajaran ini.</div>';
}

container.appendChild(ptsList);
}

function inputPTS(mapelId) {
const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) return;

document.getElementById('ptsMapel').value = mapel.nama;

// Populate students table
const tbody = document.getElementById('tabelPTS');
tbody.innerHTML = '';

// Get students for this teacher
let studentsToShow = siswaData;
if (userRole === 'guru') {
studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
}

if (studentsToShow.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
} else {
studentsToShow.forEach(siswa => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${siswa.nis}</td>
<td>${siswa.nama}</td>
<td>
<input type="number" class="form-control nilai-input" min="0" max="100" data-nis="${siswa.nis}">
</td>
<td>
<input type="text" class="form-control predikat-input" readonly data-nis="${siswa.nis}">
</td>
`;
tbody.appendChild(row);
});

// Add event listeners to nilai inputs
document.querySelectorAll('.nilai-input').forEach(input => {
input.addEventListener('input', function() {
const nilai = parseInt(this.value);
const predikatInput = document.querySelector(`.predikat-input[data-nis="${this.dataset.nis}"]`);
if (predikatInput) {
predikatInput.value = getPredikat(nilai);
}
});
});
}

bukaModal('modalPTS');
}

function simpanPTS() {
const mapelId = document.getElementById('pilihMapelPTS').value;
if (!mapelId) {
showAlert('Mata pelajaran tidak valid!', 'danger');
return;
}

// Collect all student data
const ptsDataArray = [];
const nilaiInputs = document.querySelectorAll('#tabelPTS .nilai-input');
let hasData = false;

nilaiInputs.forEach(input => {
const nis = input.dataset.nis;
const nilai = parseInt(input.value) || 0;
const predikat = getPredikat(nilai);

if (nilai > 0) {
hasData = true;
ptsDataArray.push({
nis: nis,
nilai: nilai,
predikat: predikat
});
}
});

if (!hasData) {
showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
return;
}

showLoading();
// Save PTS data to Firebase
const ptsRef = database.ref('pts/' + mapelId).push();
ptsRef.set({
tanggal: new Date().toISOString().split('T')[0],
data: ptsDataArray
})
.then(() => {
hideLoading();
tutupModal('modalPTS');
loadPTSData();
tampilkanPTS();
showAlert('Nilai PTS berhasil disimpan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}

function detailPTS(mapelId, ptsId) {
// Implementation for viewing PTS details
showAlert('Fitur detail PTS belum tersedia', 'info');
}

function hapusPTS(mapelId, ptsId) {
if (confirm('Apakah Anda yakin ingin menghapus data penilaian PTS ini?')) {
showLoading();
database.ref('pts/' + mapelId + '/' + ptsId).remove()
.then(() => {
hideLoading();
loadPTSData();
tampilkanPTS();
showAlert('Data penilaian PTS berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function downloadTemplatePTS() {
// Implementation for downloading PTS template
showAlert('Fitur download template PTS belum tersedia', 'info');
}

function importPTSFromExcel(event) {
// Implementation for importing PTS from Excel
showAlert('Fitur import PTS dari Excel belum tersedia', 'info');
}

function exportPTSToExcel() {
// Implementation for exporting PTS to Excel
showAlert('Fitur export PTS ke Excel belum tersedia', 'info');
}

// SAS management
function tampilkanSAS() {
const mapelId = document.getElementById('pilihMapelSAS').value;
const container = document.getElementById('SASContainer');
container.innerHTML = '';

if (!mapelId) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian SAS.</div>';
return;
}

const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) {
container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Mata pelajaran tidak ditemukan!</div>';
return;
}

// Create SAS list
const sasList = document.createElement('div');
sasList.className = 'ph-list';

// Add button to create new SAS
const btnContainer = document.createElement('div');
btnContainer.style.marginBottom = '15px';
btnContainer.innerHTML = `
<button class="btn btn-primary" onclick="inputSAS('${mapelId}')">
<i class="fas fa-plus"></i> Input Nilai SAS
</button>
`;
sasList.appendChild(btnContainer);

// Get SAS data for this subject
if (sasData[mapelId]) {
Object.keys(sasData[mapelId]).forEach(sasId => {
const sas = sasData[mapelId][sasId];
const sasItem = document.createElement('div');
sasItem.className = 'ph-item';
sasItem.innerHTML = `
<div class="ph-info">
<div>Nilai SAS ${mapel.nama}</div>
<div class="ph-date">${sas.tanggal || '-'}</div>
</div>
<div class="ph-actions">
<button class="btn btn-sm btn-info" onclick="detailSAS('${mapelId}', '${sasId}')">
<i class="fas fa-eye"></i>
</button>
<button class="btn btn-sm btn-danger" onclick="hapusSAS('${mapelId}', '${sasId}')">
<i class="fas fa-trash"></i>
</button>
</div>
`;
sasList.appendChild(sasItem);
});
} else {
sasList.innerHTML += '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data penilaian SAS untuk mata pelajaran ini.</div>';
}

container.appendChild(sasList);
}

function inputSAS(mapelId) {
const mapel = mapelData.find(m => m.id === mapelId);
if (!mapel) return;

document.getElementById('sasMapel').value = mapel.nama;

// Populate students table
const tbody = document.getElementById('tabelSAS');
tbody.innerHTML = '';

// Get students for this teacher
let studentsToShow = siswaData;
if (userRole === 'guru') {
studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
}

if (studentsToShow.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
} else {
studentsToShow.forEach(siswa => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${siswa.nis}</td>
<td>${siswa.nama}</td>
<td>
<input type="number" class="form-control nilai-input" min="0" max="100" data-nis="${siswa.nis}">
</td>
<td>
<input type="text" class="form-control predikat-input" readonly data-nis="${siswa.nis}">
</td>
`;
tbody.appendChild(row);
});

// Add event listeners to nilai inputs
document.querySelectorAll('.nilai-input').forEach(input => {
input.addEventListener('input', function() {
const nilai = parseInt(this.value);
const predikatInput = document.querySelector(`.predikat-input[data-nis="${this.dataset.nis}"]`);
if (predikatInput) {
predikatInput.value = getPredikat(nilai);
}
});
});
}

bukaModal('modalSAS');
}

function simpanSAS() {
const mapelId = document.getElementById('pilihMapelSAS').value;
if (!mapelId) {
showAlert('Mata pelajaran tidak valid!', 'danger');
return;
}

// Collect all student data
const sasDataArray = [];
const nilaiInputs = document.querySelectorAll('#tabelSAS .nilai-input');
let hasData = false;

nilaiInputs.forEach(input => {
const nis = input.dataset.nis;
const nilai = parseInt(input.value) || 0;
const predikat = getPredikat(nilai);

if (nilai > 0) {
hasData = true;
sasDataArray.push({
nis: nis,
nilai: nilai,
predikat: predikat
});
}
});

if (!hasData) {
showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
return;
}

showLoading();
// Save SAS data to Firebase
const sasRef = database.ref('sas/' + mapelId).push();
sasRef.set({
tanggal: new Date().toISOString().split('T')[0],
data: sasDataArray
})
.then(() => {
hideLoading();
tutupModal('modalSAS');
loadSASData();
tampilkanSAS();
showAlert('Nilai SAS berhasil disimpan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}

function detailSAS(mapelId, sasId) {
// Implementation for viewing SAS details
showAlert('Fitur detail SAS belum tersedia', 'info');
}

function hapusSAS(mapelId, sasId) {
if (confirm('Apakah Anda yakin ingin menghapus data penilaian SAS ini?')) {
showLoading();
database.ref('sas/' + mapelId + '/' + sasId).remove()
.then(() => {
hideLoading();
loadSASData();
tampilkanSAS();
showAlert('Data penilaian SAS berhasil dihapus!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}
}

function downloadTemplateSAS() {
// Implementation for downloading SAS template
showAlert('Fitur download template SAS belum tersedia', 'info');
}

function importSASFromExcel(event) {
// Implementation for importing SAS from Excel
showAlert('Fitur import SAS dari Excel belum tersedia', 'info');
}

function exportSASToExcel() {
// Implementation for exporting SAS to Excel
showAlert('Fitur export SAS ke Excel belum tersedia', 'info');
}

// Leger management
function tampilkanLeger() {
const kelas = document.getElementById('filterKelasLeger').value;
const container = document.getElementById('legerContainer');
container.innerHTML = '';

if (!kelas) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger nilai.</div>';
return;
}

// Get students for this class
const studentsInClass = siswaData.filter(siswa => siswa.kelas === kelas);
if (studentsInClass.length === 0) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada data siswa untuk kelas ini.</div>';
return;
}

// Create leger table
const table = document.createElement('table');
table.className = 'table leger-table';

// Create header
const thead = document.createElement('thead');
const headerRow1 = document.createElement('tr');
headerRow1.innerHTML = `
<th rowspan="2">No</th>
<th rowspan="2">NIS</th>
<th rowspan="2">Nama Siswa</th>
<th colspan="${mapelData.length * 3}">Nilai Per Mata Pelajaran</th>
`;
thead.appendChild(headerRow1);

const headerRow2 = document.createElement('tr');
headerRow2.id = 'legerHeader';
mapelData.forEach(mapel => {
const thPH = document.createElement('th');
thPH.textContent = 'PH';
thPH.className = 'assessment-type';
headerRow2.appendChild(thPH);

const thPTS = document.createElement('th');
thPTS.textContent = 'PTS';
thPTS.className = 'assessment-type';
headerRow2.appendChild(thPTS);

const thSAS = document.createElement('th');
thSAS.textContent = 'SAS';
thSAS.className = 'assessment-type';
headerRow2.appendChild(thSAS);
});
thead.appendChild(headerRow2);
table.appendChild(thead);

// Create body
const tbody = document.createElement('tbody');
studentsInClass.forEach((siswa, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${index + 1}</td>
<td>${siswa.nis}</td>
<td class="student-name">${siswa.nama}</td>
`;

// Add cells for each subject
mapelData.forEach(mapel => {
// PH cell
const phCell = document.createElement('td');
phCell.textContent = getNilaiFromData(phData, mapel.id, siswa.nis) || '-';
row.appendChild(phCell);

// PTS cell
const ptsCell = document.createElement('td');
ptsCell.textContent = getNilaiFromData(ptsData, mapel.id, siswa.nis) || '-';
row.appendChild(ptsCell);

// SAS cell
const sasCell = document.createElement('td');
sasCell.textContent = getNilaiFromData(sasData, mapel.id, siswa.nis) || '-';
row.appendChild(sasCell);
});

tbody.appendChild(row);
});
table.appendChild(tbody);

container.appendChild(table);

// Add input button
const btnContainer = document.createElement('div');
btnContainer.style.marginTop = '15px';
btnContainer.innerHTML = `
<button class="btn btn-primary" onclick="inputLeger('${kelas}')">
<i class="fas fa-edit"></i> Input Nilai Leger
</button>
`;
container.appendChild(btnContainer);
}

function getNilaiFromData(data, mapelId, nis) {
if (!data[mapelId]) return null;

// Find the assessment data for this student
for (const assessmentId in data[mapelId]) {
const assessment = data[mapelId][assessmentId];
if (assessment.data) {
const studentData = assessment.data.find(d => d.nis === nis);
if (studentData) {
return studentData.nilai;
}
}
}

return null;
}

function inputLeger(kelas) {
// Get students for this class
const studentsInClass = siswaData.filter(siswa => siswa.kelas === kelas);
if (studentsInClass.length === 0) {
showAlert('Tidak ada data siswa untuk kelas ini!', 'warning');
return;
}

// Populate leger header
const headerRow = document.getElementById('legerHeader');
headerRow.innerHTML = '';

mapelData.forEach(mapel => {
const thMapel = document.createElement('th');
thMapel.textContent = mapel.nama;
thMapel.colSpan = 3;
thMapel.className = 'subject-header';
headerRow.appendChild(thMapel);
});

// Add assessment type row
const assessmentRow = document.createElement('tr');
mapelData.forEach(() => {
const thPH = document.createElement('th');
thPH.textContent = 'PH';
thPH.className = 'assessment-type';
assessmentRow.appendChild(thPH);

const thPTS = document.createElement('th');
thPTS.textContent = 'PTS';
thPTS.className = 'assessment-type';
assessmentRow.appendChild(thPTS);

const thSAS = document.createElement('th');
thSAS.textContent = 'SAS';
thSAS.className = 'assessment-type';
assessmentRow.appendChild(thSAS);
});
headerRow.parentNode.insertBefore(assessmentRow, headerRow.nextSibling);

// Populate students table
const tbody = document.getElementById('tabelLeger');
tbody.innerHTML = '';

studentsInClass.forEach((siswa, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${index + 1}</td>
<td>${siswa.nis}</td>
<td class="student-name">${siswa.nama}</td>
`;

// Add cells for each subject
mapelData.forEach(mapel => {
// PH cell
const phCell = document.createElement('td');
phCell.innerHTML = `<input type="number" class="form-control" min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" data-type="ph" value="${getNilaiFromData(phData, mapel.id, siswa.nis) || ''}">`;
row.appendChild(phCell);

// PTS cell
const ptsCell = document.createElement('td');
ptsCell.innerHTML = `<input type="number" class="form-control" min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" data-type="pts" value="${getNilaiFromData(ptsData, mapel.id, siswa.nis) || ''}">`;
row.appendChild(ptsCell);

// SAS cell
const sasCell = document.createElement('td');
sasCell.innerHTML = `<input type="number" class="form-control" min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" data-type="sas" value="${getNilaiFromData(sasData, mapel.id, siswa.nis) || ''}">`;
row.appendChild(sasCell);
});

tbody.appendChild(row);
});

bukaModal('modalLeger');
}

function simpanLeger() {
// Collect all data from the table
const inputs = document.querySelectorAll('#tabelLeger input[type="number"]');
const updates = {};

inputs.forEach(input => {
const mapelId = input.dataset.mapel;
const nis = input.dataset.nis;
const type = input.dataset.type;
const nilai = parseInt(input.value) || 0;

if (nilai > 0) {
if (!updates[mapelId]) {
updates[mapelId] = {};
}

if (!updates[mapelId][type]) {
updates[mapelId][type] = {};
}

updates[mapelId][type][nis] = {
nilai: nilai,
predikat: getPredikat(nilai)
};
}
});

if (Object.keys(updates).length === 0) {
showAlert('Tidak ada data yang disimpan!', 'warning');
return;
}

showLoading();
// Save all data to Firebase
const promises = [];

Object.keys(updates).forEach(mapelId => {
Object.keys(updates[mapelId]).forEach(type => {
const data = {
tanggal: new Date().toISOString().split('T')[0],
data: Object.keys(updates[mapelId][type]).map(nis => ({
nis: nis,
...updates[mapelId][type][nis]
}))
};

const ref = database.ref(type + '/' + mapelId).push();
promises.push(ref.set(data));
});
});

Promise.all(promises)
.then(() => {
hideLoading();
tutupModal('modalLeger');
loadPHData();
loadPTSData();
loadSASData();
tampilkanLeger();
showAlert('Nilai leger berhasil disimpan!', 'success');
})
.catch((error) => {
hideLoading();
showAlert('Error: ' + error.message, 'danger');
});
}

function downloadLegerTemplate() {
// Implementation for downloading leger template
showAlert('Fitur download template leger belum tersedia', 'info');
}

function importLegerFromExcel(event) {
// Implementation for importing leger from Excel
showAlert('Fitur import leger dari Excel belum tersedia', 'info');
}

function exportLegerToExcel() {
// Implementation for exporting leger to Excel
showAlert('Fitur export leger ke Excel belum tersedia', 'info');
}

// PTS Report
function tampilkanReportPTS() {
const siswaId = document.getElementById('pilihSiswaPTS').value;
const container = document.getElementById('reportPTSContainer');
container.innerHTML = '';

if (!siswaId) {
container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih siswa untuk melihat laporan PTS.</div>';
return;
}

const siswa = siswaData.find(s => s.id === siswaId);
if (!siswa) {
container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Siswa tidak ditemukan!</div>';
return;
}

// Create PTS report
const rapor = document.createElement('div');
rapor.className = 'rapor no-print';

// Header
const header = document.createElement('div');
header.className = 'rapor-header';
header.innerHTML = `
${logoSekolahURL ? `<img src="${logoSekolahURL}" alt="Logo Sekolah" class="rapor-logo">` : ''}
<div class="rapor-title">LAPORAN PENILAIAN TENGAH SEMESTER (PTS)</div>
<div class="rapor-subtitle">SD NEGERI SALSABILA KLASEMAN</div>
`;
rapor.appendChild(header);

// Student info
const info = document.createElement('div');
info.className = 'rapor-info';
info.innerHTML = `
<p><strong>Nama Siswa:</strong> ${siswa.nama}</p>
<p><strong>NIS:</strong> ${siswa.nis}</p>
<p><strong>Kelas:</strong> ${siswa.kelas}</p>
<p><strong>Semester:</strong> Ganjil</p>
<p><strong>Tahun Pelajaran:</strong> 2023/2024</p>
`;
rapor.appendChild(info);

// Subjects table
const section = document.createElement('div');
section.className = 'rapor-section';
section.innerHTML = '<div class="rapor-section-title">Nilai PTS</div>';

const table = document.createElement('table');
table.className = 'rapor-table';
table.innerHTML = `
<thead>
<tr>
<th>No</th>
<th>Mata Pelajaran</th>
<th>Nilai</th>
<th>Predikat</th>
</tr>
</thead>
<tbody>
`;

mapelData.forEach((mapel, index) => {
const nilai = getNilaiFromData(ptsData, mapel.id, siswa.nis) || '-';
const predikat = nilai !== '-' ? getPredikat(nilai) : '-';
table.innerHTML += `
<tr>
<td>${index + 1}</td>
<td>${mapel.nama}</td>
<td>${nilai}</td>
<td>${predikat}</td>
</tr>
`;
});

table.innerHTML += '</tbody>';
section.appendChild(table);
rapor.appendChild(section);

// Signature
const signature = document.createElement('div');
signature.className = 'rapor-signature';
signature.innerHTML = `
<div class="rapor-signature-box">
<div>Mengetahui,</div>
<div>Kepala Sekolah</div>
<div class="rapor-signature-line"></div>
<div>NIP. 123456789</div>
</div>
<div class="rapor-signature-box">
<div>${userKelas ? `Wali Kelas ${userKelas}` : 'Guru Mata Pelajaran'}</div>
<div class="rapor-signature-line"></div>
<div>NIP. 987654321</div>
</div>
`;
rapor.appendChild(signature);

container.appendChild(rapor);
}

// Monitoring
function loadMonitoringData() {
showLoading();
const progressList = document.getElementById('progressList');
progressList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Loading progress data...</div>';

// Get all teachers
database.ref('guru').once('value')
.then((snapshot) => {
if (snapshot.exists()) {
const teachers = [];
snapshot.forEach((childSnapshot) => {
teachers.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});

// Get all students
database.ref('siswa').once('value')
.then((snapshot) => {
if (snapshot.exists()) {
const students = [];
snapshot.forEach((childSnapshot) => {
students.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});

// Get all subjects
database.ref('mapel').once('value')
.then((snapshot) => {
if (snapshot.exists()) {
const subjects = [];
snapshot.forEach((childSnapshot) => {
subjects.push({
id: childSnapshot.key,
...childSnapshot.val()
});
});

// Calculate progress for each teacher
const teacherProgress = [];
const promises = [];

teachers.forEach(teacher => {
const promise = new Promise((resolve) => {
// Get students for this teacher's class
const teacherStudents = students.filter(s => s.kelas === teacher.kelas);
const totalStudents = teacherStudents.length;
let completedAssessments = 0;
let totalAssessments = 0;

// Calculate progress for each subject
const subjectPromises = [];
subjects.forEach(subject => {
const subjectPromise = new Promise((resolveSubject) => {
// Get PH data
database.ref('ph/' + subject.id).once('value').then((snapshot) => {
let phCount = 0;
if (snapshot.exists()) {
const phData = snapshot.val();
phCount = Object.values(phData).filter(ph => {
return teacherStudents.some(s => s.nis === ph.nis);
}).length;
}

// Get PTS data
database.ref('pts/' + subject.id).once('value').then((snapshot) => {
let ptsCount = 0;
if (snapshot.exists()) {
const ptsData = snapshot.val();
ptsCount = Object.values(ptsData).filter(pts => {
return teacherStudents.some(s => s.nis === pts.nis);
}).length;
}

// Get SAS data
database.ref('sas/' + subject.id).once('value').then((snapshot) => {
let sasCount = 0;
if (snapshot.exists()) {
const sasData = snapshot.val();
sasCount = Object.values(sasData).filter(sas => {
return teacherStudents.some(s => s.nis === sas.nis);
}).length;
}

totalAssessments += totalStudents * 3; // PH, PTS, SAS for each student
completedAssessments += phCount + ptsCount + sasCount;

resolveSubject();
});
});
});
});

subjectPromises.push(subjectPromise);
});

Promise.all(subjectPromises).then(() => {
const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;
teacherProgress.push({
name: teacher.nama,
kelas: teacher.kelas,
progress: progressPercentage,
completed: completedAssessments,
total: totalAssessments
});
resolve();
});
});
});

promises.push(promise);
});

Promise.all(promises).then(() => {
hideLoading();
updateMonitoringChart(teacherProgress);
updateProgressList(teacherProgress);
});
} else {
hideLoading();
progressList.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Tidak ada data mata pelajaran!</div>';
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading subjects: ' + error.message, 'danger');
});
} else {
hideLoading();
progressList.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Tidak ada data siswa!</div>';
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading students: ' + error.message, 'danger');
});
} else {
hideLoading();
progressList.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Tidak ada data guru!</div>';
}
})
.catch((error) => {
hideLoading();
showAlert('Error loading teachers: ' + error.message, 'danger');
});
}

function updateMonitoringChart(teacherProgress) {
const ctx = document.getElementById('monitoringChart').getContext('2d');
    
if (monitoringChart) {
monitoringChart.destroy();
}

monitoringChart = new Chart(ctx, {
type: 'bar',
data: {
labels: teacherProgress.map(t => t.name),
datasets: [{
label: 'Progress Pengisian Nilai (%)',
data: teacherProgress.map(t => t.progress),
backgroundColor: 'rgba(78, 115, 223, 0.8)',
borderColor: 'rgba(78, 115, 223, 1)',
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
max: 100,
ticks: {
callback: function(value) {
return value + '%';
}
}
}
},
plugins: {
tooltip: {
callbacks: {
label: function(context) {
const teacher = teacherProgress[context.dataIndex];
return [
'Progress: ' + teacher.progress + '%',
'Selesai: ' + teacher.completed + '/' + teacher.total
];
}
}
}
}
}
});
}

function updateProgressList(teacherProgress) {
const progressList = document.getElementById('progressList');
progressList.innerHTML = '';

teacherProgress.forEach(teacher => {
const progressItem = document.createElement('div');
progressItem.className = 'progress-item';
progressItem.innerHTML = `
<div class="progress-header">
<div class="progress-title">${teacher.name} (${teacher.kelas})</div>
<div class="progress-percentage">${teacher.progress}%</div>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width: ${teacher.progress}%"></div>
</div>
`;
progressList.appendChild(progressItem);
});
}

// Download template for students
function downloadTemplate() {
// Create a new workbook
const wb = XLSX.utils.book_new();
const ws_data = [
['NIS', 'Nama Siswa', 'Kelas'],
['12345', 'Contoh Siswa', '1A']
];
const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
XLSX.writeFile(wb, "Template_Data_Siswa.xlsx");
showAlert('Template berhasil diunduh!', 'success');
}

// Import students from Excel
function importSiswaFromExcel(event) {
const file = event.target.files[0];
if (!file) return;

showLoading();
const reader = new FileReader();
reader.onload = function(e) {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {type: 'array'});
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet);

// Process the data
let successCount = 0;
let errorCount = 0;
const promises = [];

jsonData.forEach(row => {
if (row.NIS && row.Nama && row.Kelas) {
const promise = database.ref('siswa').push({
nis: row.NIS,
nama: row.Nama,
kelas: row.Kelas
})
.then(() => {
successCount++;
})
.catch(() => {
errorCount++;
});
promises.push(promise);
} else {
errorCount++;
}
});

Promise.all(promises)
.then(() => {
hideLoading();
loadSiswaData();
showAlert(`Import selesai! Berhasil: ${successCount}, Gagal: ${errorCount}`, 'success');
})
.catch(() => {
hideLoading();
showAlert('Terjadi kesalahan saat mengimpor data!', 'danger');
});
} catch (error) {
hideLoading();
showAlert('Format file tidak valid!', 'danger');
}
};
reader.readAsArrayBuffer(file);
}

// Open subject dashboard
function openSubjectDashboard(mapel) {
// Implementation for opening subject dashboard
showAlert(`Dashboard untuk ${mapel.nama} belum tersedia`, 'info');
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
console.log("DOM loaded");
// Check if user is already logged in (from localStorage)
const savedUser = localStorage.getItem('currentUser');
if (savedUser) {
try {
currentUser = JSON.parse(savedUser);
userRole = currentUser.role;
if (userRole === 'guru') {
userKelas = currentUser.kelas;
}
console.log("User found in localStorage:", currentUser);
showMainApp();
if (userRole === 'admin') {
loadAdminData();
} else {
loadTeacherData();
}
} catch (error) {
console.error('Error parsing saved user:', error);
}
}
});

// Save user to localStorage on login
function saveUserToLocalStorage() {
if (currentUser) {
localStorage.setItem('currentUser', JSON.stringify(currentUser));
}
}

// Modify the showMainApp function to save user to localStorage
const originalShowMainApp = showMainApp;
showMainApp = function() {
originalShowMainApp();
saveUserToLocalStorage();
};

// Modify the logout function to remove user from localStorage
const originalLogout = logout;
logout = function() {
localStorage.removeItem('currentUser');
originalLogout();
};
</script>
</body>
</html>
