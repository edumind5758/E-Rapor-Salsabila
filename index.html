<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rapor Salsabila Klaseman</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-size: 14px;
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
        }

        .sidebar-brand {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        /* Main Content */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e3e6f0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #d1d3e2;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-block;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2e59d9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #17a673;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #dda20a;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #2c9faf;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e3e6f0;
        }

        .table th {
            background-color: #f8f9fc;
            font-weight: 600;
            color: var(--primary-color);
            border-top: none;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e3e6f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e3e6f0;
            display: flex;
            justify-content: flex-end;
        }

        /* Rapor */
        .rapor {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
        }

        .rapor-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .rapor-logo {
            position: absolute;
            top: 0;
            left: 0;
            width: 80px;
            height: 80px;
        }

        .rapor-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rapor-subtitle {
            font-size: 18px;
            color: var(--secondary-color);
        }

        .rapor-info {
            margin-bottom: 20px;
        }

        .rapor-info p {
            margin-bottom: 5px;
        }

        .rapor-section {
            margin-bottom: 20px;
        }

        .rapor-section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .rapor-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .rapor-table th, .rapor-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .rapor-table th {
            background-color: #f2f2f2;
        }

        .rapor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .rapor-signature-box {
            text-align: center;
            width: 45%;
        }

        .rapor-signature-line {
            height: 1px;
            background-color: black;
            margin: 40px 0 5px;
        }

        /* Subject Cards */
        .subject-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .subject-icon {
            font-size: 24px;
            color: var(--primary-color);
        }

        .subject-progress {
            margin-top: 10px;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .content {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .close-alert {
            float: right;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Login Form */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 30px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .role-selector {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .role-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 1px solid #d1d3e2;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Template Download */
        .template-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .template-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .template-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .template-description {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        /* Progress Monitoring */
        .progress-item {
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-title {
            font-weight: 600;
        }

        .progress-percentage {
            color: var(--secondary-color);
        }

        /* PH List */
        .ph-list {
            margin-bottom: 15px;
        }

        .ph-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e3e6f0;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .ph-info {
            flex: 1;
        }

        .ph-date {
            color: var(--secondary-color);
            font-size: 12px;
        }

        .ph-actions {
            display: flex;
            gap: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e3e6f0;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Leger Table */
        .leger-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .leger-table th, .leger-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .leger-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        .leger-table .student-name {
            text-align: left;
        }

        .leger-table .subject-header {
            background-color: #e9ecef;
            font-weight: 600;
        }

        .leger-table .assessment-type {
            background-color: #f8f9fc;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Memproses data...</p>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-title">E-Rapor Salsabila Klaseman</div>
                <p>Silakan login untuk melanjutkan</p>
            </div>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                </div>
                <div class="form-group">
                    <label>Pilih Role</label>
                    <div class="role-selector">
                        <div class="role-option active" data-role="admin">Admin</div>
                        <div class="role-option" data-role="guru">Guru Kelas</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="kelas">Kelas (untuk Guru)</label>
                    <select id="kelas" class="form-control">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="1A">Kelas 1A</option>
                        <option value="1B">Kelas 1B</option>
                        <option value="1C">Kelas 1C</option>
                        <option value="2A">Kelas 2A</option>
                        <option value="2B">Kelas 2B</option>
                        <option value="2C">Kelas 2C</option>
                        <option value="3A">Kelas 3A</option>
                        <option value="3B">Kelas 3B</option>
                        <option value="3C">Kelas 3C</option>
                        <option value="4A">Kelas 4A</option>
                        <option value="4B">Kelas 4B</option>
                        <option value="4C">Kelas 4C</option>
                        <option value="5A">Kelas 5A</option>
                        <option value="5B">Kelas 5B</option>
                        <option value="5C">Kelas 5C</option>
                        <option value="6A">Kelas 6A</option>
                        <option value="6B">Kelas 6B</option>
                        <option value="6C">Kelas 6C</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="wrapper" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-graduation-cap"></i> E-Rapor Salsabila
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </div>
                <div class="sidebar-item" onclick="showSection('subjects')" id="subjectsMenu" style="display: none;">
                    <i class="fas fa-book"></i> Mata Pelajaran
                </div>
                <div class="sidebar-item" onclick="showSection('students')" id="studentsMenu" style="display: none;">
                    <i class="fas fa-users"></i> Data Siswa
                </div>
                <div class="sidebar-item" onclick="showSection('ph')" id="phMenu">
                    <i class="fas fa-clipboard-list"></i> Penilaian Harian
                </div>
                <div class="sidebar-item" onclick="showSection('assessment')" id="assessmentMenu">
                    <i class="fas fa-clipboard-list"></i> Penilaian PTS
                </div>
                <div class="sidebar-item" onclick="showSection('sas')" id="sasMenu">
                    <i class="fas fa-clipboard-list"></i> Penilaian SAS
                </div>
                <div class="sidebar-item" onclick="showSection('leger')" id="legerMenu">
                    <i class="fas fa-table"></i> Leger Nilai
                </div>
                <div class="sidebar-item" onclick="showSection('pts')" id="ptsMenu">
                    <i class="fas fa-file-alt"></i> Cetak PTS
                </div>
                <div class="sidebar-item" onclick="showSection('monitoring')" id="monitoringMenu" style="display: none;">
                    <i class="fas fa-chart-line"></i> Monitoring
                </div>
                <div class="sidebar-item" onclick="showSection('settings')" id="settingsMenu" style="display: none;">
                    <i class="fas fa-cog"></i> Pengaturan
                </div>
                <div class="sidebar-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="content-header">
                <h1 class="content-title">Dashboard</h1>
                <div class="user-info">
                    <span id="userInfo">Admin</span>
                    <img src="https://i.imgur.com/0DQ3Q4V.jpg" alt="User">
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Siswa</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSiswa">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-users fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mata Pelajaran</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMapel">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-book fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Penilaian Selesai</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPenilaian">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Progress</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="progressPercentage">0%</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subject Cards -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Mata Pelajaran</h6>
                    </div>
                    <div class="card-body">
                        <div id="subjectCards">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk menginput nilai.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subjects Section (Admin Only) -->
            <div id="subjects-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Manajemen Mata Pelajaran</h6>
                        <button class="btn btn-primary btn-sm" onclick="tambahMapel()">
                            <i class="fas fa-plus"></i> Tambah Mata Pelajaran
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Kode</th>
                                        <th>Nama Mata Pelajaran</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelMapel">
                                    <tr>
                                        <td colspan="4" class="text-center">Tidak ada data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section (Admin Only) -->
            <div id="students-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Manajemen Data Siswa</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importSiswa" onchange="importSiswaFromExcel(event)" style="display: none;">
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="filterKelasSiswa">Filter Kelas</label>
                            <select id="filterKelasSiswa" class="form-control" onchange="filterSiswa()">
                                <option value="">-- Semua Kelas --</option>
                                <option value="1A">Kelas 1A</option>
                                <option value="1B">Kelas 1B</option>
                                <option value="1C">Kelas 1C</option>
                                <option value="2A">Kelas 2A</option>
                                <option value="2B">Kelas 2B</option>
                                <option value="2C">Kelas 2C</option>
                                <option value="3A">Kelas 3A</option>
                                <option value="3B">Kelas 3B</option>
                                <option value="3C">Kelas 3C</option>
                                <option value="4A">Kelas 4A</option>
                                <option value="4B">Kelas 4B</option>
                                <option value="4C">Kelas 4C</option>
                                <option value="5A">Kelas 5A</option>
                                <option value="5B">Kelas 5B</option>
                                <option value="5C">Kelas 5C</option>
                                <option value="6A">Kelas 6A</option>
                                <option value="6B">Kelas 6B</option>
                                <option value="6C">Kelas 6C</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelSiswa">
                                    <tr>
                                        <td colspan="4" class="text-center">Tidak ada data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PH Section -->
            <div id="ph-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Penilaian Harian (PH)</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplatePH()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importPH" onchange="importPHFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="exportPHToExcel()">
                                <i class="fas fa-file-export"></i> Export ke Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihMapelPH">Pilih Mata Pelajaran</label>
                            <select id="pilihMapelPH" class="form-control" onchange="tampilkanPH()">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                        <div id="PHContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian harian.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Section -->
            <div id="assessment-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Penilaian PTS</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplatePTS()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importPTS" onchange="importPTSFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="exportPTSToExcel()">
                                <i class="fas fa-file-export"></i> Export ke Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihMapelPTS">Pilih Mata Pelajaran</label>
                            <select id="pilihMapelPTS" class="form-control" onchange="tampilkanPTS()">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                        <div id="PTSContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAS Section -->
            <div id="sas-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Penilaian SAS</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadTemplateSAS()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importSAS" onchange="importSASFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="exportSASToExcel()">
                                <i class="fas fa-file-export"></i> Export ke Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihMapelSAS">Pilih Mata Pelajaran</label>
                            <select id="pilihMapelSAS" class="form-control" onchange="tampilkanSAS()">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                        <div id="SASContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian SAS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leger Section -->
            <div id="leger-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Leger Nilai</h6>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="downloadLegerTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <label class="btn btn-info btn-sm">
                                <i class="fas fa-file-import"></i> Import dari Excel
                                <input type="file" id="importLeger" onchange="importLegerFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="exportLegerToExcel()">
                                <i class="fas fa-file-export"></i> Export ke Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="filterKelasLeger">Filter Kelas</label>
                            <select id="filterKelasLeger" class="form-control" onchange="tampilkanLeger()">
                                <option value="">-- Semua Kelas --</option>
                                <option value="1A">Kelas 1A</option>
                                <option value="1B">Kelas 1B</option>
                                <option value="1C">Kelas 1C</option>
                                <option value="2A">Kelas 2A</option>
                                <option value="2B">Kelas 2B</option>
                                <option value="2C">Kelas 2C</option>
                                <option value="3A">Kelas 3A</option>
                                <option value="3B">Kelas 3B</option>
                                <option value="3C">Kelas 3C</option>
                                <option value="4A">Kelas 4A</option>
                                <option value="4B">Kelas 4B</option>
                                <option value="4C">Kelas 4C</option>
                                <option value="5A">Kelas 5A</option>
                                <option value="5B">Kelas 5B</option>
                                <option value="5C">Kelas 5C</option>
                                <option value="6A">Kelas 6A</option>
                                <option value="6B">Kelas 6B</option>
                                <option value="6C">Kelas 6C</option>
                            </select>
                        </div>
                        <div id="legerContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger nilai.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PTS Report Section -->
            <div id="pts-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Cetak PTS</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pilihSiswaPTS">Pilih Siswa</label>
                            <select id="pilihSiswaPTS" class="form-control" onchange="tampilkanReportPTS()">
                                <option value="">-- Pilih Siswa --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Cetak Laporan PTS
                        </button>
                    </div>
                </div>
                <div id="reportPTSContainer"></div>
            </div>

            <!-- Monitoring Section (Admin Only) -->
            <div id="monitoring-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Monitoring Pengisian Nilai</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monitoringChart"></canvas>
                        </div>
                        <div id="progressMonitoring">
                            <h6 class="mt-4">Progress per Guru</h6>
                            <div id="progressList">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Loading progress data...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section (Admin Only) -->
            <div id="settings-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Pengaturan</h6>
                    </div>
                    <div class="card-body">
                        <div class="template-card">
                            <div class="template-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="template-title">Logo Sekolah</div>
                            <div class="template-description">Upload logo sekolah untuk ditampilkan di rapor</div>
                            <div id="logoPreview">
                                <img id="logoSekolah" src="" alt="Logo Sekolah" style="max-width: 200px; max-height: 200px; display: none;">
                            </div>
                            <label class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Logo
                                <input type="file" id="uploadLogo" onchange="uploadLogoSekolah(event)" style="display: none;" accept="image/*">
                            </label>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Manajemen Guru</h6>
                                <button class="btn btn-primary btn-sm" onclick="tambahGuru()">
                                    <i class="fas fa-plus"></i> Tambah Guru
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Username</th>
                                                <th>Nama Guru</th>
                                                <th>Kelas</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelGuru">
                                            <tr>
                                                <td colspan="5" class="text-center">Tidak ada data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Subject -->
    <div id="modalMapel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMapelTitle">Tambah Mata Pelajaran</h5>
                <span class="modal-close" onclick="tutupModal('modalMapel')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formMapel">
                    <input type="hidden" id="mapelId">
                    <div class="form-group">
                        <label for="mapelKode">Kode Mata Pelajaran</label>
                        <input type="text" id="mapelKode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="mapelNama">Nama Mata Pelajaran</label>
                        <input type="text" id="mapelNama" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalMapel')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanMapel()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Student -->
    <div id="modalSiswa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSiswaTitle">Tambah Siswa</h5>
                <span class="modal-close" onclick="tutupModal('modalSiswa')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formSiswa">
                    <input type="hidden" id="siswaId">
                    <div class="form-group">
                        <label for="siswaNIS">NIS</label>
                        <input type="text" id="siswaNIS" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="siswaNama">Nama Siswa</label>
                        <input type="text" id="siswaNama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="siswaKelas">Kelas</label>
                        <select id="siswaKelas" class="form-control" required>
                            <option value="">-- Pilih Kelas --</option>
                            <option value="1A">Kelas 1A</option>
                            <option value="1B">Kelas 1B</option>
                            <option value="1C">Kelas 1C</option>
                            <option value="2A">Kelas 2A</option>
                            <option value="2B">Kelas 2B</option>
                            <option value="2C">Kelas 2C</option>
                            <option value="3A">Kelas 3A</option>
                            <option value="3B">Kelas 3B</option>
                            <option value="3C">Kelas 3C</option>
                            <option value="4A">Kelas 4A</option>
                            <option value="4B">Kelas 4B</option>
                            <option value="4C">Kelas 4C</option>
                            <option value="5A">Kelas 5A</option>
                            <option value="5B">Kelas 5B</option>
                            <option value="5C">Kelas 5C</option>
                            <option value="6A">Kelas 6A</option>
                            <option value="6B">Kelas 6B</option>
                            <option value="6C">Kelas 6C</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalSiswa')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanSiswa()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Teacher -->
    <div id="modalGuru" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGuruTitle">Tambah Guru</h5>
                <span class="modal-close" onclick="tutupModal('modalGuru')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formGuru">
                    <input type="hidden" id="guruId">
                    <div class="form-group">
                        <label for="guruUsername">Username</label>
                        <input type="text" id="guruUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruPassword">Password</label>
                        <input type="password" id="guruPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruNama">Nama Guru</label>
                        <input type="text" id="guruNama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="guruKelas">Kelas</label>
                        <select id="guruKelas" class="form-control" required>
                            <option value="">-- Pilih Kelas --</option>
                            <option value="1A">Kelas 1A</option>
                            <option value="1B">Kelas 1B</option>
                            <option value="1C">Kelas 1C</option>
                            <option value="2A">Kelas 2A</option>
                            <option value="2B">Kelas 2B</option>
                            <option value="2C">Kelas 2C</option>
                            <option value="3A">Kelas 3A</option>
                            <option value="3B">Kelas 3B</option>
                            <option value="3C">Kelas 3C</option>
                            <option value="4A">Kelas 4A</option>
                            <option value="4B">Kelas 4B</option>
                            <option value="4C">Kelas 4C</option>
                            <option value="5A">Kelas 5A</option>
                            <option value="5B">Kelas 5B</option>
                            <option value="5C">Kelas 5C</option>
                            <option value="6A">Kelas 6A</option>
                            <option value="6B">Kelas 6B</option>
                            <option value="6C">Kelas 6C</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalGuru')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanGuru()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal PH Input -->
    <div id="modalPH" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h5 class="modal-title">Input Penilaian Harian (PH)</h5>
                <span class="modal-close" onclick="tutupModal('modalPH')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="phMapel">Mata Pelajaran</label>
                    <input type="text" id="phMapel" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="phTanggal">Tanggal</label>
                    <input type="date" id="phTanggal" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="phDeskripsi">Deskripsi Penilaian</label>
                    <input type="text" id="phDeskripsi" class="form-control" placeholder="Contoh: Ulangan Harian 1" required>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NIS</th>
                                <th>Nama Siswa</th>
                                <th>Nilai</th>
                                <th>Predikat</th>
                            </tr>
                        </thead>
                        <tbody id="tabelPH">
                            <tr>
                                <td colspan="4" class="text-center">Tidak ada data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalPH')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanPH()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal PTS Input -->
    <div id="modalPTS" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h5 class="modal-title">Input Nilai PTS</h5>
                <span class="modal-close" onclick="tutupModal('modalPTS')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ptsMapel">Mata Pelajaran</label>
                    <input type="text" id="ptsMapel" class="form-control" readonly>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NIS</th>
                                <th>Nama Siswa</th>
                                <th>Nilai PTS</th>
                                <th>Predikat</th>
                            </tr>
                        </thead>
                        <tbody id="tabelPTS">
                            <tr>
                                <td colspan="4" class="text-center">Tidak ada data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalPTS')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanPTS()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal SAS Input -->
    <div id="modalSAS" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h5 class="modal-title">Input Nilai SAS</h5>
                <span class="modal-close" onclick="tutupModal('modalSAS')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sasMapel">Mata Pelajaran</label>
                    <input type="text" id="sasMapel" class="form-control" readonly>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NIS</th>
                                <th>Nama Siswa</th>
                                <th>Nilai SAS</th>
                                <th>Predikat</th>
                            </tr>
                        </thead>
                        <tbody id="tabelSAS">
                            <tr>
                                <td colspan="4" class="text-center">Tidak ada data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalSAS')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanSAS()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Leger Input -->
    <div id="modalLeger" class="modal">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-header">
                <h5 class="modal-title">Input Nilai Leger</h5>
                <span class="modal-close" onclick="tutupModal('modalLeger')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table leger-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No</th>
                                <th rowspan="2">NIS</th>
                                <th rowspan="2">Nama Siswa</th>
                                <th colspan="${mapelData.length * 3}">Nilai Per Mata Pelajaran</th>
                            </tr>
                            <tr id="legerHeader">
                                <!-- Subject headers will be added here -->
                            </tr>
                        </thead>
                        <tbody id="tabelLeger">
                            <!-- Student rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="tutupModal('modalLeger')">Batal</button>
                <button type="button" class="btn btn-primary" onclick="simpanLeger()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQQcgPoQMIeCn3tSkn7NAks2cRFTV8Df4",
            authDomain: "e-rapor-salsabila-klaseman.firebaseapp.com",
            databaseURL: "https://e-rapor-salsabila-klaseman-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-rapor-salsabila-klaseman",
            storageBucket: "e-rapor-salsabila-klaseman.firebasestorage.app",
            messagingSenderId: "519176085482",
            appId: "1:519176085482:web:66dc1c0e4264a8af911c93",
            measurementId: "G-XJTP2RYMMC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let userRole = null;
        let userKelas = null;
        let mapelData = [];
        let siswaData = [];
        let guruData = [];
        let phData = {};
        let ptsData = {};
        let sasData = {};
        let legerData = {};
        let logoSekolahURL = "";
        let monitoringChart = null;

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                ${message}
                <span class="close-alert" onclick="this.parentElement.remove()">&times;</span>
            `;
            document.querySelector('.content-header').after(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Role selection
        document.querySelectorAll('.role-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        // Login form submission
        document.getElementById('loginFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.querySelector('.role-option.active').dataset.role;
            const kelas = document.getElementById('kelas').value;
            
            // Simple validation (in real app, this should be done against a database)
            if (username && password) {
                if (role === 'admin') {
                    // Admin login
                    if (username === 'admin' && password === 'admin') {
                        currentUser = { username: username, role: role };
                        userRole = role;
                        showMainApp();
                        loadAdminData();
                    } else {
                        showAlert('Username atau password salah!', 'danger');
                    }
                } else {
                    // Teacher login
                    if (kelas) {
                        // Check if teacher exists in database
                        checkTeacherLogin(username, password, kelas);
                    } else {
                        showAlert('Silakan pilih kelas!', 'warning');
                    }
                }
            } else {
                showAlert('Username dan password tidak boleh kosong!', 'warning');
            }
        });

        // Check teacher login against database
        function checkTeacherLogin(username, password, kelas) {
            showLoading();
            
            database.ref('guru').orderByChild('username').equalTo(username).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const teacherData = snapshot.val();
                        const teacherKey = Object.keys(teacherData)[0];
                        const teacher = teacherData[teacherKey];
                        
                        if (teacher.password === password && teacher.kelas === kelas) {
                            currentUser = {
                                id: teacherKey,
                                username: teacher.username,
                                nama: teacher.nama,
                                kelas: teacher.kelas,
                                role: 'guru'
                            };
                            userRole = 'guru';
                            userKelas = kelas;
                            showMainApp();
                            loadTeacherData();
                        } else {
                            showAlert('Password atau kelas salah!', 'danger');
                        }
                    } else {
                        showAlert('Username tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            // Update user info
            if (userRole === 'admin') {
                document.getElementById('userInfo').textContent = 'Admin';
                document.getElementById('subjectsMenu').style.display = 'block';
                document.getElementById('studentsMenu').style.display = 'block';
                document.getElementById('monitoringMenu').style.display = 'block';
                document.getElementById('settingsMenu').style.display = 'block';
            } else {
                document.getElementById('userInfo').textContent = currentUser.nama;
                document.getElementById('subjectsMenu').style.display = 'none';
                document.getElementById('studentsMenu').style.display = 'none';
                document.getElementById('monitoringMenu').style.display = 'none';
                document.getElementById('settingsMenu').style.display = 'none';
            }
            
            // Load data based on role
            if (userRole === 'admin') {
                loadMapelData();
                loadSiswaData();
                loadGuruData();
                loadLogoSekolah();
            } else {
                loadMapelData();
                loadSiswaByKelas(userKelas);
                loadPHData();
                loadPTSData();
                loadSASData();
            }
        }

        // Load admin data
        function loadAdminData() {
            updateDashboard();
            loadSubjectCards();
        }

        // Load teacher data
        function loadTeacherData() {
            updateDashboard();
            loadSubjectCards();
            loadPHData();
            loadPTSData();
            loadSASData();
        }

        // Update dashboard statistics
        function updateDashboard() {
            if (userRole === 'admin') {
                // Admin dashboard
                document.getElementById('totalSiswa').textContent = siswaData.length;
                document.getElementById('totalMapel').textContent = mapelData.length;
                
                // Calculate completed assessments
                let totalPH = 0;
                let completedPH = 0;
                let totalPTS = 0;
                let completedPTS = 0;
                let totalSAS = 0;
                let completedSAS = 0;
                
                mapelData.forEach(mapel => {
                    // PH data
                    database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const phData = snapshot.val();
                            const phCount = Object.keys(phData).length;
                            totalPH += siswaData.length;
                            completedPH += phCount;
                        } else {
                            totalPH += siswaData.length;
                        }
                        
                        // PTS data
                        database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                            if (snapshot.exists()) {
                                const ptsData = snapshot.val();
                                const ptsCount = Object.keys(ptsData).length;
                                totalPTS += siswaData.length;
                                completedPTS += ptsCount;
                            } else {
                                totalPTS += siswaData.length;
                            }
                            
                            // SAS data
                            database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                                if (snapshot.exists()) {
                                    const sasData = snapshot.val();
                                    const sasCount = Object.keys(sasData).length;
                                    totalSAS += siswaData.length;
                                    completedSAS += sasCount;
                                } else {
                                    totalSAS += siswaData.length;
                                }
                                
                                // Update progress percentage
                                const totalAssessments = totalPH + totalPTS + totalSAS;
                                const completedAssessments = completedPH + completedPTS + completedSAS;
                                const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;
                                document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                                document.getElementById('totalPenilaian').textContent = completedAssessments;
                            });
                        });
                    });
                });
            } else {
                // Teacher dashboard
                const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                document.getElementById('totalSiswa').textContent = siswaKelas.length;
                document.getElementById('totalMapel').textContent = mapelData.length;
                
                // Calculate completed assessments for this teacher
                let totalPH = 0;
                let completedPH = 0;
                let totalPTS = 0;
                let completedPTS = 0;
                let totalSAS = 0;
                let completedSAS = 0;
                
                mapelData.forEach(mapel => {
                    // PH data
                    database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const phData = snapshot.val();
                            const phCount = Object.values(phData).filter(ph => {
                                return siswaKelas.some(siswa => siswa.nis === ph.nis);
                            }).length;
                            totalPH += siswaKelas.length;
                            completedPH += phCount;
                        } else {
                            totalPH += siswaKelas.length;
                        }
                        
                        // PTS data
                        database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                            if (snapshot.exists()) {
                                const ptsData = snapshot.val();
                                const ptsCount = Object.values(ptsData).filter(pts => {
                                    return siswaKelas.some(siswa => siswa.nis === pts.nis);
                                }).length;
                                totalPTS += siswaKelas.length;
                                completedPTS += ptsCount;
                            } else {
                                totalPTS += siswaKelas.length;
                            }
                            
                            // SAS data
                            database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                                if (snapshot.exists()) {
                                    const sasData = snapshot.val();
                                    const sasCount = Object.values(sasData).filter(sas => {
                                        return siswaKelas.some(siswa => siswa.nis === sas.nis);
                                    }).length;
                                    totalSAS += siswaKelas.length;
                                    completedSAS += sasCount;
                                } else {
                                    totalSAS += siswaKelas.length;
                                }
                                
                                // Update progress percentage
                                const totalAssessments = totalPH + totalPTS + totalSAS;
                                const completedAssessments = completedPH + completedPTS + completedSAS;
                                const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;
                                document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                                document.getElementById('totalPenilaian').textContent = completedAssessments;
                            });
                        });
                    });
                });
            }
        }

        // Load subject cards for dashboard
        function loadSubjectCards() {
            const container = document.getElementById('subjectCards');
            container.innerHTML = '';
            
            if (mapelData.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada mata pelajaran tersedia.</div>';
                return;
            }
            
            mapelData.forEach(mapel => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.onclick = () => openSubjectDashboard(mapel);
                
                // Calculate progress for this subject
                let progressPH = 0;
                let progressPTS = 0;
                let progressSAS = 0;
                let totalStudents = 0;
                
                if (userRole === 'admin') {
                    totalStudents = siswaData.length;
                } else {
                    totalStudents = siswaData.filter(siswa => siswa.kelas === userKelas).length;
                }
                
                database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const phData = snapshot.val();
                        let completedCount = 0;
                        
                        if (userRole === 'admin') {
                            completedCount = Object.keys(phData).length;
                        } else {
                            // For teachers, only count students in their class
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            completedCount = Object.values(phData).filter(ph => {
                                return siswaKelas.some(siswa => siswa.nis === ph.nis);
                            }).length;
                        }
                        
                        progressPH = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                    }
                    
                    database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const ptsData = snapshot.val();
                            let completedCount = 0;
                            
                            if (userRole === 'admin') {
                                completedCount = Object.keys(ptsData).length;
                            } else {
                                // For teachers, only count students in their class
                                const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                                completedCount = Object.values(ptsData).filter(pts => {
                                    return siswaKelas.some(siswa => siswa.nis === pts.nis);
                                }).length;
                            }
                            
                            progressPTS = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                        }
                        
                        database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                            if (snapshot.exists()) {
                                const sasData = snapshot.val();
                                let completedCount = 0;
                                
                                if (userRole === 'admin') {
                                    completedCount = Object.keys(sasData).length;
                                } else {
                                    // For teachers, only count students in their class
                                    const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                                    completedCount = Object.values(sasData).filter(sas => {
                                        return siswaKelas.some(siswa => siswa.nis === sas.nis);
                                    }).length;
                                }
                                
                                progressSAS = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                            }
                            
                            const overallProgress = Math.round((progressPH + progressPTS + progressSAS) / 3);
                            
                            card.innerHTML = `
                                <div class="subject-header">
                                    <div class="subject-title">${mapel.nama}</div>
                                    <div class="subject-icon">
                                        <i class="fas fa-book"></i>
                                    </div>
                                </div>
                                <div class="subject-progress">
                                    <div class="progress-header">
                                        <div class="progress-title">Progress</div>
                                        <div class="progress-percentage">${overallProgress}%</div>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${overallProgress}%"></div>
                                    </div>
                                    <div class="mt-2">
                                        <small>PH: ${progressPH}% | PTS: ${progressPTS}% | SAS: ${progressSAS}%</small>
                                    </div>
                                </div>
                            `;
                        });
                    });
                });
                
                container.appendChild(card);
            });
        }

        // Open subject dashboard
        function openSubjectDashboard(mapel) {
            // Set the selected subject in the dropdowns
            document.getElementById('pilihMapelPH').value = mapel.id;
            document.getElementById('pilihMapelPTS').value = mapel.id;
            document.getElementById('pilihMapelSAS').value = mapel.id;
            
            // Switch to assessment section
            showSection('ph');
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId + '-section').style.display = 'block';
            
            // Update active sidebar item
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content title
            const titles = {
                'dashboard': 'Dashboard',
                'subjects': 'Manajemen Mata Pelajaran',
                'students': 'Manajemen Data Siswa',
                'ph': 'Penilaian Harian',
                'assessment': 'Penilaian PTS',
                'sas': 'Penilaian SAS',
                'leger': 'Leger Nilai',
                'pts': 'Cetak PTS',
                'monitoring': 'Monitoring Pengisian Nilai',
                'settings': 'Pengaturan'
            };
            document.querySelector('.content-title').textContent = titles[sectionId];
            
            // Load section-specific data
            if (sectionId === 'monitoring' && userRole === 'admin') {
                loadMonitoringData();
            }
        }

        // Logout
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                currentUser = null;
                userRole = null;
                userKelas = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                
                // Reset form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('kelas').value = '';
                
                // Reset role selection
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector('.role-option[data-role="admin"]').classList.add('active');
            }
        }

        // Load subjects data
        function loadMapelData() {
            showLoading();
            
            database.ref('mapel').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        mapelData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        mapelData = [];
                    }
                    
                    // Update subject dropdowns
                    updateSubjectDropdowns();
                    
                    // Update subject cards if on dashboard
                    if (document.getElementById('dashboard-section').style.display !== 'none') {
                        loadSubjectCards();
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update subject dropdowns
        function updateSubjectDropdowns() {
            const dropdowns = [
                document.getElementById('pilihMapelPH'),
                document.getElementById('pilihMapelPTS'),
                document.getElementById('pilihMapelSAS')
            ];
            
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
                    
                    mapelData.forEach(mapel => {
                        const option = document.createElement('option');
                        option.value = mapel.id;
                        option.textContent = mapel.nama;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        // Add/Edit subject
        function tambahMapel() {
            document.getElementById('modalMapelTitle').textContent = 'Tambah Mata Pelajaran';
            document.getElementById('mapelId').value = '';
            document.getElementById('mapelKode').value = '';
            document.getElementById('mapelNama').value = '';
            document.getElementById('modalMapel').style.display = 'block';
        }

        function editMapel(id) {
            const mapel = mapelData.find(m => m.id === id);
            if (mapel) {
                document.getElementById('modalMapelTitle').textContent = 'Edit Mata Pelajaran';
                document.getElementById('mapelId').value = mapel.id;
                document.getElementById('mapelKode').value = mapel.kode;
                document.getElementById('mapelNama').value = mapel.nama;
                document.getElementById('modalMapel').style.display = 'block';
            }
        }

        function simpanMapel() {
            const id = document.getElementById('mapelId').value;
            const kode = document.getElementById('mapelKode').value;
            const nama = document.getElementById('mapelNama').value;
            
            if (kode && nama) {
                showLoading();
                
                const mapelData = {
                    kode: kode,
                    nama: nama
                };
                
                if (id) {
                    // Update existing subject
                    database.ref('mapel/' + id).update(mapelData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalMapel');
                            loadMapelData();
                            showAlert('Mata pelajaran berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new subject
                    database.ref('mapel').push(mapelData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalMapel');
                            loadMapelData();
                            showAlert('Mata pelajaran berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('Kode dan nama mata pelajaran tidak boleh kosong!', 'warning');
            }
        }

        function hapusMapel(id) {
            if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
                showLoading();
                
                database.ref('mapel/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadMapelData();
                        showAlert('Mata pelajaran berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Load students data
        function loadSiswaData() {
            showLoading();
            
            database.ref('siswa').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        siswaData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        siswaData = [];
                    }
                    
                    // Update student table
                    updateSiswaTable();
                    
                    // Update student dropdowns
                    updateSiswaDropdowns();
                    
                    // Update dashboard
                    updateDashboard();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load students by class
        function loadSiswaByKelas(kelas) {
            showLoading();
            
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        siswaData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        siswaData = [];
                    }
                    
                    // Update student dropdowns
                    updateSiswaDropdowns();
                    
                    // Update dashboard
                    updateDashboard();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update student table
        function updateSiswaTable() {
            const tbody = document.getElementById('tabelSiswa');
            tbody.innerHTML = '';
            
            if (siswaData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            siswaData.forEach(siswa => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${siswa.nis}</td>
                    <td>${siswa.nama}</td>
                    <td>Kelas ${siswa.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editSiswa('${siswa.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusSiswa('${siswa.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Filter students by class
        function filterSiswa() {
            const kelas = document.getElementById('filterKelasSiswa').value;
            
            if (kelas) {
                const filteredData = siswaData.filter(siswa => siswa.kelas === kelas);
                updateFilteredSiswaTable(filteredData);
            } else {
                updateSiswaTable();
            }
        }

        function updateFilteredSiswaTable(filteredData) {
            const tbody = document.getElementById('tabelSiswa');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            filteredData.forEach(siswa => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${siswa.nis}</td>
                    <td>${siswa.nama}</td>
                    <td>Kelas ${siswa.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editSiswa('${siswa.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusSiswa('${siswa.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Update student dropdowns
        function updateSiswaDropdowns() {
            const dropdowns = [
                document.getElementById('pilihSiswaPTS')
            ];
            
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                    
                    siswaData.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.id;
                        option.textContent = `${siswa.nis} - ${siswa.nama} (Kelas ${siswa.kelas})`;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        // Add/Edit student
        function tambahSiswa() {
            document.getElementById('modalSiswaTitle').textContent = 'Tambah Siswa';
            document.getElementById('siswaId').value = '';
            document.getElementById('siswaNIS').value = '';
            document.getElementById('siswaNama').value = '';
            document.getElementById('siswaKelas').value = '';
            document.getElementById('modalSiswa').style.display = 'block';
        }

        function editSiswa(id) {
            const siswa = siswaData.find(s => s.id === id);
            if (siswa) {
                document.getElementById('modalSiswaTitle').textContent = 'Edit Siswa';
                document.getElementById('siswaId').value = siswa.id;
                document.getElementById('siswaNIS').value = siswa.nis;
                document.getElementById('siswaNama').value = siswa.nama;
                document.getElementById('siswaKelas').value = siswa.kelas;
                document.getElementById('modalSiswa').style.display = 'block';
            }
        }

        function simpanSiswa() {
            const id = document.getElementById('siswaId').value;
            const nis = document.getElementById('siswaNIS').value;
            const nama = document.getElementById('siswaNama').value;
            const kelas = document.getElementById('siswaKelas').value;
            
            if (nis && nama && kelas) {
                showLoading();
                
                const siswaData = {
                    nis: nis,
                    nama: nama,
                    kelas: kelas
                };
                
                if (id) {
                    // Update existing student
                    database.ref('siswa/' + id).update(siswaData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalSiswa');
                            loadSiswaData();
                            showAlert('Data siswa berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new student
                    database.ref('siswa').push(siswaData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalSiswa');
                            loadSiswaData();
                            showAlert('Data siswa berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('NIS, nama, dan kelas tidak boleh kosong!', 'warning');
            }
        }

        function hapusSiswa(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
                showLoading();
                
                database.ref('siswa/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadSiswaData();
                        showAlert('Data siswa berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download student template
        function downloadTemplate() {
            const template = [
                ['NIS', 'Nama Siswa', 'Kelas'],
                ['12345', 'Ahmad Fauzi', '1A'],
                ['12346', 'Siti Nurhaliza', '1A']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Siswa");
            XLSX.writeFile(wb, "template_siswa.xlsx");
            
            showAlert('Template siswa berhasil diunduh!', 'success');
        }

        // Import students from Excel
        function importSiswaFromExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nama Siswa'] && row.Kelas) {
                            const siswaData = {
                                nis: row.NIS.toString(),
                                nama: row['Nama Siswa'].toString(),
                                kelas: row.Kelas.toString()
                            };
                            
                            const promise = database.ref('siswa').push(siswaData)
                                .then(() => {
                                    successCount++;
                                })
                                .catch((error) => {
                                    console.error('Error importing student:', error);
                                    errorCount++;
                                });
                            
                            promises.push(promise);
                        } else {
                            errorCount++;
                        }
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            hideLoading();
                            loadSiswaData();
                            showAlert(`Import selesai! ${successCount} siswa berhasil diimport, ${errorCount} gagal.`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Load teachers data
        function loadGuruData() {
            showLoading();
            
            database.ref('guru').once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        guruData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    } else {
                        guruData = [];
                    }
                    
                    // Update teacher table
                    updateGuruTable();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Update teacher table
        function updateGuruTable() {
            const tbody = document.getElementById('tabelGuru');
            tbody.innerHTML = '';
            
            if (guruData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
                return;
            }
            
            guruData.forEach(guru => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${guruData.indexOf(guru) + 1}</td>
                    <td>${guru.username}</td>
                    <td>${guru.nama}</td>
                    <td>Kelas ${guru.kelas}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editGuru('${guru.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusGuru('${guru.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Add/Edit teacher
        function tambahGuru() {
            document.getElementById('modalGuruTitle').textContent = 'Tambah Guru';
            document.getElementById('guruId').value = '';
            document.getElementById('guruUsername').value = '';
            document.getElementById('guruPassword').value = '';
            document.getElementById('guruNama').value = '';
            document.getElementById('guruKelas').value = '';
            document.getElementById('modalGuru').style.display = 'block';
        }

        function editGuru(id) {
            const guru = guruData.find(g => g.id === id);
            if (guru) {
                document.getElementById('modalGuruTitle').textContent = 'Edit Guru';
                document.getElementById('guruId').value = guru.id;
                document.getElementById('guruUsername').value = guru.username;
                document.getElementById('guruPassword').value = guru.password;
                document.getElementById('guruNama').value = guru.nama;
                document.getElementById('guruKelas').value = guru.kelas;
                document.getElementById('modalGuru').style.display = 'block';
            }
        }

        function simpanGuru() {
            const id = document.getElementById('guruId').value;
            const username = document.getElementById('guruUsername').value;
            const password = document.getElementById('guruPassword').value;
            const nama = document.getElementById('guruNama').value;
            const kelas = document.getElementById('guruKelas').value;
            
            if (username && password && nama && kelas) {
                showLoading();
                
                const guruData = {
                    username: username,
                    password: password,
                    nama: nama,
                    kelas: kelas
                };
                
                if (id) {
                    // Update existing teacher
                    database.ref('guru/' + id).update(guruData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalGuru');
                            loadGuruData();
                            showAlert('Data guru berhasil diperbarui!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    // Add new teacher
                    database.ref('guru').push(guruData)
                        .then(() => {
                            hideLoading();
                            tutupModal('modalGuru');
                            loadGuruData();
                            showAlert('Data guru berhasil ditambahkan!', 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                }
            } else {
                showAlert('Semua field harus diisi!', 'warning');
            }
        }

        function hapusGuru(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
                showLoading();
                
                database.ref('guru/' + id).remove()
                    .then(() => {
                        hideLoading();
                        loadGuruData();
                        showAlert('Data guru berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Load PH data
        function loadPHData() {
            // PH data is loaded per subject when needed
        }

        // Show PH data for selected subject
        function tampilkanPH() {
            const mapelId = document.getElementById('pilihMapelPH').value;
            
            if (!mapelId) {
                document.getElementById('PHContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian harian.</div>';
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('ph/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let phList = {};
                    if (snapshot.exists()) {
                        phList = snapshot.val();
                    }
                    
                    // Filter by teacher's class if not admin
                    if (userRole !== 'admin') {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                        const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                        
                        // Filter PH list to only include students in teacher's class
                        Object.keys(phList).forEach(nis => {
                            if (!siswaNIS.includes(nis)) {
                                delete phList[nis];
                            }
                        });
                    }
                    
                    // Update PH container
                    const container = document.getElementById('PHContainer');
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Deskripsi</th>
                                        <th>Jumlah Siswa</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelPHList">
                                    ${Object.keys(phList).length === 0 ? '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="inputPH('${mapelId}')">
                                <i class="fas fa-plus"></i> Input Penilaian Harian
                            </button>
                        </div>
                    `;
                    
                    // Populate PH list table
                    const tbody = document.getElementById('tabelPHList');
                    if (Object.keys(phList).length > 0) {
                        Object.keys(phList).forEach(phId => {
                            const ph = phList[phId];
                            const siswa = siswaData.find(s => s.nis === ph.nis);
                            
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${ph.tanggal}</td>
                                <td>${ph.deskripsi}</td>
                                <td>${Object.keys(ph.nilai || {}).length}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editPH('${mapelId}', '${phId}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="hapusPH('${mapelId}', '${phId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Input PH for selected subject
        function inputPH(mapelId) {
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            document.getElementById('phMapel').value = mapel.nama;
            document.getElementById('phTanggal').value = new Date().toISOString().split('T')[0];
            document.getElementById('phDeskripsi').value = '';
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            // Populate PH table
            const tbody = document.getElementById('tabelPH');
            tbody.innerHTML = '';
            
            if (studentsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada siswa</td></tr>';
            } else {
                studentsToShow.forEach(siswa => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>
                            <input type="number" class="form-control ph-nilai" 
                                   data-nis="${siswa.nis}" 
                                   min="0" max="100" value="">
                        </td>
                        <td>
                            <span class="ph-predikat">-</span>
                        </td>
                    `;
                    
                    // Add event listener to calculate predicate
                    const nilaiInput = row.querySelector('.ph-nilai');
                    nilaiInput.addEventListener('input', function() {
                        const nilai = parseInt(this.value);
                        const predikatCell = row.querySelector('.ph-predikat');
                        
                        if (isNaN(nilai)) {
                            predikatCell.textContent = '-';
                        } else if (nilai >= 90) {
                            predikatCell.textContent = 'A';
                        } else if (nilai >= 80) {
                            predikatCell.textContent = 'B';
                        } else if (nilai >= 70) {
                            predikatCell.textContent = 'C';
                        } else {
                            predikatCell.textContent = 'D';
                        }
                    });
                });
            }
            
            document.getElementById('modalPH').style.display = 'block';
        }

        // Edit PH
        function editPH(mapelId, phId) {
            showLoading();
            
            database.ref('ph/' + mapelId + '/' + phId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const ph = snapshot.val();
                        const mapel = mapelData.find(m => m.id === mapelId);
                        
                        document.getElementById('phMapel').value = mapel.nama;
                        document.getElementById('phTanggal').value = ph.tanggal;
                        document.getElementById('phDeskripsi').value = ph.deskripsi;
                        
                        // Get students based on role
                        let studentsToShow = [];
                        if (userRole === 'admin') {
                            studentsToShow = siswaData;
                        } else {
                            studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
                        }
                        
                        // Populate PH table
                        const tbody = document.getElementById('tabelPH');
                        tbody.innerHTML = '';
                        
                        studentsToShow.forEach(siswa => {
                            const row = tbody.insertRow();
                            const nilai = ph.nilai && ph.nilai[siswa.nis] ? ph.nilai[siswa.nis] : '';
                            
                            row.innerHTML = `
                                <td>${siswa.nis}</td>
                                <td>${siswa.nama}</td>
                                <td>
                                    <input type="number" class="form-control ph-nilai" 
                                           data-nis="${siswa.nis}" 
                                           min="0" max="100" value="${nilai}">
                                </td>
                                <td>
                                    <span class="ph-predikat">${nilai ? getPredikat(nilai) : '-'}</span>
                                </td>
                            `;
                            
                            // Add event listener to calculate predicate
                            const nilaiInput = row.querySelector('.ph-nilai');
                            nilaiInput.addEventListener('input', function() {
                                const nilai = parseInt(this.value);
                                const predikatCell = row.querySelector('.ph-predikat');
                                
                                if (isNaN(nilai)) {
                                    predikatCell.textContent = '-';
                                } else {
                                    predikatCell.textContent = getPredikat(nilai);
                                }
                            });
                        });
                        
                        document.getElementById('modalPH').style.display = 'block';
                    } else {
                        showAlert('Data PH tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Save PH data
        function simpanPH() {
            const mapelId = document.getElementById('pilihMapelPH').value;
            if (!mapelId) {
                showAlert('Mata pelajaran tidak valid!', 'danger');
                return;
            }
            
            const tanggal = document.getElementById('phTanggal').value;
            const deskripsi = document.getElementById('phDeskripsi').value;
            
            if (!tanggal || !deskripsi) {
                showAlert('Tanggal dan deskripsi tidak boleh kosong!', 'warning');
                return;
            }
            
            const nilaiInputs = document.querySelectorAll('.ph-nilai');
            let nilaiData = {};
            let hasError = false;
            
            nilaiInputs.forEach(input => {
                const nis = input.dataset.nis;
                const nilai = parseInt(input.value);
                
                if (!isNaN(nilai)) {
                    if (!nilaiData[nis]) {
                        nilaiData[nis] = {};
                    }
                    
                    nilaiData[nis] = {
                        nilai: nilai,
                        predikat: getPredikat(nilai)
                    };
                }
            });
            
            if (Object.keys(nilaiData).length === 0) {
                showAlert('Tidak ada data yang disimpan!', 'warning');
                return;
            }
            
            showLoading();
            
            // Generate a unique ID for this PH entry
            const phId = Date.now().toString();
            
            const phData = {
                nis: Object.keys(nilaiData)[0], // First student NIS as reference
                tanggal: tanggal,
                deskripsi: deskripsi,
                nilai: nilaiData
            };
            
            database.ref('ph/' + mapelId + '/' + phId).set(phData)
                .then(() => {
                    hideLoading();
                    tutupModal('modalPH');
                    tampilkanPH();
                    showAlert('Data penilaian harian berhasil disimpan!', 'success');
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Delete PH
        function hapusPH(mapelId, phId) {
            if (confirm('Apakah Anda yakin ingin menghapus data penilaian harian ini?')) {
                showLoading();
                
                database.ref('ph/' + mapelId + '/' + phId).remove()
                    .then(() => {
                        hideLoading();
                        tampilkanPH();
                        showAlert('Data penilaian harian berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download PH template
        function downloadTemplatePH() {
            const mapelId = document.getElementById('pilihMapelPH').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            const template = [
                ['NIS', 'Nama Siswa', 'Nilai']
            ];
            
            studentsToShow.forEach(siswa => {
                template.push([siswa.nis, siswa.nama, '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Template PH ${mapel.nama}`);
            XLSX.writeFile(wb, `template_ph_${mapel.nama}.xlsx`);
            
            showAlert(`Template PH ${mapel.nama} berhasil diunduh!`, 'success');
        }

        // Import PH from Excel
        function importPHFromExcel(event) {
            const mapelId = document.getElementById('pilihMapelPH').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    const tanggal = new Date().toISOString().split('T')[0];
                    const deskripsi = `Import dari Excel - ${new Date().toLocaleDateString()}`;
                    
                    // Generate a unique ID for this PH entry
                    const phId = Date.now().toString();
                    
                    let nilaiData = {};
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nilai'] !== undefined) {
                            const nilai = parseInt(row['Nilai']);
                            
                            if (!isNaN(nilai)) {
                                nilaiData[row.NIS.toString()] = {
                                    nilai: nilai,
                                    predikat: getPredikat(nilai)
                                };
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    });
                    
                    if (Object.keys(nilaiData).length > 0) {
                        const phData = {
                            nis: Object.keys(nilaiData)[0], // First student NIS as reference
                            tanggal: tanggal,
                            deskripsi: deskripsi,
                            nilai: nilaiData
                        };
                        
                        database.ref('ph/' + mapelId + '/' + phId).set(phData)
                            .then(() => {
                                hideLoading();
                                tampilkanPH();
                                showAlert(`Import selesai! ${successCount} data PH berhasil diimport, ${errorCount} gagal.`, 'success');
                            })
                            .catch((error) => {
                                hideLoading();
                                showAlert('Error: ' + error.message, 'danger');
                            });
                    } else {
                        hideLoading();
                        showAlert('Tidak ada data yang diimport!', 'warning');
                    }
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Export PH to Excel
        function exportPHToExcel() {
            const mapelId = document.getElementById('pilihMapelPH').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('ph/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let exportData = [];
                    
                    if (snapshot.exists()) {
                        const phData = snapshot.val();
                        
                        // Filter by teacher's class if not admin
                        if (userRole !== 'admin') {
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                            
                            Object.keys(phData).forEach(phId => {
                                const ph = phData[phId];
                                
                                Object.keys(ph.nilai).forEach(nis => {
                                    if (siswaNIS.includes(nis)) {
                                        const siswa = siswaData.find(s => s.nis === nis);
                                        
                                        if (siswa) {
                                            exportData.push({
                                                'Tanggal': ph.tanggal,
                                                'Deskripsi': ph.deskripsi,
                                                'NIS': nis,
                                                'Nama Siswa': siswa.nama,
                                                'Kelas': siswa.kelas,
                                                'Nilai': ph.nilai[nis].nilai,
                                                'Predikat': ph.nilai[nis].predikat
                                            });
                                        }
                                    }
                                });
                            });
                        } else {
                            Object.keys(phData).forEach(phId => {
                                const ph = phData[phId];
                                
                                Object.keys(ph.nilai).forEach(nis => {
                                    const siswa = siswaData.find(s => s.nis === nis);
                                    
                                    if (siswa) {
                                        exportData.push({
                                            'Tanggal': ph.tanggal,
                                            'Deskripsi': ph.deskripsi,
                                            'NIS': nis,
                                            'Nama Siswa': siswa.nama,
                                            'Kelas': siswa.kelas,
                                            'Nilai': ph.nilai[nis].nilai,
                                            'Predikat': ph.nilai[nis].predikat
                                        });
                                    }
                                });
                            });
                        }
                    }
                    
                    if (exportData.length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, `Data PH ${mapel.nama}`);
                        XLSX.writeFile(wb, `data_ph_${mapel.nama}.xlsx`);
                        
                        showAlert(`Data PH ${mapel.nama} berhasil diekspor!`, 'success');
                    } else {
                        showAlert('Tidak ada data PH yang diekspor!', 'warning');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load PTS data
        function loadPTSData() {
            // PTS data is loaded per subject when needed
        }

        // Show PTS data for selected subject
        function tampilkanPTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            
            if (!mapelId) {
                document.getElementById('PTSContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.</div>';
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('pts/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let ptsData = [];
                    if (snapshot.exists()) {
                        ptsData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Filter by teacher's class if not admin
                    if (userRole !== 'admin') {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                        const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                        ptsData = ptsData.filter(pts => siswaNIS.includes(pts.nis));
                    }
                    
                    // Update PTS container
                    const container = document.getElementById('PTSContainer');
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama Siswa</th>
                                        <th>Nilai PTS</th>
                                        <th>Predikat</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelPTSData">
                                    ${ptsData.length === 0 ? '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="inputPTS('${mapelId}')">
                                <i class="fas fa-plus"></i> Input Nilai PTS
                            </button>
                        </div>
                    `;
                    
                    // Populate PTS table
                    const tbody = document.getElementById('tabelPTSData');
                    if (ptsData.length > 0) {
                        ptsData.forEach(pts => {
                            const siswa = siswaData.find(s => s.nis === pts.nis);
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${pts.nis}</td>
                                <td>${siswa ? siswa.nama : '-'}</td>
                                <td>${pts.nilai}</td>
                                <td>${pts.predikat}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editPTS('${mapelId}', '${pts.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="hapusPTS('${mapelId}', '${pts.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Input PTS for selected subject
        function inputPTS(mapelId) {
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            document.getElementById('ptsMapel').value = mapel.nama;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            // Populate PTS table
            const tbody = document.getElementById('tabelPTS');
            tbody.innerHTML = '';
            
            if (studentsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada siswa</td></tr>';
            } else {
                studentsToShow.forEach(siswa => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>
                            <input type="number" class="form-control pts-nilai" 
                                   data-nis="${siswa.nis}" 
                                   min="0" max="100" value="">
                        </td>
                        <td>
                            <span class="pts-predikat">-</span>
                        </td>
                    `;
                    
                    // Add event listener to calculate predicate
                    const nilaiInput = row.querySelector('.pts-nilai');
                    nilaiInput.addEventListener('input', function() {
                        const nilai = parseInt(this.value);
                        const predikatCell = row.querySelector('.pts-predikat');
                        
                        if (isNaN(nilai)) {
                            predikatCell.textContent = '-';
                        } else if (nilai >= 90) {
                            predikatCell.textContent = 'A';
                        } else if (nilai >= 80) {
                            predikatCell.textContent = 'B';
                        } else if (nilai >= 70) {
                            predikatCell.textContent = 'C';
                        } else {
                            predikatCell.textContent = 'D';
                        }
                    });
                });
            }
            
            document.getElementById('modalPTS').style.display = 'block';
        }

        // Edit PTS
        function editPTS(mapelId, ptsId) {
            showLoading();
            
            database.ref('pts/' + mapelId + '/' + ptsId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const pts = snapshot.val();
                        const mapel = mapelData.find(m => m.id === mapelId);
                        
                        document.getElementById('ptsMapel').value = mapel.nama;
                        
                        // Get students based on role
                        let studentsToShow = [];
                        if (userRole === 'admin') {
                            studentsToShow = siswaData;
                        } else {
                            studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
                        }
                        
                        // Populate PTS table
                        const tbody = document.getElementById('tabelPTS');
                        tbody.innerHTML = '';
                        
                        studentsToShow.forEach(siswa => {
                            const row = tbody.insertRow();
                            const nilai = siswa.nis === pts.nis ? pts.nilai : '';
                            
                            row.innerHTML = `
                                <td>${siswa.nis}</td>
                                <td>${siswa.nama}</td>
                                <td>
                                    <input type="number" class="form-control pts-nilai" 
                                           data-nis="${siswa.nis}" 
                                           min="0" max="100" value="${nilai}">
                                </td>
                                <td>
                                    <span class="pts-predikat">${nilai ? getPredikat(nilai) : '-'}</span>
                                </td>
                            `;
                            
                            // Add event listener to calculate predicate
                            const nilaiInput = row.querySelector('.pts-nilai');
                            nilaiInput.addEventListener('input', function() {
                                const nilai = parseInt(this.value);
                                const predikatCell = row.querySelector('.pts-predikat');
                                
                                if (isNaN(nilai)) {
                                    predikatCell.textContent = '-';
                                } else {
                                    predikatCell.textContent = getPredikat(nilai);
                                }
                            });
                        });
                        
                        document.getElementById('modalPTS').style.display = 'block';
                    } else {
                        showAlert('Data PTS tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Save PTS data
        function simpanPTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Mata pelajaran tidak valid!', 'danger');
                return;
            }
            
            const nilaiInputs = document.querySelectorAll('.pts-nilai');
            let ptsData = [];
            let hasError = false;
            
            nilaiInputs.forEach(input => {
                const nis = input.dataset.nis;
                const nilai = parseInt(input.value);
                
                if (!isNaN(nilai)) {
                    ptsData.push({
                        nis: nis,
                        nilai: nilai,
                        predikat: getPredikat(nilai)
                    });
                }
            });
            
            if (ptsData.length === 0) {
                showAlert('Tidak ada data yang disimpan!', 'warning');
                return;
            }
            
            showLoading();
            
            let promises = [];
            
            ptsData.forEach(pts => {
                const promise = database.ref('pts/' + mapelId).child(pts.nis).set(pts)
                    .then(() => {
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error saving PTS:', error);
                        return false;
                    });
                
                promises.push(promise);
            });
            
            Promise.all(promises)
                .then((results) => {
                    hideLoading();
                    tutupModal('modalPTS');
                    tampilkanPTS();
                    showAlert(`Data PTS berhasil disimpan! ${results.filter(r => r).length} dari ${results.length} siswa.`, 'success');
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Delete PTS
        function hapusPTS(mapelId, ptsId) {
            if (confirm('Apakah Anda yakin ingin menghapus data PTS ini?')) {
                showLoading();
                
                database.ref('pts/' + mapelId + '/' + ptsId).remove()
                    .then(() => {
                        hideLoading();
                        tampilkanPTS();
                        showAlert('Data PTS berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download PTS template
        function downloadTemplatePTS() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            const template = [
                ['NIS', 'Nama Siswa', 'Nilai PTS']
            ];
            
            studentsToShow.forEach(siswa => {
                template.push([siswa.nis, siswa.nama, '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Template PTS ${mapel.nama}`);
            XLSX.writeFile(wb, `template_pts_${mapel.nama}.xlsx`);
            
            showAlert(`Template PTS ${mapel.nama} berhasil diunduh!`, 'success');
        }

        // Import PTS from Excel
        function importPTSFromExcel(event) {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nilai PTS'] !== undefined) {
                            const nilai = parseInt(row['Nilai PTS']);
                            
                            if (!isNaN(nilai)) {
                                const ptsData = {
                                    nis: row.NIS.toString(),
                                    nilai: nilai,
                                    predikat: getPredikat(nilai)
                                };
                                
                                const promise = database.ref('pts/' + mapelId).child(ptsData.nis).set(ptsData)
                                    .then(() => {
                                        successCount++;
                                    })
                                    .catch((error) => {
                                        console.error('Error importing PTS:', error);
                                        errorCount++;
                                    });
                                
                                promises.push(promise);
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            hideLoading();
                            tampilkanPTS();
                            showAlert(`Import selesai! ${successCount} data PTS berhasil diimport, ${errorCount} gagal.`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Export PTS to Excel
        function exportPTSToExcel() {
            const mapelId = document.getElementById('pilihMapelPTS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('pts/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let exportData = [];
                    
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        
                        // Filter by teacher's class if not admin
                        if (userRole !== 'admin') {
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                            
                            Object.keys(ptsData).forEach(nis => {
                                if (siswaNIS.includes(nis)) {
                                    const pts = ptsData[nis];
                                    const siswa = siswaData.find(s => s.nis === nis);
                                    
                                    if (siswa) {
                                        exportData.push({
                                            'NIS': nis,
                                            'Nama Siswa': siswa.nama,
                                            'Kelas': siswa.kelas,
                                            'Nilai PTS': pts.nilai,
                                            'Predikat': pts.predikat
                                        });
                                    }
                                }
                            });
                        } else {
                            Object.keys(ptsData).forEach(nis => {
                                const pts = ptsData[nis];
                                const siswa = siswaData.find(s => s.nis === nis);
                                
                                if (siswa) {
                                    exportData.push({
                                        'NIS': nis,
                                        'Nama Siswa': siswa.nama,
                                        'Kelas': siswa.kelas,
                                        'Nilai PTS': pts.nilai,
                                        'Predikat': pts.predikat
                                    });
                                }
                            });
                        }
                    }
                    
                    if (exportData.length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, `Data PTS ${mapel.nama}`);
                        XLSX.writeFile(wb, `data_pts_${mapel.nama}.xlsx`);
                        
                        showAlert(`Data PTS ${mapel.nama} berhasil diekspor!`, 'success');
                    } else {
                        showAlert('Tidak ada data PTS yang diekspor!', 'warning');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load SAS data
        function loadSASData() {
            // SAS data is loaded per subject when needed
        }

        // Show SAS data for selected subject
        function tampilkanSAS() {
            const mapelId = document.getElementById('pilihMapelSAS').value;
            
            if (!mapelId) {
                document.getElementById('SASContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian SAS.</div>';
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('sas/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let sasData = [];
                    if (snapshot.exists()) {
                        sasData = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Filter by teacher's class if not admin
                    if (userRole !== 'admin') {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                        const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                        sasData = sasData.filter(sas => siswaNIS.includes(sas.nis));
                    }
                    
                    // Update SAS container
                    const container = document.getElementById('SASContainer');
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama Siswa</th>
                                        <th>Nilai SAS</th>
                                        <th>Predikat</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelSASData">
                                    ${sasData.length === 0 ? '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="inputSAS('${mapelId}')">
                                <i class="fas fa-plus"></i> Input Nilai SAS
                            </button>
                        </div>
                    `;
                    
                    // Populate SAS table
                    const tbody = document.getElementById('tabelSASData');
                    if (sasData.length > 0) {
                        sasData.forEach(sas => {
                            const siswa = siswaData.find(s => s.nis === sas.nis);
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${sas.nis}</td>
                                <td>${siswa ? siswa.nama : '-'}</td>
                                <td>${sas.nilai}</td>
                                <td>${sas.predikat}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editSAS('${mapelId}', '${sas.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="hapusSAS('${mapelId}', '${sas.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Input SAS for selected subject
        function inputSAS(mapelId) {
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            document.getElementById('sasMapel').value = mapel.nama;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            // Populate SAS table
            const tbody = document.getElementById('tabelSAS');
            tbody.innerHTML = '';
            
            if (studentsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada siswa</td></tr>';
            } else {
                studentsToShow.forEach(siswa => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>
                            <input type="number" class="form-control sas-nilai" 
                                   data-nis="${siswa.nis}" 
                                   min="0" max="100" value="">
                        </td>
                        <td>
                            <span class="sas-predikat">-</span>
                        </td>
                    `;
                    
                    // Add event listener to calculate predicate
                    const nilaiInput = row.querySelector('.sas-nilai');
                    nilaiInput.addEventListener('input', function() {
                        const nilai = parseInt(this.value);
                        const predikatCell = row.querySelector('.sas-predikat');
                        
                        if (isNaN(nilai)) {
                            predikatCell.textContent = '-';
                        } else if (nilai >= 90) {
                            predikatCell.textContent = 'A';
                        } else if (nilai >= 80) {
                            predikatCell.textContent = 'B';
                        } else if (nilai >= 70) {
                            predikatCell.textContent = 'C';
                        } else {
                            predikatCell.textContent = 'D';
                        }
                    });
                });
            }
            
            document.getElementById('modalSAS').style.display = 'block';
        }

        // Edit SAS
        function editSAS(mapelId, sasId) {
            showLoading();
            
            database.ref('sas/' + mapelId + '/' + sasId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    if (snapshot.exists()) {
                        const sas = snapshot.val();
                        const mapel = mapelData.find(m => m.id === mapelId);
                        
                        document.getElementById('sasMapel').value = mapel.nama;
                        
                        // Get students based on role
                        let studentsToShow = [];
                        if (userRole === 'admin') {
                            studentsToShow = siswaData;
                        } else {
                            studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
                        }
                        
                        // Populate SAS table
                        const tbody = document.getElementById('tabelSAS');
                        tbody.innerHTML = '';
                        
                        studentsToShow.forEach(siswa => {
                            const row = tbody.insertRow();
                            const nilai = siswa.nis === sas.nis ? sas.nilai : '';
                            
                            row.innerHTML = `
                                <td>${siswa.nis}</td>
                                <td>${siswa.nama}</td>
                                <td>
                                    <input type="number" class="form-control sas-nilai" 
                                           data-nis="${siswa.nis}" 
                                           min="0" max="100" value="${nilai}">
                                </td>
                                <td>
                                    <span class="sas-predikat">${nilai ? getPredikat(nilai) : '-'}</span>
                                </td>
                            `;
                            
                            // Add event listener to calculate predicate
                            const nilaiInput = row.querySelector('.sas-nilai');
                            nilaiInput.addEventListener('input', function() {
                                const nilai = parseInt(this.value);
                                const predikatCell = row.querySelector('.sas-predikat');
                                
                                if (isNaN(nilai)) {
                                    predikatCell.textContent = '-';
                                } else {
                                    predikatCell.textContent = getPredikat(nilai);
                                }
                            });
                        });
                        
                        document.getElementById('modalSAS').style.display = 'block';
                    } else {
                        showAlert('Data SAS tidak ditemukan!', 'danger');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Save SAS data
        function simpanSAS() {
            const mapelId = document.getElementById('pilihMapelSAS').value;
            if (!mapelId) {
                showAlert('Mata pelajaran tidak valid!', 'danger');
                return;
            }
            
            const nilaiInputs = document.querySelectorAll('.sas-nilai');
            let sasData = [];
            let hasError = false;
            
            nilaiInputs.forEach(input => {
                const nis = input.dataset.nis;
                const nilai = parseInt(input.value);
                
                if (!isNaN(nilai)) {
                    sasData.push({
                        nis: nis,
                        nilai: nilai,
                        predikat: getPredikat(nilai)
                    });
                }
            });
            
            if (sasData.length === 0) {
                showAlert('Tidak ada data yang disimpan!', 'warning');
                return;
            }
            
            showLoading();
            
            let promises = [];
            
            sasData.forEach(sas => {
                const promise = database.ref('sas/' + mapelId).child(sas.nis).set(sas)
                    .then(() => {
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error saving SAS:', error);
                        return false;
                    });
                
                promises.push(promise);
            });
            
            Promise.all(promises)
                .then((results) => {
                    hideLoading();
                    tutupModal('modalSAS');
                    tampilkanSAS();
                    showAlert(`Data SAS berhasil disimpan! ${results.filter(r => r).length} dari ${results.length} siswa.`, 'success');
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Delete SAS
        function hapusSAS(mapelId, sasId) {
            if (confirm('Apakah Anda yakin ingin menghapus data SAS ini?')) {
                showLoading();
                
                database.ref('sas/' + mapelId + '/' + sasId).remove()
                    .then(() => {
                        hideLoading();
                        tampilkanSAS();
                        showAlert('Data SAS berhasil dihapus!', 'success');
                    })
                    .catch((error) => {
                        hideLoading();
                        showAlert('Error: ' + error.message, 'danger');
                    });
            }
        }

        // Download SAS template
        function downloadTemplateSAS() {
            const mapelId = document.getElementById('pilihMapelSAS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            // Get students based on role
            let studentsToShow = [];
            if (userRole === 'admin') {
                studentsToShow = siswaData;
            } else {
                studentsToShow = siswaData.filter(siswa => siswa.kelas === userKelas);
            }
            
            const template = [
                ['NIS', 'Nama Siswa', 'Nilai SAS']
            ];
            
            studentsToShow.forEach(siswa => {
                template.push([siswa.nis, siswa.nama, '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Template SAS ${mapel.nama}`);
            XLSX.writeFile(wb, `template_sas_${mapel.nama}.xlsx`);
            
            showAlert(`Template SAS ${mapel.nama} berhasil diunduh!`, 'success');
        }

        // Import SAS from Excel
        function importSASFromExcel(event) {
            const mapelId = document.getElementById('pilihMapelSAS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let promises = [];
                    
                    jsonData.forEach(row => {
                        if (row.NIS && row['Nilai SAS'] !== undefined) {
                            const nilai = parseInt(row['Nilai SAS']);
                            
                            if (!isNaN(nilai)) {
                                const sasData = {
                                    nis: row.NIS.toString(),
                                    nilai: nilai,
                                    predikat: getPredikat(nilai)
                                };
                                
                                const promise = database.ref('sas/' + mapelId).child(sasData.nis).set(sasData)
                                    .then(() => {
                                        successCount++;
                                    })
                                    .catch((error) => {
                                        console.error('Error importing SAS:', error);
                                        errorCount++;
                                    });
                                
                                promises.push(promise);
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            hideLoading();
                            tampilkanSAS();
                            showAlert(`Import selesai! ${successCount} data SAS berhasil diimport, ${errorCount} gagal.`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Export SAS to Excel
        function exportSASToExcel() {
            const mapelId = document.getElementById('pilihMapelSAS').value;
            if (!mapelId) {
                showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
                return;
            }
            
            const mapel = mapelData.find(m => m.id === mapelId);
            if (!mapel) return;
            
            showLoading();
            
            database.ref('sas/' + mapelId).once('value')
                .then((snapshot) => {
                    hideLoading();
                    
                    let exportData = [];
                    
                    if (snapshot.exists()) {
                        const sasData = snapshot.val();
                        
                        // Filter by teacher's class if not admin
                        if (userRole !== 'admin') {
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            const siswaNIS = siswaKelas.map(siswa => siswa.nis);
                            
                            Object.keys(sasData).forEach(nis => {
                                if (siswaNIS.includes(nis)) {
                                    const sas = sasData[nis];
                                    const siswa = siswaData.find(s => s.nis === nis);
                                    
                                    if (siswa) {
                                        exportData.push({
                                            'NIS': nis,
                                            'Nama Siswa': siswa.nama,
                                            'Kelas': siswa.kelas,
                                            'Nilai SAS': sas.nilai,
                                            'Predikat': sas.predikat
                                        });
                                    }
                                }
                            });
                        } else {
                            Object.keys(sasData).forEach(nis => {
                                const sas = sasData[nis];
                                const siswa = siswaData.find(s => s.nis === nis);
                                
                                if (siswa) {
                                    exportData.push({
                                        'NIS': nis,
                                        'Nama Siswa': siswa.nama,
                                        'Kelas': siswa.kelas,
                                        'Nilai SAS': sas.nilai,
                                        'Predikat': sas.predikat
                                    });
                                }
                            });
                        }
                    }
                    
                    if (exportData.length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, `Data SAS ${mapel.nama}`);
                        XLSX.writeFile(wb, `data_sas_${mapel.nama}.xlsx`);
                        
                        showAlert(`Data SAS ${mapel.nama} berhasil diekspor!`, 'success');
                    } else {
                        showAlert('Tidak ada data SAS yang diekspor!', 'warning');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Show leger data
        function tampilkanLeger() {
            const kelas = document.getElementById('filterKelasLeger').value;
            const container = document.getElementById('legerContainer');
            
            if (!kelas) {
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger nilai.</div>';
                return;
            }
            
            showLoading();
            
            // Get students for the selected class
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    let students = [];
                    if (snapshot.exists()) {
                        students = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Get leger data for the selected class
                    database.ref('leger/' + kelas).once('value')
                        .then((legerSnapshot) => {
                            hideLoading();
                            
                            let legerClassData = {};
                            if (legerSnapshot.exists()) {
                                legerClassData = legerSnapshot.val();
                            }
                            
                            // Generate leger table
                            let html = `
                                <div class="table-responsive">
                                    <table class="table leger-table">
                                        <thead>
                                            <tr>
                                                <th rowspan="2">No</th>
                                                <th rowspan="2">NIS</th>
                                                <th rowspan="2">Nama Siswa</th>
                            `;
                            
                            // Add assessment type headers
                            const assessmentTypes = ['PH', 'PTS', 'SAS'];
                            assessmentTypes.forEach(type => {
                                html += `<th colspan="${mapelData.length * 2}">${type}</th>`;
                            });
                            
                            html += `
                                            </tr>
                                            <tr>
                            `;
                            
                            // Add subject headers for each assessment type
                            assessmentTypes.forEach(type => {
                                mapelData.forEach(mapel => {
                                    html += `<th class="assessment-type">${mapel.nama}</th>`;
                                });
                            });
                            
                            html += `
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            // Add student rows
                            if (students.length === 0) {
                                html += '<tr><td colspan="' + (3 + (mapelData.length * 6)) + '" class="text-center">Tidak ada data siswa</td></tr>';
                            } else {
                                students.forEach((student, index) => {
                                    html += `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td class="student-name">${student.nis}</td>
                                            <td class="student-name">${student.nama}</td>
                                    `;
                                    
                                    // Add assessment cells for each subject and type
                                    assessmentTypes.forEach(type => {
                                        mapelData.forEach(mapel => {
                                            const studentLeger = legerClassData[student.nis];
                                            let nilai = '-';
                                            
                                            if (studentLeger && studentLeger[mapel.id] && studentLeger[mapel.id][type]) {
                                                nilai = studentLeger[mapel.id][type].nilai;
                                            }
                                            
                                            html += `<td>${nilai}</td>`;
                                        });
                                    });
                                    
                                    html += `
                                        </tr>
                                    `;
                                });
                            }
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="inputLeger('${kelas}')">
                                        <i class="fas fa-edit"></i> Input Nilai Leger
                                    </button>
                                </div>
                            `;
                            
                            container.innerHTML = html;
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Input leger data
        function inputLeger(kelas) {
            // Get students for the selected class
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    let students = [];
                    if (snapshot.exists()) {
                        students = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Get existing leger data for the selected class
                    database.ref('leger/' + kelas).once('value')
                        .then((legerSnapshot) => {
                            let legerClassData = {};
                            if (legerSnapshot.exists()) {
                                legerClassData = legerSnapshot.val();
                            }
                            
                            // Generate leger header
                            let headerHTML = '<tr>';
                            mapelData.forEach(mapel => {
                                headerHTML += `<th colspan="3">${mapel.nama}</th>`;
                            });
                            headerHTML += '</tr><tr>';
                            
                            // Add assessment type headers
                            const assessmentTypes = ['PH', 'PTS', 'SAS'];
                            assessmentTypes.forEach(type => {
                                mapelData.forEach(() => {
                                    headerHTML += `<th class="assessment-type">${type}</th>`;
                                });
                            });
                            headerHTML += '</tr>';
                            
                            // Generate leger table
                            let tableHTML = `
                                <table class="table leger-table">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">No</th>
                                            <th rowspan="2">NIS</th>
                                            <th rowspan="2">Nama Siswa</th>
                                            ${headerHTML}
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            // Add student rows
                            students.forEach((student, index) => {
                                tableHTML += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td class="student-name">${student.nis}</td>
                                        <td class="student-name">${student.nama}</td>
                                `;
                                
                                // Add assessment cells for each subject and type
                                assessmentTypes.forEach(type => {
                                    mapelData.forEach(mapel => {
                                        const studentLeger = legerClassData[student.nis];
                                        let nilai = '';
                                        
                                        if (studentLeger && studentLeger[mapel.id] && studentLeger[mapel.id][type]) {
                                            nilai = studentLeger[mapel.id][type].nilai;
                                        }
                                        
                                        tableHTML += `
                                            <td>
                                                <input type="number" class="form-control leger-input" 
                                                       data-nis="${student.nis}" 
                                                       data-mapel="${mapel.id}" 
                                                       data-type="${type}" 
                                                       min="0" max="100" value="${nilai}">
                                            </td>
                                        `;
                                    });
                                });
                                
                                tableHTML += `
                                    </tr>
                                `;
                            });
                            
                            tableHTML += `
                                    </tbody>
                                </table>
                            `;
                            
                            // Create modal if it doesn't exist
                            let modalLeger = document.getElementById('modalLeger');
                            if (!modalLeger) {
                                modalLeger = document.createElement('div');
                                modalLeger.id = 'modalLeger';
                                modalLeger.className = 'modal';
                                document.body.appendChild(modalLeger);
                            }
                            
                            modalLeger.innerHTML = `
                                <div class="modal-content" style="max-width: 95%;">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Input Nilai Leger - Kelas ${kelas}</h5>
                                        <span class="modal-close" onclick="tutupModal('modalLeger')">&times;</span>
                                    </div>
                                    <div class="modal-body">
                                        ${tableHTML}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="tutupModal('modalLeger')">Batal</button>
                                        <button type="button" class="btn btn-primary" onclick="simpanLeger('${kelas}')">Simpan</button>
                                    </div>
                                </div>
                            `;
                            
                            modalLeger.style.display = 'block';
                        })
                        .catch((error) => {
                            showAlert('Error: ' + error.message, 'danger');
                        });
                })
                .catch((error) => {
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Save leger data
        function simpanLeger(kelas) {
            const inputs = document.querySelectorAll('.leger-input');
            let legerData = {};
            
            inputs.forEach(input => {
                const nis = input.dataset.nis;
                const mapelId = input.dataset.mapel;
                const type = input.dataset.type;
                const nilai = parseInt(input.value);
                
                if (!isNaN(nilai)) {
                    if (!legerData[nis]) {
                        legerData[nis] = {};
                    }
                    
                    if (!legerData[nis][mapelId]) {
                        legerData[nis][mapelId] = {};
                    }
                    
                    legerData[nis][mapelId][type] = {
                        nilai: nilai,
                        predikat: getPredikat(nilai)
                    };
                }
            });
            
            if (Object.keys(ledgerData).length === 0) {
                showAlert('Tidak ada data yang disimpan!', 'warning');
                return;
            }
            
            showLoading();
            
            database.ref('leger/' + kelas).set(ledgerData)
                .then(() => {
                    hideLoading();
                    tutupModal('modalLeger');
                    tampilkanLeger();
                    showAlert('Data leger berhasil disimpan!', 'success');
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Download leger template
        function downloadLegerTemplate() {
            const kelas = document.getElementById('filterKelasLeger').value;
            
            if (!kelas) {
                showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
                return;
            }
            
            // Get students for the selected class
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    let students = [];
                    if (snapshot.exists()) {
                        students = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Create template
                    const template = [['No', 'NIS', 'Nama Siswa']];
                    
                    // Add subject headers for each assessment type
                    const assessmentTypes = ['PH', 'PTS', 'SAS'];
                    assessmentTypes.forEach(type => {
                        mapelData.forEach(mapel => {
                            template[0].push(`${mapel.nama} - ${type}`);
                        });
                    });
                    
                    // Add student rows
                    students.forEach((student, index) => {
                        const row = [index + 1, student.nis, student.nama];
                        
                        // Add empty cells for each assessment type and subject
                        assessmentTypes.forEach(() => {
                            mapelData.forEach(() => {
                                row.push('');
                            });
                        });
                        
                        template.push(row);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(template);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, `Template Leger Kelas ${kelas}`);
                    XLSX.writeFile(wb, `template_ledger_kelas_${kelas}.xlsx`);
                    
                    showAlert(`Template leger kelas ${kelas} berhasil diunduh!`, 'success');
                })
                .catch((error) => {
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Import leger from Excel
        function importLegerFromExcel(event) {
            const kelas = document.getElementById('filterKelasLeger').value;
            
            if (!kelas) {
                showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length > 0) {
                    showLoading();
                    
                    // Get existing leger data for the selected class
                    database.ref('leger/' + kelas).once('value')
                        .then((legerSnapshot) => {
                            let legerClassData = {};
                            if (legerSnapshot.exists()) {
                                legerClassData = legerSnapshot.val();
                            }
                            
                            // Process Excel data
                            let successCount = 0;
                            let errorCount = 0;
                            
                            jsonData.forEach(row => {
                                if (row.NIS && row['Nama Siswa']) {
                                    const nis = row.NIS.toString();
                                    
                                    if (!legerClassData[nis]) {
                                        legerClassData[nis] = {};
                                    }
                                    
                                    // Process each assessment type and subject
                                    const assessmentTypes = ['PH', 'PTS', 'SAS'];
                                    
                                    assessmentTypes.forEach(type => {
                                        mapelData.forEach(mapel => {
                                            const key = `${mapel.nama} - ${type}`;
                                            const nilai = row[key];
                                            
                                            if (nilai !== undefined && !isNaN(parseInt(nilai))) {
                                                if (!ledgerClassData[nis][mapel.id]) {
                                                    legerClassData[nis][mapel.id] = {};
                                                }
                                                
                                                legerClassData[nis][mapel.id][type] = {
                                                    nilai: parseInt(nilai),
                                                    predikat: getPredikat(parseInt(nilai))
                                                };
                                                
                                                successCount++;
                                            } else if (nilai === undefined || nilai === '') {
                                                // Skip empty cells
                                            } else {
                                                errorCount++;
                                            }
                                        });
                                    });
                                });
                            } else {
                                errorCount++;
                            }
                        });
                        
                        // Save to database
                        database.ref('leger/' + kelas).set(ledgerClassData)
                            .then(() => {
                                hideLoading();
                                tampilkanLeger();
                                showAlert(`Import selesai! ${successCount} nilai berhasil diimport, ${errorCount} gagal.`, 'success');
                            })
                            .catch((error) => {
                                hideLoading();
                                showAlert('Error: ' + error.message, 'danger');
                            });
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                } else {
                    showAlert('Tidak ada data yang diimport!', 'warning');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Export leger to Excel
        function exportLegerToExcel() {
            const kelas = document.getElementById('filterKelasLeger').value;
            
            if (!kelas) {
                showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
                return;
            }
            
            showLoading();
            
            // Get students for the selected class
            database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
                .then((snapshot) => {
                    let students = [];
                    if (snapshot.exists()) {
                        students = Object.keys(snapshot.val()).map(key => {
                            return {
                                id: key,
                                ...snapshot.val()[key]
                            };
                        });
                    }
                    
                    // Get leger data for the selected class
                    database.ref('leger/' + kelas).once('value')
                        .then((legerSnapshot) => {
                            hideLoading();
                            
                            let legerClassData = {};
                            if (legerSnapshot.exists()) {
                                legerClassData = legerSnapshot.val();
                            }
                            
                            // Create export data
                            const exportData = [['No', 'NIS', 'Nama Siswa']];
                            
                            // Add subject headers for each assessment type
                            const assessmentTypes = ['PH', 'PTS', 'SAS'];
                            assessmentTypes.forEach(type => {
                                mapelData.forEach(mapel => {
                                    exportData[0].push(`${mapel.nama} - ${type}`);
                                });
                            });
                            
                            // Add student rows
                            students.forEach((student, index) => {
                                const row = [index + 1, student.nis, student.nama];
                                
                                // Add assessment cells for each subject and type
                                assessmentTypes.forEach(type => {
                                    mapelData.forEach(mapel => {
                                        const studentLeger = legerClassData[student.nis];
                                        let nilai = '-';
                                        
                                        if (studentLeger && studentLeger[mapel.id] && studentLeger[mapel.id][type]) {
                                            nilai = studentLeger[mapel.id][type].nilai;
                                        }
                                        
                                        row.push(nilai);
                                    });
                                });
                                
                                exportData.push(row);
                            });
                            
                            const ws = XLSX.utils.aoa_to_sheet(exportData);
                            const wb = XLSX.utils.book_new();
                            XLSX.utils.book_append_sheet(wb, ws, `Leger Kelas ${kelas}`);
                            XLSX.writeFile(wb, `ledger_kelas_${kelas}.xlsx`);
                            
                            showAlert(`Leger kelas ${kelas} berhasil diekspor!`, 'success');
                        })
                        .catch((error) => {
                            hideLoading();
                            showAlert('Error: ' + error.message, 'danger');
                        });
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Show PTS report
        function tampilkanReportPTS() {
            const siswaId = document.getElementById('pilihSiswaPTS').value;
            
            if (!siswaId) {
                document.getElementById('reportPTSContainer').innerHTML = '';
                return;
            }
            
            const siswa = siswaData.find(s => s.id === siswaId);
            if (!siswa) return;
            
            showLoading();
            
            // Get all PTS data for this student
            let ptsPromises = [];
            let ptsResults = {};
            
            mapelData.forEach(mapel => {
                const promise = database.ref('pts/' + mapel.id + '/' + siswa.nis).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            ptsResults[mapel.id] = snapshot.val();
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting PTS data:', error);
                        return false;
                    });
                
                ptsPromises.push(promise);
            });
            
            Promise.all(ptsPromises)
                .then(() => {
                    hideLoading();
                    
                    // Generate report HTML
                    let html = `
                        <div class="rapor">
                            <div class="rapor-header">
                                ${logoSekolahURL ? `<img src="${logoSekolahURL}" alt="Logo Sekolah" class="rapor-logo">` : ''}
                                <div class="rapor-title">LAPORAN PENILAIAN TENGAH SEMESTER (PTS)</div>
                                <div class="rapor-subtitle">KURIKULUM MERDEKA - SEMESTER 1</div>
                            </div>
                            <div class="rapor-info">
                                <p><strong>NIS:</strong> ${siswa.nis}</p>
                                <p><strong>Nama Siswa:</strong> ${siswa.nama}</p>
                                <p><strong>Kelas:</strong> Kelas ${siswa.kelas}</p>
                                <p><strong>Semester:</strong> 1</p>
                                <p><strong>Tahun Ajaran:</strong> 2025/2026</p>
                            </div>
                            <div class="rapor-section">
                                <div class="rapor-section-title">NILAI PENILAIAN TENGAH SEMESTER (PTS)</div>
                                <table class="rapor-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Mata Pelajaran</th>
                                            <th>Nilai</th>
                                            <th>Predikat</th>
                                            <th>Keterangan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Add PTS data to table
                    let no = 1;
                    mapelData.forEach(mapel => {
                        const pts = ptsResults[mapel.id];
                        
                        if (pts) {
                            let keterangan = '';
                            if (pts.nilai >= 90) {
                                keterangan = 'Sangat Baik';
                            } else if (pts.nilai >= 80) {
                                keterangan = 'Baik';
                            } else if (pts.nilai >= 70) {
                                keterangan = 'Cukup';
                            } else {
                                keterangan = 'Perlu Perbaikan';
                            }
                            
                            html += `
                                <tr>
                                    <td>${no++}</td>
                                    <td>${mapel.nama}</td>
                                    <td>${pts.nilai}</td>
                                    <td>${pts.predikat}</td>
                                    <td>${keterangan}</td>
                                </tr>
                            `;
                        } else {
                            html += `
                                <tr>
                                    <td>${no++}</td>
                                    <td>${mapel.nama}</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>Belum Dinilai</td>
                                </tr>
                            `;
                        }
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="rapor-section">
                                <div class="rapor-section-title">CATATAN</div>
                                <p>- Nilai PTS merupakan penilaian tengah semester yang dilaksanakan pada semester ini.</p>
                                <p>- Predikat A: Sangat Baik (90-100)</p>
                                <p>- Predikat B: Baik (80-89)</p>
                                <p>- Predikat C: Cukup (70-79)</p>
                                <p>- Predikat D: Perlu Perbaikan (0-69)</p>
                            </div>
                            <div class="rapor-signature">
                                <div class="rapor-signature-box">
                                    <p>Wali Kelas</p>
                                    <div class="rapor-signature-line"></div>
                                    <p>NIP. ....................</p>
                                </div>
                                <div class="rapor-signature-box">
                                    <p>Orang Tua/Wali</p>
                                    <div class="rapor-signature-line"></div>
                                    <p>............................</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('reportPTSContainer').innerHTML = html;
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load monitoring data
        function loadMonitoringData() {
            showLoading();
            
            // Get all assessment data
            let phPromises = [];
            let phResults = {};
            let ptsPromises = [];
            let ptsResults = {};
            let sasPromises = [];
            let sasResults = {};
            
            mapelData.forEach(mapel => {
                // PH data
                const phPromise = database.ref('ph/' + mapel.id).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            phResults[mapel.id] = snapshot.val();
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting PH data:', error);
                        return false;
                    });
                
                phPromises.push(phPromise);
                
                // PTS data
                const ptsPromise = database.ref('pts/' + mapel.id).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            ptsResults[mapel.id] = snapshot.val();
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting PTS data:', error);
                        return false;
                    });
                
                ptsPromises.push(ptsPromise);
                
                // SAS data
                const sasPromise = database.ref('sas/' + mapel.id).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            sasResults[mapel.id] = snapshot.val();
                        }
                        return true;
                    })
                    .catch((error) => {
                        console.error('Error getting SAS data:', error);
                        return false;
                    });
                
                sasPromises.push(sasPromise);
            });
            
            Promise.all([...phPromises, ...ptsPromises, ...sasPromises])
                .then(() => {
                    hideLoading();
                    
                    // Prepare data for chart
                    const chartLabels = mapelData.map(mapel => mapel.nama);
                    const phData = [];
                    const ptsData = [];
                    const sasData = [];
                    
                    mapelData.forEach(mapel => {
                        let phCount = 0;
                        let ptsCount = 0;
                        let sasCount = 0;
                        
                        // Count PH data
                        if (phResults[mapel.id]) {
                            phCount = Object.keys(phResults[mapel.id]).length;
                        }
                        
                        // Count PTS data
                        if (ptsResults[mapel.id]) {
                            ptsCount = Object.keys(ptsResults[mapel.id]).length;
                        }
                        
                        // Count SAS data
                        if (sasResults[mapel.id]) {
                            sasCount = Object.keys(sasResults[mapel.id]).length;
                        }
                        
                        phData.push(phCount);
                        ptsData.push(ptsCount);
                        sasData.push(sasCount);
                    });
                    
                    // Create chart
                    const ctx = document.getElementById('monitoringChart').getContext('2d');
                    
                    if (monitoringChart) {
                        monitoringChart.destroy();
                    }
                    
                    monitoringChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'PH',
                                    data: phData,
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'PTS',
                                    data: ptsData,
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'SAS',
                                    data: sasData,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Jumlah Siswa Dinilai'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Prepare progress data for each teacher
                    let progressHTML = '';
                    
                    guruData.forEach(guru => {
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === guru.kelas);
                        const totalSiswa = siswaKelas.length;
                        
                        let completedPH = 0;
                        let completedPTS = 0;
                        let completedSAS = 0;
                        
                        // Calculate completed PH
                        Object.keys(phResults).forEach(mapelId => {
                            const phData = phResults[mapelId];
                            Object.keys(phData).forEach(phId => {
                                const ph = phData[phId];
                                if (ph.nilai && Object.keys(ph.nilai || {}).some(nis => 
                                    siswaKelas.some(siswa => siswa.nis === nis))) {
                                    completedPH++;
                                }
                            });
                        });
                        
                        // Calculate completed PTS
                        Object.keys(ptsResults).forEach(mapelId => {
                            const ptsData = ptsResults[mapelId];
                            Object.keys(ptsData).forEach(nis => {
                                if (siswaKelas.some(siswa => siswa.nis === nis)) {
                                    completedPTS++;
                                }
                            });
                        });
                        
                        // Calculate completed SAS
                        Object.keys(sasResults).forEach(mapelId => {
                            const sasData = sasResults[mapelId];
                            Object.keys(sasData).forEach(nis => {
                                if (siswaKelas.some(siswa => siswa.nis === nis)) {
                                    completedSAS++;
                                }
                            });
                        });
                        
                        const totalPossible = totalSiswa * mapelData.length * 3; // 3 assessment types
                        const completed = completedPH + completedPTS + completedSAS;
                        const progressPercentage = totalPossible > 0 ? Math.round((completed / totalPossible) * 100) : 0;
                        
                        progressHTML += `
                            <div class="progress-item">
                                <div class="progress-header">
                                    <div class="progress-title">${guru.nama} (Kelas ${guru.kelas})</div>
                                    <div class="progress-percentage">${progressPercentage}%</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                                </div>
                                <div class="mt-1">
                                    <small>PH: ${completedPH} | PTS: ${completedPTS} | SAS: ${completedSAS}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('progressList').innerHTML = progressHTML;
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        }

        // Load school logo
        function loadLogoSekolah() {
            database.ref('settings/logo').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        logoSekolahURL = snapshot.val();
                        const logoImg = document.getElementById('logoSekolah');
                        if (logoImg) {
                            logoImg.src = logoSekolahURL;
                            logoImg.style.display = 'block';
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading logo:', error);
                });
        }

        // Upload school logo
        function uploadLogoSekolah(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading();
            
            // Create a storage reference
            const storageRef = storage.ref('logo/' + file.name);
            
            // Upload file
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Observe state change events such as progress, pause, and resume
                    // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                }, 
                (error) => {
                    // Handle unsuccessful uploads
                    hideLoading();
                    showAlert('Error uploading logo: ' + error.message, 'danger');
                }, 
                () => {
                    // Handle successful uploads on complete
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        hideLoading();
                        
                        // Save URL to database
                        database.ref('settings/logo').set(downloadURL)
                            .then(() => {
                                logoSekolahURL = downloadURL;
                                
                                // Update preview
                                const logoImg = document.getElementById('logoSekolah');
                                if (logoImg) {
                                    logoImg.src = downloadURL;
                                    logoImg.style.display = 'block';
                                }
                                
                                showAlert('Logo sekolah berhasil diupload!', 'success');
                            })
                            .catch((error) => {
                                showAlert('Error saving logo URL: ' + error.message, 'danger');
                            });
                    });
                }
            );
        }

        // Close modal
        function tutupModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Helper function to get predicate from grade
        function getPredikat(nilai) {
            if (nilai >= 90) return 'A';
            else if (nilai >= 80) return 'B';
            else if (nilai >= 70) return 'C';
            else return 'D';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userRole = currentUser.role;
                    
                    if (userRole === 'guru') {
                        userKelas = currentUser.kelas;
                    }
                    
                    showMainApp();
                    
                    if (userRole === 'admin') {
                        loadAdminData();
                    } else {
                        loadTeacherData();
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                }
            }
        });
    </script>
</body>
</html>
