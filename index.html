<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Rapor Salsabila Klaseman</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<style>
:root {
--primary-color: #4e73df;
--secondary-color: #858796;
--success-color: #1cc88a;
--info-color: #36b9cc;
--warning-color: #f6c23e;
--danger-color: #e74a3b;
--light-color: #f8f9fc;
--dark-color: #5a5c69;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
font-size: 14px;
}

.wrapper {
display: flex;
min-height: 100vh;
}

/* Sidebar */
.sidebar {
width: 250px;
background-color: var(--primary-color);
color: white;
transition: all 0.3s;
}

.sidebar-brand {
height: 60px;
display: flex;
align-items: center;
justify-content: center;
font-size: 20px;
font-weight: bold;
background-color: rgba(0, 0, 0, 0.1);
}

.sidebar-menu {
padding: 20px 0;
}

.sidebar-item {
padding: 12px 20px;
display: flex;
align-items: center;
cursor: pointer;
transition: all 0.3s;
}

.sidebar-item:hover {
background-color: rgba(255, 255, 255, 0.1);
}

.sidebar-item i {
margin-right: 10px;
width: 20px;
text-align: center;
}

.sidebar-item.active {
background-color: rgba(255, 255, 255, 0.2);
border-left: 4px solid white;
}

/* Main Content */
.content {
flex: 1;
padding: 20px;
overflow-y: auto;
}

.content-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.content-title {
font-size: 24px;
font-weight: bold;
color: var(--primary-color);
}

.user-info {
display: flex;
align-items: center;
}

.user-info img {
width: 40px;
height: 40px;
border-radius: 50%;
margin-right: 10px;
}

/* Cards */
.card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
margin-bottom: 20px;
}

.card-header {
padding: 15px 20px;
border-bottom: 1px solid #e3e6f0;
font-weight: bold;
display: flex;
justify-content: space-between;
align-items: center;
}

.card-body {
padding: 20px;
}

/* Form */
.form-group {
margin-bottom: 15px;
}

.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
}

.form-control {
width: 100%;
padding: 10px 15px;
border: 1px solid #d1d3e2;
border-radius: 4px;
font-size: 14px;
}

.form-control:focus {
outline: none;
border-color: var(--primary-color);
box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

/* Buttons */
.btn {
padding: 10px 15px;
border-radius: 4px;
font-weight: 600;
cursor: pointer;
border: none;
display: inline-block;
text-align: center;
transition: all 0.2s;
}

.btn-primary {
background-color: var(--primary-color);
color: white;
}

.btn-primary:hover {
background-color: #2e59d9;
}

.btn-success {
background-color: var(--success-color);
color: white;
}

.btn-success:hover {
background-color: #17a673;
}

.btn-danger {
background-color: var(--danger-color);
color: white;
}

.btn-danger:hover {
background-color: #c82333;
}

.btn-warning {
background-color: var(--warning-color);
color: white;
}

.btn-warning:hover {
background-color: #dda20a;
}

.btn-info {
background-color: var(--info-color);
color: white;
}

.btn-info:hover {
background-color: #2c9faf;
}

.btn-sm {
padding: 5px 10px;
font-size: 12px;
}

/* Table */
.table {
width: 100%;
border-collapse: collapse;
}

.table th, .table td {
padding: 12px 15px;
text-align: left;
border-bottom: 1px solid #e3e6f0;
}

.table th {
background-color: #f8f9fc;
font-weight: 600;
color: var(--primary-color);
border-top: none;
}

.table tbody tr:hover {
background-color: rgba(0, 0, 0, 0.02);
}

/* Modal */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
animation: fadeIn 0.3s;
}

.modal-content {
background-color: white;
margin: 5% auto;
padding: 0;
border-radius: 8px;
width: 80%;
max-width: 600px;
box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
animation: slideIn 0.3s;
}

.modal-header {
padding: 15px 20px;
border-bottom: 1px solid #e3e6f0;
display: flex;
justify-content: space-between;
align-items: center;
}

.modal-title {
font-size: 18px;
font-weight: bold;
color: var(--primary-color);
}

.modal-close {
font-size: 24px;
cursor: pointer;
color: var(--secondary-color);
}

.modal-body {
padding: 20px;
}

.modal-footer {
padding: 15px 20px;
border-top: 1px solid #e3e6f0;
display: flex;
justify-content: flex-end;
}

/* Rapor */
.rapor {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 30px;
margin: 20px auto;
max-width: 800px;
}

.rapor-header {
text-align: center;
margin-bottom: 30px;
position: relative;
}

.rapor-logo {
position: absolute;
top: 0;
left: 0;
width: 80px;
height: 80px;
}

.rapor-title {
font-size: 24px;
font-weight: bold;
margin-bottom: 10px;
}

.rapor-subtitle {
font-size: 18px;
color: var(--secondary-color);
}

.rapor-info {
margin-bottom: 20px;
}

.rapor-info p {
margin-bottom: 5px;
}

.rapor-section {
margin-bottom: 20px;
}

.rapor-section-title {
font-size: 16px;
font-weight: bold;
margin-bottom: 10px;
color: var(--primary-color);
}

.rapor-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.rapor-table th, .rapor-table td {
border: 1px solid #ddd;
padding: 8px;
text-align: left;
}

.rapor-table th {
background-color: #f2f2f2;
}

.rapor-signature {
display: flex;
justify-content: space-between;
margin-top: 30px;
}

.rapor-signature-box {
text-align: center;
width: 45%;
}

.rapor-signature-line {
height: 1px;
background-color: black;
margin: 40px 0 5px;
}

/* Subject Cards */
.subject-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 20px;
margin-bottom: 20px;
cursor: pointer;
transition: all 0.3s;
}

.subject-card:hover {
transform: translateY(-5px);
box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.subject-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}

.subject-title {
font-size: 18px;
font-weight: bold;
color: var(--primary-color);
}

.subject-icon {
font-size: 24px;
color: var(--primary-color);
}

.subject-progress {
margin-top: 10px;
}

.progress-bar {
height: 10px;
background-color: #e9ecef;
border-radius: 5px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background-color: var(--success-color);
}

/* Chart Container */
.chart-container {
position: relative;
height: 300px;
width: 100%;
}

/* Animations */
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes slideIn {
from { transform: translateY(-50px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
.wrapper {
flex-direction: column;
}

.sidebar {
width: 100%;
height: auto;
}

.content {
padding: 10px;
}

.modal-content {
width: 95%;
margin: 10% auto;
}
}

.no-print {
display: block;
}

@media print {
.no-print {
display: none;
}
}

/* Loading indicator */
.loading {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0.8);
z-index: 9999;
justify-content: center;
align-items: center;
flex-direction: column;
}

.loading-spinner {
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary-color);
border-radius: 50%;
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin-bottom: 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Alert */
.alert {
padding: 15px;
margin-bottom: 20px;
border: 1px solid transparent;
border-radius: 4px;
}

.alert-success {
color: #155724;
background-color: #d4edda;
border-color: #c3e6cb;
}

.alert-danger {
color: #721c24;
background-color: #f8d7da;
border-color: #f5c6cb;
}

.alert-info {
color: #0c5460;
background-color: #d1ecf1;
border-color: #bee5eb;
}

.alert-warning {
color: #856404;
background-color: #fff3cd;
border-color: #ffeeba;
}

.close-alert {
float: right;
font-size: 20px;
font-weight: bold;
cursor: pointer;
}

/* Login Form */
.login-container {
max-width: 400px;
margin: 100px auto;
}

.login-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 30px;
}

.login-header {
text-align: center;
margin-bottom: 30px;
}

.login-title {
font-size: 24px;
font-weight: bold;
color: var(--primary-color);
}

.role-selector {
display: flex;
justify-content: space-between;
margin-bottom: 20px;
}

.role-option {
flex: 1;
text-align: center;
padding: 15px;
border: 1px solid #d1d3e2;
border-radius: 4px;
cursor: pointer;
transition: all 0.2s;
}

.role-option.active {
background-color: var(--primary-color);
color: white;
border-color: var(--primary-color);
}

/* Template Download */
.template-card {
background-color: white;
border-radius: 8px;
box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
padding: 20px;
margin-bottom: 20px;
text-align: center;
}

.template-icon {
font-size: 48px;
color: var(--primary-color);
margin-bottom: 15px;
}

.template-title {
font-size: 18px;
font-weight: bold;
margin-bottom: 10px;
}

.template-description {
color: var(--secondary-color);
margin-bottom: 15px;
}

/* Progress Monitoring */
.progress-item {
margin-bottom: 15px;
}

.progress-header {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
}

.progress-title {
font-weight: 600;
}

.progress-percentage {
color: var(--secondary-color);
}

/* PH List */
.ph-list {
margin-bottom: 15px;
}

.ph-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px;
border: 1px solid #e3e6f0;
border-radius: 4px;
margin-bottom: 5px;
}

.ph-info {
flex: 1;
}

.ph-date {
color: var(--secondary-color);
font-size: 12px;
}

.ph-actions {
display: flex;
gap: 5px;
}

/* Tabs */
.tabs {
display: flex;
margin-bottom: 15px;
border-bottom: 1px solid #e3e6f0;
}

.tab {
padding: 10px 15px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.2s;
}

.tab.active {
border-bottom: 2px solid var(--primary-color);
color: var(--primary-color);
font-weight: 600;
}

/* Leger Table */
.leger-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.leger-table th, .leger-table td {
border: 1px solid #ddd;
padding: 8px;
text-align: center;
}

.leger-table th {
background-color: #f2f2f2;
position: sticky;
top: 0;
}

.leger-table .student-name {
text-align: left;
}

.leger-table .subject-header {
background-color: #e9ecef;
font-weight: 600;
}

.leger-table .assessment-type {
background-color: #f8f9fc;
font-size: 12px;
font-weight: 600;
}

/* Combined Leger */
.combined-leger-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
font-size: 12px;
}

.combined-leger-table th, .combined-leger-table td {
border: 1px solid #ddd;
padding: 6px;
text-align: center;
}

.combined-leger-table th {
background-color: #f2f2f2;
position: sticky;
top: 0;
font-weight: 600;
}

.combined-leger-table .student-name {
text-align: left;
font-weight: 600;
}

.combined-leger-table .subject-header {
background-color: #e9ecef;
}

.combined-leger-table .assessment-type {
background-color: #f8f9fc;
font-weight: 600;
}

.combined-leger-table .final-grade {
background-color: #e7f1ff;
font-weight: 600;
}

/* Row classes for alternating colors */
.combined-leger-table tr:nth-child(even) {
background-color: #f9f9f9;
}

.combined-leger-table tr:hover {
background-color: #f1f7ff;
}
</style>
</head>
<body>
<div class="loading" id="loadingIndicator">
<div class="loading-spinner"></div>
<p>Memproses data...</p>
</div>

<!-- Login Form -->
<div id="loginForm" class="login-container">
<div class="login-card">
<div class="login-header">
<div class="login-title">E-Rapor Salsabila Klaseman</div>
<p>Silakan login untuk melanjutkan</p>
</div>
<form id="loginFormElement">
<div class="form-group">
<label for="username">Username</label>
<input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
</div>
<div class="form-group">
<label for="password">Password</label>
<input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
</div>
<div class="form-group">
<label>Pilih Role</label>
<div class="role-selector">
<div class="role-option active" data-role="admin">Admin</div>
<div class="role-option" data-role="guru">Guru Kelas</div>
</div>
</div>
<div class="form-group">
<label for="kelas">Kelas (untuk Guru)</label>
<select id="kelas" class="form-control">
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
</form>
</div>
</div>

<!-- Main Application -->
<div id="mainApp" class="wrapper" style="display: none;">
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-brand">
<i class="fas fa-graduation-cap"></i> E-Rapor Salsabila
</div>
<div class="sidebar-menu">
<div class="sidebar-item active" onclick="showSection('dashboard')">
<i class="fas fa-tachometer-alt"></i> Dashboard
</div>
<div class="sidebar-item" onclick="showSection('subjects')" id="subjectsMenu" style="display: none;">
<i class="fas fa-book"></i> Mata Pelajaran
</div>
<div class="sidebar-item" onclick="showSection('students')" id="studentsMenu" style="display: none;">
<i class="fas fa-users"></i> Data Siswa
</div>
<div class="sidebar-item" onclick="showSection('ph')" id="phMenu">
<i class="fas fa-clipboard-list"></i> Penilaian Harian
</div>
<div class="sidebar-item" onclick="showSection('assessment')" id="assessmentMenu">
<i class="fas fa-clipboard-list"></i> Penilaian PTS
</div>
<div class="sidebar-item" onclick="showSection('sas')" id="sasMenu">
<i class="fas fa-clipboard-list"></i> Penilaian SAS
</div>
<div class="sidebar-item" onclick="showSection('leger')" id="legerMenu">
<i class="fas fa-table"></i> Leger Nilai
</div>
<div class="sidebar-item" onclick="showSection('combinedLeger')" id="combinedLegerMenu">
<i class="fas fa-table"></i> Leger Gabungan
</div>
<div class="sidebar-item" onclick="showSection('pts')" id="ptsMenu">
<i class="fas fa-file-alt"></i> Cetak PTS
</div>
<div class="sidebar-item" onclick="showSection('monitoring')" id="monitoringMenu" style="display: none;">
<i class="fas fa-chart-line"></i> Monitoring
</div>
<div class="sidebar-item" onclick="showSection('settings')" id="settingsMenu" style="display: none;">
<i class="fas fa-cog"></i> Pengaturan
</div>
<div class="sidebar-item" onclick="logout()">
<i class="fas fa-sign-out-alt"></i> Logout
</div>
</div>
</div>

<!-- Main Content -->
<div class="content">
<div class="content-header">
<h1 class="content-title">Dashboard</h1>
<div class="user-info">
<span id="userInfo">Admin</span>
<img src="https://i.imgur.com/0DQ3Q4V.jpg" alt="User">
</div>
</div>

<!-- Dashboard Section -->
<div id="dashboard-section" class="content-section">
<div class="row">
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Siswa</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSiswa">0</div>
</div>
<div class="col-auto">
<i class="fas fa-users fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mata Pelajaran</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMapel">0</div>
</div>
<div class="col-auto">
<i class="fas fa-book fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-info text-uppercase mb-1">Penilaian Selesai</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPenilaian">0</div>
</div>
<div class="col-auto">
<i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card">
<div class="card-body">
<div class="row align-items-center">
<div class="col">
<div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Progress</div>
<div class="h5 mb-0 font-weight-bold text-gray-800" id="progressPercentage">0%</div>
</div>
<div class="col-auto">
<i class="fas fa-percentage fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Subject Cards -->
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Mata Pelajaran</h6>
</div>
<div class="card-body">
<div id="subjectCards">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk menginput nilai.
</div>
</div>
</div>
</div>
</div>

<!-- Subjects Section (Admin Only) -->
<div id="subjects-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Mata Pelajaran</h6>
<button class="btn btn-primary btn-sm" onclick="tambahMapel()">
<i class="fas fa-plus"></i> Tambah Mata Pelajaran
</button>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>No</th>
<th>Kode</th>
<th>Nama Mata Pelajaran</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelMapel">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Students Section (Admin Only) -->
<div id="students-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Data Siswa</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplate()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importSiswa" onchange="importSiswaFromExcel(event)" style="display: none;">
</label>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="filterKelasSiswa">Filter Kelas</label>
<select id="filterKelasSiswa" class="form-control" onchange="filterSiswa()">
<option value="">-- Semua Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Kelas</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelSiswa">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- PH Section -->
<div id="ph-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian Harian (PH)</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplatePH()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importPH" onchange="importPHFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportPHToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelPH">Pilih Mata Pelajaran</label>
<select id="pilihMapelPH" class="form-control" onchange="tampilkanPH()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="PHContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian harian.
</div>
</div>
</div>
</div>
</div>

<!-- Assessment Section -->
<div id="assessment-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian PTS</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplatePTS()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importPTS" onchange="importPTSFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportPTSToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelPTS">Pilih Mata Pelajaran</label>
<select id="pilihMapelPTS" class="form-control" onchange="tampilkanPTS()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="PTSContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian PTS.
</div>
</div>
</div>
</div>
</div>

<!-- SAS Section -->
<div id="sas-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Penilaian SAS</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadTemplateSAS()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importSAS" onchange="importSASFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportSASToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihMapelSAS">Pilih Mata Pelajaran</label>
<select id="pilihMapelSAS" class="form-control" onchange="tampilkanSAS()">
<option value="">-- Pilih Mata Pelajaran --</option>
</select>
</div>
<div id="SASContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih mata pelajaran untuk melihat penilaian SAS.
</div>
</div>
</div>
</div>
</div>

<!-- Leger Section -->
<div id="leger-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Leger Nilai</h6>
<div>
<button class="btn btn-success btn-sm" onclick="downloadLegerTemplate()">
<i class="fas fa-download"></i> Download Template
</button>
<label class="btn btn-info btn-sm">
<i class="fas fa-file-import"></i> Import dari Excel
<input type="file" id="importLeger" onchange="importLegerFromExcel(event)" style="display: none;">
</label>
<button class="btn btn-primary btn-sm" onclick="exportLegerToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="filterKelasLeger">Filter Kelas</label>
<select id="filterKelasLeger" class="form-control" onchange="tampilkanLeger()">
<option value="">-- Semua Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<div id="legerContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger nilai.
</div>
</div>
</div>
</div>
</div>

<!-- Combined Leger Section -->
<div id="combinedLeger-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Leger Gabungan (PH, PTS, SAS)</h6>
<div>
<button class="btn btn-primary btn-sm" onclick="exportCombinedLegerToExcel()">
<i class="fas fa-file-export"></i> Export ke Excel
</button>
<button class="btn btn-success btn-sm" onclick="window.print()">
<i class="fas fa-print"></i> Cetak
</button>
</div>
</div>
<div class="card-body">
<div class="form-group">
<label for="filterKelasCombinedLeger">Filter Kelas</label>
<select id="filterKelasCombinedLeger" class="form-control" onchange="tampilkanCombinedLeger()">
<option value="">-- Semua Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
<div id="combinedLegerContainer">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Silakan pilih kelas untuk melihat leger gabungan.
</div>
</div>
</div>
</div>
</div>

<!-- PTS Report Section -->
<div id="pts-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Cetak PTS</h6>
</div>
<div class="card-body">
<div class="form-group">
<label for="pilihSiswaPTS">Pilih Siswa</label>
<select id="pilihSiswaPTS" class="form-control" onchange="tampilkanReportPTS()">
<option value="">-- Pilih Siswa --</option>
</select>
</div>
<button class="btn btn-primary" onclick="window.print()">
<i class="fas fa-print"></i> Cetak Laporan PTS
</button>
</div>
</div>
<div id="reportPTSContainer"></div>
</div>

<!-- Monitoring Section (Admin Only) -->
<div id="monitoring-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Monitoring Pengisian Nilai</h6>
</div>
<div class="card-body">
<div class="chart-container">
<canvas id="monitoringChart"></canvas>
</div>
<div id="progressMonitoring">
<h6 class="mt-4">Progress per Guru</h6>
<div id="progressList">
<div class="alert alert-info">
<i class="fas fa-info-circle"></i> Loading progress data...
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Settings Section (Admin Only) -->
<div id="settings-section" class="content-section" style="display: none;">
<div class="card">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Pengaturan</h6>
</div>
<div class="card-body">
<div class="template-card">
<div class="template-icon">
<i class="fas fa-image"></i>
</div>
<div class="template-title">Logo Sekolah</div>
<div class="template-description">Upload logo sekolah untuk ditampilkan di rapor</div>
<div id="logoPreview">
<img id="logoSekolah" src="" alt="Logo Sekolah" style="max-width: 200px; max-height: 200px; display: none;">
</div>
<label class="btn btn-primary">
<i class="fas fa-upload"></i> Upload Logo
<input type="file" id="uploadLogo" onchange="uploadLogoSekolah(event)" style="display: none;" accept="image/*">
</label>
</div>

<div class="card mt-4">
<div class="card-header">
<h6 class="m-0 font-weight-bold text-primary">Manajemen Guru</h6>
<button class="btn btn-primary btn-sm" onclick="tambahGuru()">
<i class="fas fa-plus"></i> Tambah Guru
</button>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>No</th>
<th>Username</th>
<th>Nama Guru</th>
<th>Kelas</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tabelGuru">
<tr>
<td colspan="5" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Modal Add/Edit Subject -->
<div id="modalMapel" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalMapelTitle">Tambah Mata Pelajaran</h5>
<span class="modal-close" onclick="tutupModal('modalMapel')">&times;</span>
</div>
<div class="modal-body">
<form id="formMapel">
<input type="hidden" id="mapelId">
<div class="form-group">
<label for="mapelKode">Kode Mata Pelajaran</label>
<input type="text" id="mapelKode" class="form-control" required>
</div>
<div class="form-group">
<label for="mapelNama">Nama Mata Pelajaran</label>
<input type="text" id="mapelNama" class="form-control" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalMapel')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanMapel()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Add/Edit Student -->
<div id="modalSiswa" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalSiswaTitle">Tambah Siswa</h5>
<span class="modal-close" onclick="tutupModal('modalSiswa')">&times;</span>
</div>
<div class="modal-body">
<form id="formSiswa">
<input type="hidden" id="siswaId">
<div class="form-group">
<label for="siswaNIS">NIS</label>
<input type="text" id="siswaNIS" class="form-control" required>
</div>
<div class="form-group">
<label for="siswaNama">Nama Siswa</label>
<input type="text" id="siswaNama" class="form-control" required>
</div>
<div class="form-group">
<label for="siswaKelas">Kelas</label>
<select id="siswaKelas" class="form-control" required>
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalSiswa')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanSiswa()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Add/Edit Teacher -->
<div id="modalGuru" class="modal">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalGuruTitle">Tambah Guru</h5>
<span class="modal-close" onclick="tutupModal('modalGuru')">&times;</span>
</div>
<div class="modal-body">
<form id="formGuru">
<input type="hidden" id="guruId">
<div class="form-group">
<label for="guruUsername">Username</label>
<input type="text" id="guruUsername" class="form-control" required>
</div>
<div class="form-group">
<label for="guruPassword">Password</label>
<input type="password" id="guruPassword" class="form-control" required>
</div>
<div class="form-group">
<label for="guruNama">Nama Guru</label>
<input type="text" id="guruNama" class="form-control" required>
</div>
<div class="form-group">
<label for="guruKelas">Kelas</label>
<select id="guruKelas" class="form-control" required>
<option value="">-- Pilih Kelas --</option>
<option value="1A">Kelas 1A</option>
<option value="1B">Kelas 1B</option>
<option value="1C">Kelas 1C</option>
<option value="2A">Kelas 2A</option>
<option value="2B">Kelas 2B</option>
<option value="2C">Kelas 2C</option>
<option value="3A">Kelas 3A</option>
<option value="3B">Kelas 3B</option>
<option value="3C">Kelas 3C</option>
<option value="4A">Kelas 4A</option>
<option value="4B">Kelas 4B</option>
<option value="4C">Kelas 4C</option>
<option value="5A">Kelas 5A</option>
<option value="5B">Kelas 5B</option>
<option value="5C">Kelas 5C</option>
<option value="6A">Kelas 6A</option>
<option value="6B">Kelas 6B</option>
<option value="6C">Kelas 6C</option>
</select>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalGuru')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanGuru()">Simpan</button>
</div>
</div>
</div>

<!-- Modal PH Input -->
<div id="modalPH" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Penilaian Harian (PH)</h5>
<span class="modal-close" onclick="tutupModal('modalPH')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="phMapel">Mata Pelajaran</label>
<input type="text" id="phMapel" class="form-control" readonly>
</div>
<div class="form-group">
<label for="phTanggal">Tanggal</label>
<input type="date" id="phTanggal" class="form-control" required>
</div>
<div class="form-group">
<label for="phDeskripsi">Deskripsi Penilaian</label>
<input type="text" id="phDeskripsi" class="form-control" placeholder="Contoh: Ulangan Harian 1" required>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelPH">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalPH')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanPH()">Simpan</button>
</div>
</div>
</div>

<!-- Modal PTS Input -->
<div id="modalPTS" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai PTS</h5>
<span class="modal-close" onclick="tutupModal('modalPTS')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="ptsMapel">Mata Pelajaran</label>
<input type="text" id="ptsMapel" class="form-control" readonly>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai PTS</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelPTS">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalPTS')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanPTS()">Simpan</button>
</div>
</div>
</div>

<!-- Modal SAS Input -->
<div id="modalSAS" class="modal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai SAS</h5>
<span class="modal-close" onclick="tutupModal('modalSAS')">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="sasMapel">Mata Pelajaran</label>
<input type="text" id="sasMapel" class="form-control" readonly>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>NIS</th>
<th>Nama Siswa</th>
<th>Nilai SAS</th>
<th>Predikat</th>
</tr>
</thead>
<tbody id="tabelSAS">
<tr>
<td colspan="4" class="text-center">Tidak ada data</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalSAS')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanSAS()">Simpan</button>
</div>
</div>
</div>

<!-- Modal Leger Input -->
<div id="modalLeger" class="modal">
<div class="modal-content" style="max-width: 90%;">
<div class="modal-header">
<h5 class="modal-title">Input Nilai Leger</h5>
<span class="modal-close" onclick="tutupModal('modalLeger')">&times;</span>
</div>
<div class="modal-body">
<div class="table-responsive">
<table class="table leger-table">
<thead>
<tr>
<th rowspan="2">No</th>
<th rowspan="2">NIS</th>
<th rowspan="2">Nama Siswa</th>
<th colspan="3" id="legerHeaderPH">Penilaian Harian</th>
<th colspan="3" id="legerHeaderPTS">Penilaian PTS</th>
<th colspan="3" id="legerHeaderSAS">Penilaian SAS</th>
<th rowspan="2">Nilai Akhir</th>
</tr>
<tr id="legerSubHeader">
<!-- Subheaders will be added here -->
</tr>
</thead>
<tbody id="tabelLeger">
<!-- Student rows will be added here -->
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="tutupModal('modalLeger')">Batal</button>
<button type="button" class="btn btn-primary" onclick="simpanLeger()">Simpan</button>
</div>
</div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
apiKey: "AIzaSyCQQcgPoQMIeCn3tSkn7NAks2cRFTV8Df4",
authDomain: "e-rapor-salsabila-klaseman.firebaseapp.com",
databaseURL: "https://e-rapor-salsabila-klaseman-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "e-rapor-salsabila-klaseman",
storageBucket: "e-rapor-salsabila-klaseman.firebasestorage.app",
messagingSenderId: "519176085482",
appId: "1:519176085482:web:66dc1c0e4264a8af911c93",
measurementId: "G-XJTP2RYMMC"
};

// Initialize Firebase with error handling
let database, storage;
try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    storage = firebase.storage();
    console.log("Firebase initialized successfully");
} catch (error) {
    console.error("Firebase initialization error:", error);
    showAlert("Gagal menginisialisasi Firebase. Periksa koneksi internet Anda.", "danger");
}

// Global Variables
let currentUser = null;
let userRole = null;
let userKelas = null;
let mapelData = [];
let siswaData = [];
let guruData = [];
let phData = {};
let ptsData = {};
let sasData = {};
let legerData = {};
let logoSekolahURL = "";
let monitoringChart = null;

// Show loading indicator
function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'flex';
}

// Hide loading indicator
function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

// Show alert message
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        ${message}
        <span class="close-alert" onclick="this.parentElement.remove()">&times;</span>
    `;
    document.querySelector('.content-header').after(alertDiv);

    // Auto remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Role selection
document.querySelectorAll('.role-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.role-option').forEach(opt => {
            opt.classList.remove('active');
        });
        this.classList.add('active');
    });
});

// Login form submission
document.getElementById('loginFormElement').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const role = document.querySelector('.role-option.active').dataset.role;
    const kelas = document.getElementById('kelas').value;
    
    // Validasi input
    if (!username || !password) {
        showAlert('Username dan password tidak boleh kosong!', 'warning');
        return;
    }
    
    if (role === 'guru' && !kelas) {
        showAlert('Silakan pilih kelas!', 'warning');
        return;
    }
    
    showLoading();
    
    if (role === 'admin') {
        // Admin login (tanpa Firebase)
        setTimeout(() => {
            if (username === 'admin' && password === 'admin') {
                currentUser = { username: username, role: role };
                userRole = role;
                hideLoading();
                showMainApp();
                loadAdminData();
            } else {
                hideLoading();
                showAlert('Username atau password salah!', 'danger');
            }
        }, 500);
    } else {
        // Teacher login (dengan Firebase)
        checkTeacherLogin(username, password, kelas);
    }
});

// Check teacher login against database
function checkTeacherLogin(username, password, kelas) {
    // Cek koneksi Firebase
    if (!firebase.apps.length) {
        hideLoading();
        showAlert("Koneksi ke database gagal. Periksa koneksi internet Anda.", "danger");
        return;
    }
    
    database.ref('guru').orderByChild('username').equalTo(username).once('value')
        .then((snapshot) => {
            hideLoading();
            
            if (snapshot.exists()) {
                const teacherData = snapshot.val();
                const teacherKey = Object.keys(teacherData)[0];
                const teacher = teacherData[teacherKey];
                
                if (teacher.password === password && teacher.kelas === kelas) {
                    currentUser = {
                        id: teacherKey,
                        username: teacher.username,
                        nama: teacher.nama,
                        kelas: teacher.kelas,
                        role: 'guru'
                    };
                    userRole = 'guru';
                    userKelas = kelas;
                    showMainApp();
                    loadTeacherData();
                } else {
                    showAlert('Password atau kelas salah!', 'danger');
                }
            } else {
                showAlert('Username tidak ditemukan!', 'danger');
            }
        })
        .catch((error) => {
            hideLoading();
            console.error("Login error:", error);
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Show main application
function showMainApp() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';

    // Update user info
    if (userRole === 'admin') {
        document.getElementById('userInfo').textContent = 'Admin';
        document.getElementById('subjectsMenu').style.display = 'block';
        document.getElementById('studentsMenu').style.display = 'block';
        document.getElementById('monitoringMenu').style.display = 'block';
        document.getElementById('settingsMenu').style.display = 'block';
    } else {
        document.getElementById('userInfo').textContent = currentUser.nama;
        document.getElementById('subjectsMenu').style.display = 'none';
        document.getElementById('studentsMenu').style.display = 'none';
        document.getElementById('monitoringMenu').style.display = 'none';
        document.getElementById('settingsMenu').style.display = 'none';
    }

    // Load data based on role
    if (userRole === 'admin') {
        loadMapelData();
        loadSiswaData();
        loadGuruData();
        loadLogoSekolah();
    } else {
        loadMapelData();
        loadSiswaByKelas(userKelas);
        loadPHData();
        loadPTSData();
        loadSASData();
    }
}

// Load admin data
function loadAdminData() {
    updateDashboard();
    loadSubjectCards();
}

// Load teacher data
function loadTeacherData() {
    updateDashboard();
    loadSubjectCards();
    loadPHData();
    loadPTSData();
    loadSASData();
}

// Update dashboard statistics
function updateDashboard() {
    if (userRole === 'admin') {
        // Admin dashboard
        document.getElementById('totalSiswa').textContent = siswaData.length;
        document.getElementById('totalMapel').textContent = mapelData.length;

        // Calculate completed assessments
        let totalPH = 0;
        let completedPH = 0;
        let totalPTS = 0;
        let completedPTS = 0;
        let totalSAS = 0;
        let completedSAS = 0;

        mapelData.forEach(mapel => {
            // PH data
            database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const phData = snapshot.val();
                    const phCount = Object.keys(phData).length;
                    totalPH += siswaData.length;
                    completedPH += phCount;
                } else {
                    totalPH += siswaData.length;
                }

                // PTS data
                database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        const ptsCount = Object.keys(ptsData).length;
                        totalPTS += siswaData.length;
                        completedPTS += ptsCount;
                    } else {
                        totalPTS += siswaData.length;
                    }

                    // SAS data
                    database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const sasData = snapshot.val();
                            const sasCount = Object.keys(sasData).length;
                            totalSAS += siswaData.length;
                            completedSAS += sasCount;
                        } else {
                            totalSAS += siswaData.length;
                        }

                        // Update progress percentage
                        const totalAssessments = totalPH + totalPTS + totalSAS;
                        const completedAssessments = completedPH + completedPTS + completedSAS;
                        const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;
                        document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                        document.getElementById('totalPenilaian').textContent = completedAssessments;
                    });
                });
            });
        });
    } else {
        // Teacher dashboard
        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
        document.getElementById('totalSiswa').textContent = siswaKelas.length;
        document.getElementById('totalMapel').textContent = mapelData.length;

        // Calculate completed assessments for this teacher
        let totalPH = 0;
        let completedPH = 0;
        let totalPTS = 0;
        let completedPTS = 0;
        let totalSAS = 0;
        let completedSAS = 0;

        mapelData.forEach(mapel => {
            // PH data
            database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const phData = snapshot.val();
                    const phCount = Object.values(phData).filter(ph => {
                        return siswaKelas.some(siswa => siswa.nis === ph.nis);
                    }).length;
                    totalPH += siswaKelas.length;
                    completedPH += phCount;
                } else {
                    totalPH += siswaKelas.length;
                }

                // PTS data
                database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        const ptsCount = Object.values(ptsData).filter(pts => {
                            return siswaKelas.some(siswa => siswa.nis === pts.nis);
                        }).length;
                        totalPTS += siswaKelas.length;
                        completedPTS += ptsCount;
                    } else {
                        totalPTS += siswaKelas.length;
                    }

                    // SAS data
                    database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const sasData = snapshot.val();
                            const sasCount = Object.values(sasData).filter(sas => {
                                return siswaKelas.some(siswa => siswa.nis === sas.nis);
                            }).length;
                            totalSAS += siswaKelas.length;
                            completedSAS += sasCount;
                        } else {
                            totalSAS += siswaKelas.length;
                        }

                        // Update progress percentage
                        const totalAssessments = totalPH + totalPTS + totalSAS;
                        const completedAssessments = completedPH + completedPTS + completedSAS;
                        const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;
                        document.getElementById('progressPercentage').textContent = progressPercentage + '%';
                        document.getElementById('totalPenilaian').textContent = completedAssessments;
                    });
                });
            });
        });
    }
}

// Load subject cards for dashboard
function loadSubjectCards() {
    const container = document.getElementById('subjectCards');
    container.innerHTML = '';

    if (mapelData.length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada mata pelajaran tersedia.</div>';
        return;
    }

    mapelData.forEach(mapel => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.onclick = () => openSubjectDashboard(mapel);

        // Calculate progress for this subject
        let progressPH = 0;
        let progressPTS = 0;
        let progressSAS = 0;
        let totalStudents = 0;

        if (userRole === 'admin') {
            totalStudents = siswaData.length;
        } else {
            totalStudents = siswaData.filter(siswa => siswa.kelas === userKelas).length;
        }

        database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                const phData = snapshot.val();
                let completedCount = 0;

                if (userRole === 'admin') {
                    completedCount = Object.keys(phData).length;
                } else {
                    // For teachers, only count students in their class
                    const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                    completedCount = Object.values(phData).filter(ph => {
                        return siswaKelas.some(siswa => siswa.nis === ph.nis);
                    }).length;
                }

                progressPH = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
            }

            database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const ptsData = snapshot.val();
                    let completedCount = 0;

                    if (userRole === 'admin') {
                        completedCount = Object.keys(ptsData).length;
                    } else {
                        // For teachers, only count students in their class
                        const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                        completedCount = Object.values(ptsData).filter(pts => {
                            return siswaKelas.some(siswa => siswa.nis === pts.nis);
                        }).length;
                    }

                    progressPTS = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                }

                database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const sasData = snapshot.val();
                        let completedCount = 0;

                        if (userRole === 'admin') {
                            completedCount = Object.keys(sasData).length;
                        } else {
                            // For teachers, only count students in their class
                            const siswaKelas = siswaData.filter(siswa => siswa.kelas === userKelas);
                            completedCount = Object.values(sasData).filter(sas => {
                                return siswaKelas.some(siswa => siswa.nis === sas.nis);
                            }).length;
                        }

                        progressSAS = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                    }

                    // Calculate overall progress
                    const overallProgress = Math.round((progressPH + progressPTS + progressSAS) / 3);

                    // Create card HTML
                    card.innerHTML = `
                        <div class="subject-header">
                            <div class="subject-title">${mapel.nama}</div>
                            <div class="subject-icon">
                                <i class="fas fa-book"></i>
                            </div>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-header">
                                <div class="progress-title">Penilaian Harian</div>
                                <div class="progress-percentage">${progressPH}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPH}%"></div>
                            </div>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-header">
                                <div class="progress-title">Penilaian PTS</div>
                                <div class="progress-percentage">${progressPTS}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPTS}%"></div>
                            </div>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-header">
                                <div class="progress-title">Penilaian SAS</div>
                                <div class="progress-percentage">${progressSAS}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressSAS}%"></div>
                            </div>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-header">
                                <div class="progress-title">Progress Keseluruhan</div>
                                <div class="progress-percentage">${overallProgress}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${overallProgress}%"></div>
                            </div>
                        </div>
                    `;

                    container.appendChild(card);
                });
            });
        });
    });
}

// Open subject dashboard
function openSubjectDashboard(mapel) {
    // Set active menu item
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });

    // Show PH section by default
    showSection('ph');
    document.getElementById('phMenu').classList.add('active');

    // Set selected subject
    document.getElementById('pilihMapelPH').value = mapel.id;
    tampilkanPH();
}

// Show section
function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });

    // Show selected section
    document.getElementById(sectionId + '-section').style.display = 'block';

    // Update content title
    const titles = {
        'dashboard': 'Dashboard',
        'subjects': 'Manajemen Mata Pelajaran',
        'students': 'Manajemen Data Siswa',
        'ph': 'Penilaian Harian (PH)',
        'assessment': 'Penilaian PTS',
        'sas': 'Penilaian SAS',
        'leger': 'Leger Nilai',
        'combinedLeger': 'Leger Gabungan (PH, PTS, SAS)',
        'pts': 'Cetak PTS',
        'monitoring': 'Monitoring Pengisian Nilai',
        'settings': 'Pengaturan'
    };

    document.querySelector('.content-title').textContent = titles[sectionId] || 'Dashboard';

    // Load data based on section
    if (sectionId === 'subjects') {
        loadMapelData();
    } else if (sectionId === 'students') {
        loadSiswaData();
    } else if (sectionId === 'ph') {
        loadPHData();
    } else if (sectionId === 'assessment') {
        loadPTSData();
    } else if (sectionId === 'sas') {
        loadSASData();
    } else if (sectionId === 'leger') {
        loadLegerData();
    } else if (sectionId === 'combinedLeger') {
        loadCombinedLegerData();
    } else if (sectionId === 'pts') {
        loadPTSReportData();
    } else if (sectionId === 'monitoring') {
        loadMonitoringData();
    }
}

// Load subjects data
function loadMapelData() {
    showLoading();

    database.ref('mapel').once('value')
        .then((snapshot) => {
            hideLoading();

            if (snapshot.exists()) {
                mapelData = [];
                snapshot.forEach((childSnapshot) => {
                    const mapel = childSnapshot.val();
                    mapel.id = childSnapshot.key;
                    mapelData.push(mapel);
                });

                // Update subjects table
                const tableBody = document.getElementById('tabelMapel');
                tableBody.innerHTML = '';

                if (mapelData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                    return;
                }

                mapelData.forEach((mapel, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${mapel.kode}</td>
                        <td>${mapel.nama}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editMapel('${mapel.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hapusMapel('${mapel.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update subject selects
                updateSubjectSelects();
            } else {
                mapelData = [];
                document.getElementById('tabelMapel').innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
                updateSubjectSelects();
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Update subject selects
function updateSubjectSelects() {
    const selects = ['pilihMapelPH', 'pilihMapelPTS', 'pilihMapelSAS'];

    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';

        mapelData.forEach(mapel => {
            const option = document.createElement('option');
            option.value = mapel.id;
            option.textContent = mapel.nama;
            select.appendChild(option);
        });
    });
}

// Add subject
function tambahMapel() {
    document.getElementById('modalMapelTitle').textContent = 'Tambah Mata Pelajaran';
    document.getElementById('mapelId').value = '';
    document.getElementById('mapelKode').value = '';
    document.getElementById('mapelNama').value = '';
    document.getElementById('modalMapel').style.display = 'block';
}

// Edit subject
function editMapel(id) {
    const mapel = mapelData.find(m => m.id === id);
    if (mapel) {
        document.getElementById('modalMapelTitle').textContent = 'Edit Mata Pelajaran';
        document.getElementById('mapelId').value = mapel.id;
        document.getElementById('mapelKode').value = mapel.kode;
        document.getElementById('mapelNama').value = mapel.nama;
        document.getElementById('modalMapel').style.display = 'block';
    }
}

// Save subject
function simpanMapel() {
    const id = document.getElementById('mapelId').value;
    const kode = document.getElementById('mapelKode').value;
    const nama = document.getElementById('mapelNama').value;

    if (!kode || !nama) {
        showAlert('Kode dan nama mata pelajaran tidak boleh kosong!', 'warning');
        return;
    }

    showLoading();

    const mapelData = {
        kode: kode,
        nama: nama
    };

    if (id) {
        // Update existing subject
        database.ref('mapel/' + id).update(mapelData)
            .then(() => {
                hideLoading();
                tutupModal('modalMapel');
                showAlert('Mata pelajaran berhasil diperbarui!', 'success');
                loadMapelData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    } else {
        // Add new subject
        database.ref('mapel').push(mapelData)
            .then(() => {
                hideLoading();
                tutupModal('modalMapel');
                showAlert('Mata pelajaran berhasil ditambahkan!', 'success');
                loadMapelData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Delete subject
function hapusMapel(id) {
    if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
        showLoading();

        database.ref('mapel/' + id).remove()
            .then(() => {
                hideLoading();
                showAlert('Mata pelajaran berhasil dihapus!', 'success');
                loadMapelData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Load students data
function loadSiswaData() {
    showLoading();

    database.ref('siswa').once('value')
        .then((snapshot) => {
            hideLoading();

            if (snapshot.exists()) {
                siswaData = [];
                snapshot.forEach((childSnapshot) => {
                    const siswa = childSnapshot.val();
                    siswa.id = childSnapshot.key;
                    siswaData.push(siswa);
                });

                // Update students table
                updateSiswaTable(siswaData);
            } else {
                siswaData = [];
                updateSiswaTable([]);
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Load students by class
function loadSiswaByKelas(kelas) {
    showLoading();

    database.ref('siswa').orderByChild('kelas').equalTo(kelas).once('value')
        .then((snapshot) => {
            hideLoading();

            if (snapshot.exists()) {
                const filteredSiswa = [];
                snapshot.forEach((childSnapshot) => {
                    const siswa = childSnapshot.val();
                    siswa.id = childSnapshot.key;
                    filteredSiswa.push(siswa);
                });

                // Update students table
                updateSiswaTable(filteredSiswa);
            } else {
                updateSiswaTable([]);
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Update students table
function updateSiswaTable(data) {
    const tableBody = document.getElementById('tabelSiswa');
    tableBody.innerHTML = '';

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data</td></tr>';
        return;
    }

    data.forEach((siswa, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${siswa.nis}</td>
            <td>${siswa.nama}</td>
            <td>${siswa.kelas}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editSiswa('${siswa.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="hapusSiswa('${siswa.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Filter students by class
function filterSiswa() {
    const kelas = document.getElementById('filterKelasSiswa').value;

    if (kelas) {
        const filteredSiswa = siswaData.filter(siswa => siswa.kelas === kelas);
        updateSiswaTable(filteredSiswa);
    } else {
        updateSiswaTable(siswaData);
    }
}

// Add student
function tambahSiswa() {
    document.getElementById('modalSiswaTitle').textContent = 'Tambah Siswa';
    document.getElementById('siswaId').value = '';
    document.getElementById('siswaNIS').value = '';
    document.getElementById('siswaNama').value = '';
    document.getElementById('siswaKelas').value = '';
    document.getElementById('modalSiswa').style.display = 'block';
}

// Edit student
function editSiswa(id) {
    const siswa = siswaData.find(s => s.id === id);
    if (siswa) {
        document.getElementById('modalSiswaTitle').textContent = 'Edit Siswa';
        document.getElementById('siswaId').value = siswa.id;
        document.getElementById('siswaNIS').value = siswa.nis;
        document.getElementById('siswaNama').value = siswa.nama;
        document.getElementById('siswaKelas').value = siswa.kelas;
        document.getElementById('modalSiswa').style.display = 'block';
    }
}

// Save student
function simpanSiswa() {
    const id = document.getElementById('siswaId').value;
    const nis = document.getElementById('siswaNIS').value;
    const nama = document.getElementById('siswaNama').value;
    const kelas = document.getElementById('siswaKelas').value;

    if (!nis || !nama || !kelas) {
        showAlert('NIS, nama, dan kelas tidak boleh kosong!', 'warning');
        return;
    }

    showLoading();

    const siswaData = {
        nis: nis,
        nama: nama,
        kelas: kelas
    };

    if (id) {
        // Update existing student
        database.ref('siswa/' + id).update(siswaData)
            .then(() => {
                hideLoading();
                tutupModal('modalSiswa');
                showAlert('Data siswa berhasil diperbarui!', 'success');
                loadSiswaData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    } else {
        // Add new student
        database.ref('siswa').push(siswaData)
            .then(() => {
                hideLoading();
                tutupModal('modalSiswa');
                showAlert('Data siswa berhasil ditambahkan!', 'success');
                loadSiswaData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Delete student
function hapusSiswa(id) {
    if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
        showLoading();

        database.ref('siswa/' + id).remove()
            .then(() => {
                hideLoading();
                showAlert('Data siswa berhasil dihapus!', 'success');
                loadSiswaData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Download student template
function downloadTemplate() {
    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Kelas'],
        ['12345', 'Contoh Siswa', '1A']
    ];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Data Siswa');

    // Save workbook
    XLSX.writeFile(wb, 'Template_Data_Siswa.xlsx');
}

// Import students from Excel
function importSiswaFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    showLoading();

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Skip header row
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row[0] && row[1] && row[2]) { // NIS, Nama, Kelas
                    const siswaData = {
                        nis: row[0].toString(),
                        nama: row[1].toString(),
                        kelas: row[2].toString()
                    };

                    database.ref('siswa').push(siswaData);
                }
            }

            hideLoading();
            showAlert('Data siswa berhasil diimpor!', 'success');
            loadSiswaData();
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = ''; // Reset file input
}

// Load teachers data
function loadGuruData() {
    showLoading();

    database.ref('guru').once('value')
        .then((snapshot) => {
            hideLoading();

            if (snapshot.exists()) {
                guruData = [];
                snapshot.forEach((childSnapshot) => {
                    const guru = childSnapshot.val();
                    guru.id = childSnapshot.key;
                    guruData.push(guru);
                });

                // Update teachers table
                const tableBody = document.getElementById('tabelGuru');
                tableBody.innerHTML = '';

                if (guruData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
                    return;
                }

                guruData.forEach((guru, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${guru.username}</td>
                        <td>${guru.nama}</td>
                        <td>${guru.kelas}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editGuru('${guru.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hapusGuru('${guru.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                guruData = [];
                document.getElementById('tabelGuru').innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Add teacher
function tambahGuru() {
    document.getElementById('modalGuruTitle').textContent = 'Tambah Guru';
    document.getElementById('guruId').value = '';
    document.getElementById('guruUsername').value = '';
    document.getElementById('guruPassword').value = '';
    document.getElementById('guruNama').value = '';
    document.getElementById('guruKelas').value = '';
    document.getElementById('modalGuru').style.display = 'block';
}

// Edit teacher
function editGuru(id) {
    const guru = guruData.find(g => g.id === id);
    if (guru) {
        document.getElementById('modalGuruTitle').textContent = 'Edit Guru';
        document.getElementById('guruId').value = guru.id;
        document.getElementById('guruUsername').value = guru.username;
        document.getElementById('guruPassword').value = guru.password;
        document.getElementById('guruNama').value = guru.nama;
        document.getElementById('guruKelas').value = guru.kelas;
        document.getElementById('modalGuru').style.display = 'block';
    }
}

// Save teacher
function simpanGuru() {
    const id = document.getElementById('guruId').value;
    const username = document.getElementById('guruUsername').value;
    const password = document.getElementById('guruPassword').value;
    const nama = document.getElementById('guruNama').value;
    const kelas = document.getElementById('guruKelas').value;

    if (!username || !password || !nama || !kelas) {
        showAlert('Semua field harus diisi!', 'warning');
        return;
    }

    showLoading();

    const guruData = {
        username: username,
        password: password,
        nama: nama,
        kelas: kelas
    };

    if (id) {
        // Update existing teacher
        database.ref('guru/' + id).update(guruData)
            .then(() => {
                hideLoading();
                tutupModal('modalGuru');
                showAlert('Data guru berhasil diperbarui!', 'success');
                loadGuruData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    } else {
        // Add new teacher
        database.ref('guru').push(guruData)
            .then(() => {
                hideLoading();
                tutupModal('modalGuru');
                showAlert('Data guru berhasil ditambahkan!', 'success');
                loadGuruData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Delete teacher
function hapusGuru(id) {
    if (confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
        showLoading();

        database.ref('guru/' + id).remove()
            .then(() => {
                hideLoading();
                showAlert('Data guru berhasil dihapus!', 'success');
                loadGuruData();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Load PH data
function loadPHData() {
    const mapelId = document.getElementById('pilihMapelPH').value;
    if (!mapelId) return;

    showLoading();

    database.ref('ph/' + mapelId).once('value')
        .then((snapshot) => {
            hideLoading();

            const container = document.getElementById('PHContainer');
            container.innerHTML = '';

            if (snapshot.exists()) {
                phData[mapelId] = snapshot.val();

                // Create PH list
                const phList = document.createElement('div');
                phList.className = 'ph-list';

                // Group PH by date
                const phByDate = {};
                Object.values(phData[mapelId]).forEach(ph => {
                    if (!phByDate[ph.tanggal]) {
                        phByDate[ph.tanggal] = [];
                    }
                    phByDate[ph.tanggal].push(ph);
                });

                // Create PH items for each date
                Object.keys(phByDate).sort().reverse().forEach(tanggal => {
                    const phItems = phByDate[tanggal];
                    const phItem = document.createElement('div');
                    phItem.className = 'ph-item';

                    const phInfo = document.createElement('div');
                    phInfo.className = 'ph-info';

                    const phDeskripsi = phItems[0].deskripsi;
                    const phDate = new Date(tanggal).toLocaleDateString('id-ID');

                    phInfo.innerHTML = `
                        <div>${phDeskripsi}</div>
                        <div class="ph-date">${phDate}</div>
                    `;

                    const phActions = document.createElement('div');
                    phActions.className = 'ph-actions';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-primary';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editPH(mapelId, tanggal, phDeskripsi);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => hapusPH(mapelId, tanggal);

                    phActions.appendChild(editBtn);
                    phActions.appendChild(deleteBtn);

                    phItem.appendChild(phInfo);
                    phItem.appendChild(phActions);
                    phList.appendChild(phItem);
                });

                container.appendChild(phList);

                // Add button to create new PH
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah Penilaian Harian';
                addBtn.onclick = () => tambahPH(mapelId);
                container.appendChild(addBtn);
            } else {
                phData[mapelId] = {};
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data penilaian harian untuk mata pelajaran ini.</div>';

                // Add button to create new PH
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah Penilaian Harian';
                addBtn.onclick = () => tambahPH(mapelId);
                container.appendChild(addBtn);
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Display PH data
function tampilkanPH() {
    loadPHData();
}

// Add PH
function tambahPH(mapelId) {
    const mapel = mapelData.find(m => m.id === mapelId);
    if (!mapel) return;

    document.getElementById('phMapel').value = mapel.nama;
    document.getElementById('phMapel').dataset.id = mapelId;
    document.getElementById('phTanggal').value = '';
    document.getElementById('phDeskripsi').value = '';

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create table for student grades
    const tableBody = document.getElementById('tabelPH');
    tableBody.innerHTML = '';

    if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
    } else {
        students.forEach(siswa => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${siswa.nis}</td>
                <td>${siswa.nama}</td>
                <td>
                    <input type="number" class="form-control form-control-sm nilai-input" 
                        min="0" max="100" data-nis="${siswa.nis}" 
                        onchange="updatePredikat(this)">
                </td>
                <td>
                    <select class="form-control form-control-sm predikat-select" data-nis="${siswa.nis}" disabled>
                        <option value="">-</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    document.getElementById('modalPH').style.display = 'block';
}

// Edit PH
function editPH(mapelId, tanggal, deskripsi) {
    const mapel = mapelData.find(m => m.id === mapelId);
    if (!mapel) return;

    document.getElementById('phMapel').value = mapel.nama;
    document.getElementById('phMapel').dataset.id = mapelId;
    document.getElementById('phTanggal').value = tanggal;
    document.getElementById('phDeskripsi').value = deskripsi;

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create table for student grades
    const tableBody = document.getElementById('tabelPH');
    tableBody.innerHTML = '';

    if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
    } else {
        students.forEach(siswa => {
            // Check if student has PH data for this date
            const phKey = `${siswa.nis}_${tanggal}`;
            const phData = phData[mapelId] && phData[mapelId][phKey];

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${siswa.nis}</td>
                <td>${siswa.nama}</td>
                <td>
                    <input type="number" class="form-control form-control-sm nilai-input" 
                        min="0" max="100" data-nis="${siswa.nis}" 
                        value="${phData ? phData.nilai : ''}"
                        onchange="updatePredikat(this)">
                </td>
                <td>
                    <select class="form-control form-control-sm predikat-select" data-nis="${siswa.nis}">
                        <option value="">-</option>
                        <option value="A" ${phData && phData.predikat === 'A' ? 'selected' : ''}>A</option>
                        <option value="B" ${phData && phData.predikat === 'B' ? 'selected' : ''}>B</option>
                        <option value="C" ${phData && phData.predikat === 'C' ? 'selected' : ''}>C</option>
                        <option value="D" ${phData && phData.predikat === 'D' ? 'selected' : ''}>D</option>
                    </select>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    document.getElementById('modalPH').style.display = 'block';
}

// Update predikat based on nilai
function updatePredikat(input) {
    const nilai = parseInt(input.value);
    const predikatSelect = document.querySelector(`.predikat-select[data-nis="${input.dataset.nis}"]`);

    if (isNaN(nilai)) {
        predikatSelect.value = '';
        predikatSelect.disabled = true;
    } else {
        predikatSelect.disabled = false;

        if (nilai >= 85) {
            predikatSelect.value = 'A';
        } else if (nilai >= 70) {
            predikatSelect.value = 'B';
        } else if (nilai >= 60) {
            predikatSelect.value = 'C';
        } else {
            predikatSelect.value = 'D';
        }
    }
}

// Save PH
function simpanPH() {
    const mapelId = document.getElementById('phMapel').dataset.id;
    const tanggal = document.getElementById('phTanggal').value;
    const deskripsi = document.getElementById('phDeskripsi').value;

    if (!mapelId || !tanggal || !deskripsi) {
        showAlert('Semua field harus diisi!', 'warning');
        return;
    }

    showLoading();

    // Get all student grades
    const nilaiInputs = document.querySelectorAll('.nilai-input');
    const predikatSelects = document.querySelectorAll('.predikat-select');

    const updates = {};
    let hasData = false;

    nilaiInputs.forEach(input => {
        const nis = input.dataset.nis;
        const nilai = input.value;
        const predikatSelect = document.querySelector(`.predikat-select[data-nis="${nis}"]`);
        const predikat = predikatSelect.value;

        if (nilai) {
            hasData = true;
            const phKey = `${nis}_${tanggal}`;
            updates[phKey] = {
                nis: nis,
                nilai: parseInt(nilai),
                predikat: predikat,
                tanggal: tanggal,
                deskripsi: deskripsi
            };
        }
    });

    if (!hasData) {
        hideLoading();
        showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
        return;
    }

    // Save to database
    database.ref('ph/' + mapelId).update(updates)
        .then(() => {
            hideLoading();
            tutupModal('modalPH');
            showAlert('Penilaian harian berhasil disimpan!', 'success');
            loadPHData();
            updateDashboard();
            loadSubjectCards();
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Delete PH
function hapusPH(mapelId, tanggal) {
    if (confirm('Apakah Anda yakin ingin menghapus penilaian harian ini?')) {
        showLoading();

        // Get all PH keys for this date
        const phKeys = [];
        Object.keys(phData[mapelId]).forEach(key => {
            if (phData[mapelId][key].tanggal === tanggal) {
                phKeys.push(key);
            }
        });

        // Delete all PH data for this date
        const updates = {};
        phKeys.forEach(key => {
            updates[key] = null;
        });

        database.ref('ph/' + mapelId).update(updates)
            .then(() => {
                hideLoading();
                showAlert('Penilaian harian berhasil dihapus!', 'success');
                loadPHData();
                updateDashboard();
                loadSubjectCards();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    }
}

// Download PH template
function downloadTemplatePH() {
    const mapelId = document.getElementById('pilihMapelPH').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Nilai', 'Predikat', 'Tanggal', 'Deskripsi']
    ];

    students.forEach(siswa => {
        wsData.push([siswa.nis, siswa.nama, '', '', '', '']);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Penilaian Harian');

    // Save workbook
    XLSX.writeFile(wb, `Template_PH_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Import PH from Excel
function importPHFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const mapelId = document.getElementById('pilihMapelPH').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    showLoading();

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Skip header row
            const updates = {};
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row[0] && row[2] && row[4]) { // NIS, Nilai, Tanggal
                    const phKey = `${row[0]}_${row[4]}`;
                    updates[phKey] = {
                        nis: row[0].toString(),
                        nilai: parseInt(row[2]),
                        predikat: row[3] ? row[3].toString() : '',
                        tanggal: row[4].toString(),
                        deskripsi: row[5] ? row[5].toString() : ''
                    };
                }
            }

            database.ref('ph/' + mapelId).update(updates)
                .then(() => {
                    hideLoading();
                    showAlert('Data penilaian harian berhasil diimpor!', 'success');
                    loadPHData();
                    updateDashboard();
                    loadSubjectCards();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = ''; // Reset file input
}

// Export PH to Excel
function exportPHToExcel() {
    const mapelId = document.getElementById('pilihMapelPH').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    if (!phData[mapelId] || Object.keys(phData[mapelId]).length === 0) {
        showAlert('Tidak ada data penilaian harian untuk diekspor!', 'warning');
        return;
    }

    showLoading();

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Group PH by date
    const phByDate = {};
    Object.values(phData[mapelId]).forEach(ph => {
        if (!phByDate[ph.tanggal]) {
            phByDate[ph.tanggal] = [];
        }
        phByDate[ph.tanggal].push(ph);
    });

    // Create worksheet for each date
    Object.keys(phByDate).sort().forEach(tanggal => {
        const phItems = phByDate[tanggal];
        const deskripsi = phItems[0].deskripsi;

        // Create worksheet data
        const wsData = [
            ['NIS', 'Nama Siswa', 'Nilai', 'Predikat']
        ];

        phItems.forEach(ph => {
            const siswa = siswaData.find(s => s.nis === ph.nis);
            wsData.push([
                ph.nis,
                siswa ? siswa.nama : '',
                ph.nilai,
                ph.predikat
            ]);
        });

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, `${deskripsi}_${tanggal}`);
    });

    // Save workbook
    hideLoading();
    XLSX.writeFile(wb, `Data_PH_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Load PTS data
function loadPTSData() {
    const mapelId = document.getElementById('pilihMapelPTS').value;
    if (!mapelId) return;

    showLoading();

    database.ref('pts/' + mapelId).once('value')
        .then((snapshot) => {
            hideLoading();

            const container = document.getElementById('PTSContainer');
            container.innerHTML = '';

            if (snapshot.exists()) {
                ptsData[mapelId] = snapshot.val();

                // Create PTS table
                const table = document.createElement('table');
                table.className = 'table';

                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>NIS</th>
                        <th>Nama Siswa</th>
                        <th>Nilai PTS</th>
                        <th>Predikat</th>
                        <th>Aksi</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                // Get students for this class
                let students = [];
                if (userRole === 'admin') {
                    students = siswaData;
                } else {
                    students = siswaData.filter(siswa => siswa.kelas === userKelas);
                }

                students.forEach(siswa => {
                    const pts = Object.values(ptsData[mapelId]).find(p => p.nis === siswa.nis);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>${pts ? pts.nilai : '-'}</td>
                        <td>${pts ? pts.predikat : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editPTS('${mapelId}', '${siswa.nis}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                container.appendChild(table);

                // Add button to create new PTS
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Input Nilai PTS';
                addBtn.onclick = () => tambahPTS(mapelId);
                container.appendChild(addBtn);
            } else {
                ptsData[mapelId] = {};
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data nilai PTS untuk mata pelajaran ini.</div>';

                // Add button to create new PTS
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Input Nilai PTS';
                addBtn.onclick = () => tambahPTS(mapelId);
                container.appendChild(addBtn);
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Display PTS data
function tampilkanPTS() {
    loadPTSData();
}

// Add PTS
function tambahPTS(mapelId) {
    const mapel = mapelData.find(m => m.id === mapelId);
    if (!mapel) return;

    document.getElementById('ptsMapel').value = mapel.nama;
    document.getElementById('ptsMapel').dataset.id = mapelId;

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create table for student grades
    const tableBody = document.getElementById('tabelPTS');
    tableBody.innerHTML = '';

    if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
    } else {
        students.forEach(siswa => {
            // Check if student has PTS data
            const pts = ptsData[mapelId] && Object.values(ptsData[mapelId]).find(p => p.nis === siswa.nis);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${siswa.nis}</td>
                <td>${siswa.nama}</td>
                <td>
                    <input type="number" class="form-control form-control-sm nilai-input" 
                        min="0" max="100" data-nis="${siswa.nis}" 
                        value="${pts ? pts.nilai : ''}"
                        onchange="updatePredikatPTS(this)">
                </td>
                <td>
                    <select class="form-control form-control-sm predikat-select" data-nis="${siswa.nis}">
                        <option value="">-</option>
                        <option value="A" ${pts && pts.predikat === 'A' ? 'selected' : ''}>A</option>
                        <option value="B" ${pts && pts.predikat === 'B' ? 'selected' : ''}>B</option>
                        <option value="C" ${pts && pts.predikat === 'C' ? 'selected' : ''}>C</option>
                        <option value="D" ${pts && pts.predikat === 'D' ? 'selected' : ''}>D</option>
                    </select>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    document.getElementById('modalPTS').style.display = 'block';
}

// Edit PTS
function editPTS(mapelId, nis) {
    tambahPTS(mapelId);
}

// Update predikat based on nilai for PTS
function updatePredikatPTS(input) {
    const nilai = parseInt(input.value);
    const predikatSelect = document.querySelector(`.predikat-select[data-nis="${input.dataset.nis}"]`);

    if (isNaN(nilai)) {
        predikatSelect.value = '';
    } else {
        if (nilai >= 85) {
            predikatSelect.value = 'A';
        } else if (nilai >= 70) {
            predikatSelect.value = 'B';
        } else if (nilai >= 60) {
            predikatSelect.value = 'C';
        } else {
            predikatSelect.value = 'D';
        }
    }
}

// Save PTS
function simpanPTS() {
    const mapelId = document.getElementById('ptsMapel').dataset.id;

    if (!mapelId) {
        showAlert('Terjadi kesalahan, silakan coba lagi!', 'danger');
        return;
    }

    showLoading();

    // Get all student grades
    const nilaiInputs = document.querySelectorAll('#tabelPTS .nilai-input');
    const predikatSelects = document.querySelectorAll('#tabelPTS .predikat-select');

    const updates = {};
    let hasData = false;

    nilaiInputs.forEach(input => {
        const nis = input.dataset.nis;
        const nilai = input.value;
        const predikatSelect = document.querySelector(`#tabelPTS .predikat-select[data-nis="${nis}"]`);
        const predikat = predikatSelect.value;

        if (nilai) {
            hasData = true;
            updates[nis] = {
                nis: nis,
                nilai: parseInt(nilai),
                predikat: predikat
            };
        }
    });

    if (!hasData) {
        hideLoading();
        showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
        return;
    }

    // Save to database
    database.ref('pts/' + mapelId).set(updates)
        .then(() => {
            hideLoading();
            tutupModal('modalPTS');
            showAlert('Nilai PTS berhasil disimpan!', 'success');
            loadPTSData();
            updateDashboard();
            loadSubjectCards();
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Download PTS template
function downloadTemplatePTS() {
    const mapelId = document.getElementById('pilihMapelPTS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Nilai PTS', 'Predikat']
    ];

    students.forEach(siswa => {
        wsData.push([siswa.nis, siswa.nama, '', '']);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Nilai PTS');

    // Save workbook
    XLSX.writeFile(wb, `Template_PTS_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Import PTS from Excel
function importPTSFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const mapelId = document.getElementById('pilihMapelPTS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    showLoading();

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Skip header row
            const updates = {};
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row[0] && row[2]) { // NIS, Nilai
                    updates[row[0]] = {
                        nis: row[0].toString(),
                        nilai: parseInt(row[2]),
                        predikat: row[3] ? row[3].toString() : ''
                    };
                }
            }

            database.ref('pts/' + mapelId).set(updates)
                .then(() => {
                    hideLoading();
                    showAlert('Data nilai PTS berhasil diimpor!', 'success');
                    loadPTSData();
                    updateDashboard();
                    loadSubjectCards();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = ''; // Reset file input
}

// Export PTS to Excel
function exportPTSToExcel() {
    const mapelId = document.getElementById('pilihMapelPTS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    if (!ptsData[mapelId] || Object.keys(ptsData[mapelId]).length === 0) {
        showAlert('Tidak ada data nilai PTS untuk diekspor!', 'warning');
        return;
    }

    showLoading();

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Nilai PTS', 'Predikat']
    ];

    Object.values(ptsData[mapelId]).forEach(pts => {
        const siswa = siswaData.find(s => s.nis === pts.nis);
        wsData.push([
            pts.nis,
            siswa ? siswa.nama : '',
            pts.nilai,
            pts.predikat
        ]);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Nilai PTS');

    // Save workbook
    hideLoading();
    XLSX.writeFile(wb, `Data_PTS_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Load SAS data
function loadSASData() {
    const mapelId = document.getElementById('pilihMapelSAS').value;
    if (!mapelId) return;

    showLoading();

    database.ref('sas/' + mapelId).once('value')
        .then((snapshot) => {
            hideLoading();

            const container = document.getElementById('SASContainer');
            container.innerHTML = '';

            if (snapshot.exists()) {
                sasData[mapelId] = snapshot.val();

                // Create SAS table
                const table = document.createElement('table');
                table.className = 'table';

                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>NIS</th>
                        <th>Nama Siswa</th>
                        <th>Nilai SAS</th>
                        <th>Predikat</th>
                        <th>Aksi</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                // Get students for this class
                let students = [];
                if (userRole === 'admin') {
                    students = siswaData;
                } else {
                    students = siswaData.filter(siswa => siswa.kelas === userKelas);
                }

                students.forEach(siswa => {
                    const sas = Object.values(sasData[mapelId]).find(s => s.nis === siswa.nis);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${siswa.nis}</td>
                        <td>${siswa.nama}</td>
                        <td>${sas ? sas.nilai : '-'}</td>
                        <td>${sas ? sas.predikat : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editSAS('${mapelId}', '${siswa.nis}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                container.appendChild(table);

                // Add button to create new SAS
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Input Nilai SAS';
                addBtn.onclick = () => tambahSAS(mapelId);
                container.appendChild(addBtn);
            } else {
                sasData[mapelId] = {};
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada data nilai SAS untuk mata pelajaran ini.</div>';

                // Add button to create new SAS
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Input Nilai SAS';
                addBtn.onclick = () => tambahSAS(mapelId);
                container.appendChild(addBtn);
            }
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Display SAS data
function tampilkanSAS() {
    loadSASData();
}

// Add SAS
function tambahSAS(mapelId) {
    const mapel = mapelData.find(m => m.id === mapelId);
    if (!mapel) return;

    document.getElementById('sasMapel').value = mapel.nama;
    document.getElementById('sasMapel').dataset.id = mapelId;

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create table for student grades
    const tableBody = document.getElementById('tabelSAS');
    tableBody.innerHTML = '';

    if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data siswa</td></tr>';
    } else {
        students.forEach(siswa => {
            // Check if student has SAS data
            const sas = sasData[mapelId] && Object.values(sasData[mapelId]).find(s => s.nis === siswa.nis);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${siswa.nis}</td>
                <td>${siswa.nama}</td>
                <td>
                    <input type="number" class="form-control form-control-sm nilai-input" 
                        min="0" max="100" data-nis="${siswa.nis}" 
                        value="${sas ? sas.nilai : ''}"
                        onchange="updatePredikatSAS(this)">
                </td>
                <td>
                    <select class="form-control form-control-sm predikat-select" data-nis="${siswa.nis}">
                        <option value="">-</option>
                        <option value="A" ${sas && sas.predikat === 'A' ? 'selected' : ''}>A</option>
                        <option value="B" ${sas && sas.predikat === 'B' ? 'selected' : ''}>B</option>
                        <option value="C" ${sas && sas.predikat === 'C' ? 'selected' : ''}>C</option>
                        <option value="D" ${sas && sas.predikat === 'D' ? 'selected' : ''}>D</option>
                    </select>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    document.getElementById('modalSAS').style.display = 'block';
}

// Edit SAS
function editSAS(mapelId, nis) {
    tambahSAS(mapelId);
}

// Update predikat based on nilai for SAS
function updatePredikatSAS(input) {
    const nilai = parseInt(input.value);
    const predikatSelect = document.querySelector(`.predikat-select[data-nis="${input.dataset.nis}"]`);

    if (isNaN(nilai)) {
        predikatSelect.value = '';
    } else {
        if (nilai >= 85) {
            predikatSelect.value = 'A';
        } else if (nilai >= 70) {
            predikatSelect.value = 'B';
        } else if (nilai >= 60) {
            predikatSelect.value = 'C';
        } else {
            predikatSelect.value = 'D';
        }
    }
}

// Save SAS
function simpanSAS() {
    const mapelId = document.getElementById('sasMapel').dataset.id;

    if (!mapelId) {
        showAlert('Terjadi kesalahan, silakan coba lagi!', 'danger');
        return;
    }

    showLoading();

    // Get all student grades
    const nilaiInputs = document.querySelectorAll('#tabelSAS .nilai-input');
    const predikatSelects = document.querySelectorAll('#tabelSAS .predikat-select');

    const updates = {};
    let hasData = false;

    nilaiInputs.forEach(input => {
        const nis = input.dataset.nis;
        const nilai = input.value;
        const predikatSelect = document.querySelector(`#tabelSAS .predikat-select[data-nis="${nis}"]`);
        const predikat = predikatSelect.value;

        if (nilai) {
            hasData = true;
            updates[nis] = {
                nis: nis,
                nilai: parseInt(nilai),
                predikat: predikat
            };
        }
    });

    if (!hasData) {
        hideLoading();
        showAlert('Minimal satu siswa harus memiliki nilai!', 'warning');
        return;
    }

    // Save to database
    database.ref('sas/' + mapelId).set(updates)
        .then(() => {
            hideLoading();
            tutupModal('modalSAS');
            showAlert('Nilai SAS berhasil disimpan!', 'success');
            loadSASData();
            updateDashboard();
            loadSubjectCards();
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Download SAS template
function downloadTemplateSAS() {
    const mapelId = document.getElementById('pilihMapelSAS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Nilai SAS', 'Predikat']
    ];

    students.forEach(siswa => {
        wsData.push([siswa.nis, siswa.nama, '', '']);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Nilai SAS');

    // Save workbook
    XLSX.writeFile(wb, `Template_SAS_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Import SAS from Excel
function importSASFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const mapelId = document.getElementById('pilihMapelSAS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    showLoading();

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Skip header row
            const updates = {};
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row[0] && row[2]) { // NIS, Nilai
                    updates[row[0]] = {
                        nis: row[0].toString(),
                        nilai: parseInt(row[2]),
                        predikat: row[3] ? row[3].toString() : ''
                    };
                }
            }

            database.ref('sas/' + mapelId).set(updates)
                .then(() => {
                    hideLoading();
                    showAlert('Data nilai SAS berhasil diimpor!', 'success');
                    loadSASData();
                    updateDashboard();
                    loadSubjectCards();
                })
                .catch((error) => {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = ''; // Reset file input
}

// Export SAS to Excel
function exportSASToExcel() {
    const mapelId = document.getElementById('pilihMapelSAS').value;
    if (!mapelId) {
        showAlert('Silakan pilih mata pelajaran terlebih dahulu!', 'warning');
        return;
    }

    if (!sasData[mapelId] || Object.keys(sasData[mapelId]).length === 0) {
        showAlert('Tidak ada data nilai SAS untuk diekspor!', 'warning');
        return;
    }

    showLoading();

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['NIS', 'Nama Siswa', 'Nilai SAS', 'Predikat']
    ];

    Object.values(sasData[mapelId]).forEach(sas => {
        const siswa = siswaData.find(s => s.nis === sas.nis);
        wsData.push([
            sas.nis,
            siswa ? siswa.nama : '',
            sas.nilai,
            sas.predikat
        ]);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Nilai SAS');

    // Save workbook
    hideLoading();
    XLSX.writeFile(wb, `Data_SAS_${mapelData.find(m => m.id === mapelId).nama}.xlsx`);
}

// Load leger data
function loadLegerData() {
    const kelas = document.getElementById('filterKelasLeger').value;
    if (!kelas) return;

    showLoading();

    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        hideLoading();
        document.getElementById('legerContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada data siswa untuk kelas ini.</div>';
        return;
    }

    // Create leger table
    const table = document.createElement('table');
    table.className = 'table leger-table';

    const thead = document.createElement('thead');
    let headerRow = '<tr><th rowspan="2">No</th><th rowspan="2">NIS</th><th rowspan="2">Nama Siswa</th>';

    // Add subject headers
    mapelData.forEach(mapel => {
        headerRow += `<th colspan="3">${mapel.nama}</th>`;
    });

    headerRow += '</tr>';

    // Add assessment type subheaders
    let subHeaderRow = '<tr>';
    mapelData.forEach(() => {
        subHeaderRow += '<th>PH</th><th>PTS</th><th>SAS</th>';
    });
    subHeaderRow += '</tr>';

    thead.innerHTML = headerRow + subHeaderRow;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Add student rows
    students.forEach((siswa, index) => {
        let row = `<tr><td>${index + 1}</td><td>${siswa.nis}</td><td class="student-name">${siswa.nama}</td>`;

        // Add assessment cells for each subject
        mapelData.forEach(mapel => {
            // Get PH data for this student and subject
            const phDataForStudent = phData[mapel.id] && Object.values(phData[mapel.id]).filter(ph => ph.nis === siswa.nis);
            const avgPH = phDataForStudent && phDataForStudent.length > 0 
                ? Math.round(phDataForStudent.reduce((sum, ph) => sum + ph.nilai, 0) / phDataForStudent.length)
                : '-';

            // Get PTS data for this student and subject
            const ptsDataForStudent = ptsData[mapel.id] && ptsData[mapel.id][siswa.nis];
            const nilaiPTS = ptsDataForStudent ? ptsDataForStudent.nilai : '-';

            // Get SAS data for this student and subject
            const sasDataForStudent = sasData[mapel.id] && sasData[mapel.id][siswa.nis];
            const nilaiSAS = sasDataForStudent ? sasDataForStudent.nilai : '-';

            row += `<td>${avgPH}</td><td>${nilaiPTS}</td><td>${nilaiSAS}</td>`;
        });

        row += '</tr>';
        tbody.innerHTML += row;
    });

    table.appendChild(tbody);

    const container = document.getElementById('legerContainer');
    container.innerHTML = '';
    container.appendChild(table);

    // Add input button
    const inputBtn = document.createElement('button');
    inputBtn.className = 'btn btn-primary mt-3';
    inputBtn.innerHTML = '<i class="fas fa-edit"></i> Input Nilai Leger';
    inputBtn.onclick = () => inputLeger(kelas);
    container.appendChild(inputBtn);

    hideLoading();
}

// Display leger data
function tampilkanLeger() {
    loadLegerData();
}

// Input leger data
function inputLeger(kelas) {
    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        showAlert('Tidak ada data siswa untuk kelas ini!', 'warning');
        return;
    }

    // Create leger table headers
    const headerRow = document.getElementById('legerHeader');
    headerRow.innerHTML = '';

    // Add subject headers
    mapelData.forEach(mapel => {
        const th = document.createElement('th');
        th.colSpan = 3;
        th.textContent = mapel.nama;
        headerRow.appendChild(th);
    });

    // Create leger table subheaders
    const subHeaderRow = document.getElementById('legerSubHeader');
    subHeaderRow.innerHTML = '';

    mapelData.forEach(() => {
        subHeaderRow.innerHTML += '<th>PH</th><th>PTS</th><th>SAS</th>';
    });

    // Create student rows
    const tableBody = document.getElementById('tabelLeger');
    tableBody.innerHTML = '';

    students.forEach((siswa, index) => {
        let row = `<tr><td>${index + 1}</td><td>${siswa.nis}</td><td class="student-name">${siswa.nama}</td>`;

        // Add assessment cells for each subject
        mapelData.forEach(mapel => {
            // Get PH data for this student and subject
            const phDataForStudent = phData[mapel.id] && Object.values(phData[mapel.id]).filter(ph => ph.nis === siswa.nis);
            const avgPH = phDataForStudent && phDataForStudent.length > 0 
                ? Math.round(phDataForStudent.reduce((sum, ph) => sum + ph.nilai, 0) / phDataForStudent.length)
                : '';

            // Get PTS data for this student and subject
            const ptsDataForStudent = ptsData[mapel.id] && ptsData[mapel.id][siswa.nis];
            const nilaiPTS = ptsDataForStudent ? ptsDataForStudent.nilai : '';

            // Get SAS data for this student and subject
            const sasDataForStudent = sasData[mapel.id] && sasData[mapel.id][siswa.nis];
            const nilaiSAS = sasDataForStudent ? sasDataForStudent.nilai : '';

            row += `
                <td>
                    <input type="number" class="form-control form-control-sm leger-ph" 
                        min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" 
                        value="${avgPH}" readonly>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm leger-pts" 
                        min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" 
                        value="${nilaiPTS}" readonly>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm leger-sas" 
                        min="0" max="100" data-mapel="${mapel.id}" data-nis="${siswa.nis}" 
                        value="${nilaiSAS}" readonly>
                </td>
            `;
        });

        row += '</tr>';
        tableBody.innerHTML += row;
    });

    document.getElementById('modalLeger').style.display = 'block';
}

// Save leger data
function simpanLeger() {
    showAlert('Data leger tidak perlu disimpan karena sudah otomatis terisi dari data PH, PTS, dan SAS!', 'info');
    tutupModal('modalLeger');
}

// Download leger template
function downloadLegerTemplate() {
    const kelas = document.getElementById('filterKelasLeger').value;
    if (!kelas) {
        showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        showAlert('Tidak ada data siswa untuk kelas ini!', 'warning');
        return;
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['No', 'NIS', 'Nama Siswa']
    ];

    // Add subject headers
    mapelData.forEach(mapel => {
        wsData[0].push(mapel.nama + ' - PH', mapel.nama + ' - PTS', mapel.nama + ' - SAS');
    });

    // Add student rows
    students.forEach((siswa, index) => {
        const row = [index + 1, siswa.nis, siswa.nama];

        // Add empty cells for each subject
        mapelData.forEach(() => {
            row.push('', '', '');
        });

        wsData.push(row);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Leger Nilai');

    // Save workbook
    XLSX.writeFile(wb, `Template_Leger_${kelas}.xlsx`);
}

// Import leger from Excel
function importLegerFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const kelas = document.getElementById('filterKelasLeger').value;
    if (!kelas) {
        showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
        return;
    }

    showLoading();

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Skip header row
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row[1]) { // NIS
                    const nis = row[1].toString();

                    // Process each subject (3 columns per subject)
                    for (let j = 0; j < mapelData.length; j++) {
                        const mapel = mapelData[j];
                        const phIndex = 3 + (j * 3);
                        const ptsIndex = phIndex + 1;
                        const sasIndex = ptsIndex + 1;

                        // Update PH data if exists
                        if (row[phIndex]) {
                            // This is complex because PH data is stored by date
                            // For simplicity, we'll create a new PH entry with today's date
                            const today = new Date().toISOString().split('T')[0];
                            const phKey = `${nis}_${today}`;
                            const phData = {
                                nis: nis,
                                nilai: parseInt(row[phIndex]),
                                predikat: getPredikatFromNilai(parseInt(row[phIndex])),
                                tanggal: today,
                                deskripsi: 'Import dari Excel'
                            };

                            database.ref('ph/' + mapel.id + '/' + phKey).set(phData);
                        }

                        // Update PTS data if exists
                        if (row[ptsIndex]) {
                            const ptsData = {
                                nis: nis,
                                nilai: parseInt(row[ptsIndex]),
                                predikat: getPredikatFromNilai(parseInt(row[ptsIndex]))
                            };

                            database.ref('pts/' + mapel.id + '/' + nis).set(ptsData);
                        }

                        // Update SAS data if exists
                        if (row[sasIndex]) {
                            const sasData = {
                                nis: nis,
                                nilai: parseInt(row[sasIndex]),
                                predikat: getPredikatFromNilai(parseInt(row[sasIndex]))
                            };

                            database.ref('sas/' + mapel.id + '/' + nis).set(sasData);
                        }
                    }
                }
            }

            hideLoading();
            showAlert('Data leger berhasil diimpor!', 'success');
            loadLegerData();
            updateDashboard();
            loadSubjectCards();
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = ''; // Reset file input
}

// Get predikat from nilai
function getPredikatFromNilai(nilai) {
    if (nilai >= 85) return 'A';
    if (nilai >= 70) return 'B';
    if (nilai >= 60) return 'C';
    return 'D';
}

// Export leger to Excel
function exportLegerToExcel() {
    const kelas = document.getElementById('filterKelasLeger').value;
    if (!kelas) {
        showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        showAlert('Tidak ada data siswa untuk kelas ini!', 'warning');
        return;
    }

    showLoading();

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['No', 'NIS', 'Nama Siswa']
    ];

    // Add subject headers
    mapelData.forEach(mapel => {
        wsData[0].push(mapel.nama + ' - PH', mapel.nama + ' - PTS', mapel.nama + ' - SAS');
    });

    // Add student rows
    students.forEach((siswa, index) => {
        const row = [index + 1, siswa.nis, siswa.nama];

        // Add assessment data for each subject
        mapelData.forEach(mapel => {
            // Get PH data for this student and subject
            const phDataForStudent = phData[mapel.id] && Object.values(phData[mapel.id]).filter(ph => ph.nis === siswa.nis);
            const avgPH = phDataForStudent && phDataForStudent.length > 0 
                ? Math.round(phDataForStudent.reduce((sum, ph) => sum + ph.nilai, 0) / phDataForStudent.length)
                : '-';

            // Get PTS data for this student and subject
            const ptsDataForStudent = ptsData[mapel.id] && ptsData[mapel.id][siswa.nis];
            const nilaiPTS = ptsDataForStudent ? ptsDataForStudent.nilai : '-';

            // Get SAS data for this student and subject
            const sasDataForStudent = sasData[mapel.id] && sasData[mapel.id][siswa.nis];
            const nilaiSAS = sasDataForStudent ? sasDataForStudent.nilai : '-';

            row.push(avgPH, nilaiPTS, nilaiSAS);
        });

        wsData.push(row);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Leger Nilai');

    // Save workbook
    hideLoading();
    XLSX.writeFile(wb, `Leger_Nilai_${kelas}.xlsx`);
}

// Load combined leger data
function loadCombinedLegerData() {
    const kelas = document.getElementById('filterKelasCombinedLeger').value;
    if (!kelas) return;

    showLoading();

    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        hideLoading();
        document.getElementById('combinedLegerContainer').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada data siswa untuk kelas ini.</div>';
        return;
    }

    // Create combined leger table
    const table = document.createElement('table');
    table.className = 'combined-leger-table';

    const thead = document.createElement('thead');
    let headerRow = '<tr><th rowspan="2">No</th><th rowspan="2">NIS</th><th rowspan="2">Nama Siswa</th>';

    // Add subject headers
    mapelData.forEach(mapel => {
        headerRow += `<th colspan="4">${mapel.nama}</th>`;
    });

    headerRow += '</tr>';

    // Add assessment type subheaders
    let subHeaderRow = '<tr>';
    mapelData.forEach(() => {
        subHeaderRow += '<th>PH</th><th>PTS</th><th>SAS</th><th>Nilai Akhir</th>';
    });
    subHeaderRow += '</tr>';

    thead.innerHTML = headerRow + subHeaderRow;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Add student rows
    students.forEach((siswa, index) => {
        let row = `<tr><td>${index + 1}</td><td>${siswa.nis}</td><td class="student-name">${siswa.nama}</td>`;

        // Add assessment cells for each subject
        mapelData.forEach(mapel => {
            // Get PH data for this student and subject
            const phDataForStudent = phData[mapel.id] && Object.values(phData[mapel.id]).filter(ph => ph.nis === siswa.nis);
            const avgPH = phDataForStudent && phDataForStudent.length > 0 
                ? Math.round(phDataForStudent.reduce((sum, ph) => sum + ph.nilai, 0) / phDataForStudent.length)
                : 0;

            // Get PTS data for this student and subject
            const ptsDataForStudent = ptsData[mapel.id] && ptsData[mapel.id][siswa.nis];
            const nilaiPTS = ptsDataForStudent ? ptsDataForStudent.nilai : 0;

            // Get SAS data for this student and subject
            const sasDataForStudent = sasData[mapel.id] && sasData[mapel.id][siswa.nis];
            const nilaiSAS = sasDataForStudent ? sasDataForStudent.nilai : 0;

            // Calculate final grade (PH 50%, PTS 20%, SAS 30%)
            const nilaiAkhir = Math.round((avgPH * 0.5) + (nilaiPTS * 0.2) + (nilaiSAS * 0.3));

            row += `<td>${avgPH > 0 ? avgPH : '-'}</td><td>${nilaiPTS > 0 ? nilaiPTS : '-'}</td><td>${nilaiSAS > 0 ? nilaiSAS : '-'}</td><td class="final-grade">${nilaiAkhir > 0 ? nilaiAkhir : '-'}</td>`;
        });

        row += '</tr>';
        tbody.innerHTML += row;
    });

    table.appendChild(tbody);

    const container = document.getElementById('combinedLegerContainer');
    container.innerHTML = '';
    container.appendChild(table);

    hideLoading();
}

// Display combined leger data
function tampilkanCombinedLeger() {
    loadCombinedLegerData();
}

// Export combined leger to Excel
function exportCombinedLegerToExcel() {
    const kelas = document.getElementById('filterKelasCombinedLeger').value;
    if (!kelas) {
        showAlert('Silakan pilih kelas terlebih dahulu!', 'warning');
        return;
    }

    // Get students for this class
    const students = siswaData.filter(siswa => siswa.kelas === kelas);

    if (students.length === 0) {
        showAlert('Tidak ada data siswa untuk kelas ini!', 'warning');
        return;
    }

    showLoading();

    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Create worksheet data
    const wsData = [
        ['No', 'NIS', 'Nama Siswa']
    ];

    // Add subject headers
    mapelData.forEach(mapel => {
        wsData[0].push(mapel.nama + ' - PH', mapel.nama + ' - PTS', mapel.nama + ' - SAS', mapel.nama + ' - Nilai Akhir');
    });

    // Add student rows
    students.forEach((siswa, index) => {
        const row = [index + 1, siswa.nis, siswa.nama];

        // Add assessment data for each subject
        mapelData.forEach(mapel => {
            // Get PH data for this student and subject
            const phDataForStudent = phData[mapel.id] && Object.values(phData[mapel.id]).filter(ph => ph.nis === siswa.nis);
            const avgPH = phDataForStudent && phDataForStudent.length > 0 
                ? Math.round(phDataForStudent.reduce((sum, ph) => sum + ph.nilai, 0) / phDataForStudent.length)
                : '-';

            // Get PTS data for this student and subject
            const ptsDataForStudent = ptsData[mapel.id] && ptsData[mapel.id][siswa.nis];
            const nilaiPTS = ptsDataForStudent ? ptsDataForStudent.nilai : '-';

            // Get SAS data for this student and subject
            const sasDataForStudent = sasData[mapel.id] && sasData[mapel.id][siswa.nis];
            const nilaiSAS = sasDataForStudent ? sasDataForStudent.nilai : '-';

            // Calculate final grade (PH 50%, PTS 20%, SAS 30%)
            let nilaiAkhir = '-';
            if (avgPH !== '-' && nilaiPTS !== '-' && nilaiSAS !== '-') {
                nilaiAkhir = Math.round((avgPH * 0.5) + (nilaiPTS * 0.2) + (nilaiSAS * 0.3));
            }

            row.push(avgPH, nilaiPTS, nilaiSAS, nilaiAkhir);
        });

        wsData.push(row);
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Leger Gabungan');

    // Save workbook
    hideLoading();
    XLSX.writeFile(wb, `Leger_Gabungan_${kelas}.xlsx`);
}

// Load PTS report data
function loadPTSReportData() {
    // Get students for this class
    let students = [];
    if (userRole === 'admin') {
        students = siswaData;
    } else {
        students = siswaData.filter(siswa => siswa.kelas === userKelas);
    }

    // Update student select
    const select = document.getElementById('pilihSiswaPTS');
    select.innerHTML = '<option value="">-- Pilih Siswa --</option>';

    students.forEach(siswa => {
        const option = document.createElement('option');
        option.value = siswa.nis;
        option.textContent = `${siswa.nis} - ${siswa.nama}`;
        select.appendChild(option);
    });
}

// Display PTS report
function tampilkanReportPTS() {
    const nis = document.getElementById('pilihSiswaPTS').value;
    if (!nis) return;

    const siswa = siswaData.find(s => s.nis === nis);
    if (!siswa) return;

    showLoading();

    // Create PTS report
    const reportContainer = document.getElementById('reportPTSContainer');
    reportContainer.innerHTML = '';

    const reportDiv = document.createElement('div');
    reportDiv.className = 'rapor';

    // Create header
    const headerDiv = document.createElement('div');
    headerDiv.className = 'rapor-header';

    if (logoSekolahURL) {
        const logoImg = document.createElement('img');
        logoImg.src = logoSekolahURL;
        logoImg.className = 'rapor-logo';
        logoImg.alt = 'Logo Sekolah';
        headerDiv.appendChild(logoImg);
    }

    const titleDiv = document.createElement('div');
    titleDiv.innerHTML = `
        <div class="rapor-title">LAPORAN PENILAIIAN TENGAH SEMESTER</div>
        <div class="rapor-subtitle">SDIT SALSABILA KLASEMAN</div>
    `;
    headerDiv.appendChild(titleDiv);
    reportDiv.appendChild(headerDiv);

    // Create student info
    const infoDiv = document.createElement('div');
    infoDiv.className = 'rapor-info';
    infoDiv.innerHTML = `
        <p><strong>Nama Siswa:</strong> ${siswa.nama}</p>
        <p><strong>NIS:</strong> ${siswa.nis}</p>
        <p><strong>Kelas:</strong> ${siswa.kelas}</p>
        <p><strong>Semester:</strong> Ganjil</p>
        <p><strong>Tahun Pelajaran:</strong> 2023/2024</p>
    `;
    reportDiv.appendChild(infoDiv);

    // Create assessment table
    const tableDiv = document.createElement('div');
    tableDiv.className = 'rapor-section';

    const sectionTitle = document.createElement('div');
    sectionTitle.className = 'rapor-section-title';
    sectionTitle.textContent = 'Nilai Penilaian Tengah Semester';
    tableDiv.appendChild(sectionTitle);

    const table = document.createElement('table');
    table.className = 'rapor-table';

    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>No</th>
            <th>Mata Pelajaran</th>
            <th>Nilai PTS</th>
            <th>Predikat</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    let no = 1;

    mapelData.forEach(mapel => {
        const pts = ptsData[mapel.id] && ptsData[mapel.id][nis];
        if (pts) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${no++}</td>
                <td>${mapel.nama}</td>
                <td>${pts.nilai}</td>
                <td>${pts.predikat}</td>
            `;
            tbody.appendChild(row);
        }
    });

    if (no === 1) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada data nilai PTS</td></tr>';
    }

    table.appendChild(tbody);
    tableDiv.appendChild(table);
    reportDiv.appendChild(tableDiv);

    // Create signature
    const signatureDiv = document.createElement('div');
    signatureDiv.className = 'rapor-signature';
    signatureDiv.innerHTML = `
        <div class="rapor-signature-box">
            <p>Mengetahui,</p>
            <p>Kepala Sekolah</p>
            <div class="rapor-signature-line"></div>
            <p>NIP. 123456789</p>
        </div>
        <div class="rapor-signature-box">
            <p>${siswa.kelas}, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
            <p>Wali Kelas</p>
            <div class="rapor-signature-line"></div>
            <p>NIP. 987654321</p>
        </div>
    `;
    reportDiv.appendChild(signatureDiv);

    reportContainer.appendChild(reportDiv);
    hideLoading();
}

// Load monitoring data
function loadMonitoringData() {
    showLoading();

    // Load teachers data if not already loaded
    if (guruData.length === 0) {
        database.ref('guru').once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    guruData = [];
                    snapshot.forEach((childSnapshot) => {
                        const guru = childSnapshot.val();
                        guru.id = childSnapshot.key;
                        guruData.push(guru);
                    });
                }
                loadMonitoringProgress();
            })
            .catch((error) => {
                hideLoading();
                showAlert('Error: ' + error.message, 'danger');
            });
    } else {
        loadMonitoringProgress();
    }
}

// Load monitoring progress
function loadMonitoringProgress() {
    // Get students for each teacher's class
    const progressList = document.getElementById('progressList');
    progressList.innerHTML = '';

    // Create chart data
    const chartData = {
        labels: [],
        datasets: [{
            label: 'Progress Pengisian Nilai (%)',
            data: [],
            backgroundColor: 'rgba(78, 115, 223, 0.2)',
            borderColor: 'rgba(78, 115, 223, 1)',
            borderWidth: 1
        }]
    };

    // Calculate progress for each teacher
    guruData.forEach(guru => {
        const studentsInClass = siswaData.filter(siswa => siswa.kelas === guru.kelas);
        const totalStudents = studentsInClass.length;
        let totalAssessments = 0;
        let completedAssessments = 0;

        mapelData.forEach(mapel => {
            // PH data
            database.ref('ph/' + mapel.id).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const phData = snapshot.val();
                    const phCount = Object.values(phData).filter(ph => {
                        return studentsInClass.some(siswa => siswa.nis === ph.nis);
                    }).length;
                    totalAssessments += totalStudents;
                    completedAssessments += phCount;
                } else {
                    totalAssessments += totalStudents;
                }

                // PTS data
                database.ref('pts/' + mapel.id).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const ptsData = snapshot.val();
                        const ptsCount = Object.values(ptsData).filter(pts => {
                            return studentsInClass.some(siswa => siswa.nis === pts.nis);
                        }).length;
                        totalAssessments += totalStudents;
                        completedAssessments += ptsCount;
                    } else {
                        totalAssessments += totalStudents;
                    }

                    // SAS data
                    database.ref('sas/' + mapel.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const sasData = snapshot.val();
                            const sasCount = Object.values(sasData).filter(sas => {
                                return studentsInClass.some(siswa => siswa.nis === sas.nis);
                            }).length;
                            totalAssessments += totalStudents;
                            completedAssessments += sasCount;
                        } else {
                            totalAssessments += totalStudents;
                        }

                        // Calculate progress percentage
                        const progressPercentage = totalAssessments > 0 ? Math.round((completedAssessments / totalAssessments) * 100) : 0;

                        // Add to chart data
                        chartData.labels.push(guru.nama + ' (' + guru.kelas + ')');
                        chartData.datasets[0].data.push(progressPercentage);

                        // Add to progress list
                        const progressItem = document.createElement('div');
                        progressItem.className = 'progress-item';
                        progressItem.innerHTML = `
                            <div class="progress-header">
                                <div class="progress-title">${guru.nama} (${guru.kelas})</div>
                                <div class="progress-percentage">${progressPercentage}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                        `;
                        progressList.appendChild(progressItem);

                        // Create chart if all data is loaded
                        if (progressList.children.length === guruData.length) {
                            createMonitoringChart(chartData);
                            hideLoading();
                        }
                    });
                });
            });
        });
    });
}

// Create monitoring chart
function createMonitoringChart(chartData) {
    const ctx = document.getElementById('monitoringChart').getContext('2d');

    // Destroy existing chart if it exists
    if (monitoringChart) {
        monitoringChart.destroy();
    }

    monitoringChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Progress Pengisian Nilai per Guru'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.raw + '%';
                        }
                    }
                }
            }
        }
    });
}

// Load school logo
function loadLogoSekolah() {
    showLoading();

    storage.ref('logo-sekolah/logo.jpg').getDownloadURL()
        .then((url) => {
            logoSekolahURL = url;
            document.getElementById('logoSekolah').src = url;
            document.getElementById('logoSekolah').style.display = 'block';
            hideLoading();
        })
        .catch((error) => {
            // Logo doesn't exist or error occurred
            hideLoading();
        });
}

// Upload school logo
function uploadLogoSekolah(event) {
    const file = event.target.files[0];
    if (!file) return;

    showLoading();

    // Create a storage reference
    const storageRef = storage.ref('logo-sekolah/logo.jpg');

    // Upload file
    storageRef.put(file)
        .then(() => {
            // Get download URL
            return storageRef.getDownloadURL();
        })
        .then((url) => {
            logoSekolahURL = url;
            document.getElementById('logoSekolah').src = url;
            document.getElementById('logoSekolah').style.display = 'block';
            hideLoading();
            showAlert('Logo sekolah berhasil diupload!', 'success');
        })
        .catch((error) => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Close modal
function tutupModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Logout
function logout() {
    if (confirm('Apakah Anda yakin ingin logout?')) {
        currentUser = null;
        userRole = null;
        userKelas = null;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('kelas').value = '';
    }
}

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is already logged in
    if (currentUser) {
        showMainApp();
        if (userRole === 'admin') {
            loadAdminData();
        } else {
            loadTeacherData();
        }
    }
});
</script>
</body>
</html>
